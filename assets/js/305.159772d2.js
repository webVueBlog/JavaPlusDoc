(window.webpackJsonp=window.webpackJsonp||[]).push([[305],{1121:function(t,a,s){"use strict";s.r(a);var n=s(1),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"docker生产环境部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker生产环境部署"}},[t._v("#")]),t._v(" Docker生产环境部署")]),t._v(" "),a("h2",{attrs:{id:"生产环境规划"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生产环境规划"}},[t._v("#")]),t._v(" 生产环境规划")]),t._v(" "),a("h3",{attrs:{id:"基础设施规划"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基础设施规划"}},[t._v("#")]),t._v(" 基础设施规划")]),t._v(" "),a("p",[t._v("在将Docker部署到生产环境之前，需要进行全面的基础设施规划，确保系统的可靠性、可扩展性和安全性。")]),t._v(" "),a("h4",{attrs:{id:"硬件需求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#硬件需求"}},[t._v("#")]),t._v(" 硬件需求")]),t._v(" "),a("p",[t._v("根据工作负载类型和规模，合理规划硬件资源：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("资源类型")]),t._v(" "),a("th",[t._v("最低配置")]),t._v(" "),a("th",[t._v("推荐配置")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("CPU")]),t._v(" "),a("td",[t._v("2核")]),t._v(" "),a("td",[t._v("4-8核")]),t._v(" "),a("td",[t._v("容器编排系统需要额外的CPU资源")])]),t._v(" "),a("tr",[a("td",[t._v("内存")]),t._v(" "),a("td",[t._v("4GB")]),t._v(" "),a("td",[t._v("16-32GB")]),t._v(" "),a("td",[t._v("预留30%给操作系统和Docker守护进程")])]),t._v(" "),a("tr",[a("td",[t._v("磁盘")]),t._v(" "),a("td",[t._v("20GB")]),t._v(" "),a("td",[t._v("100GB+")]),t._v(" "),a("td",[t._v("使用SSD提高I/O性能，考虑单独的数据卷")])]),t._v(" "),a("tr",[a("td",[t._v("网络")]),t._v(" "),a("td",[t._v("1Gbps")]),t._v(" "),a("td",[t._v("10Gbps")]),t._v(" "),a("td",[t._v("集群内部通信和容器镜像传输需要足够带宽")])])])]),t._v(" "),a("h4",{attrs:{id:"操作系统选择"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#操作系统选择"}},[t._v("#")]),t._v(" 操作系统选择")]),t._v(" "),a("p",[t._v("选择适合Docker的操作系统：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 检查Linux内核版本（需要3.10或更高）")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uname")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 推荐的操作系统发行版：")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - Ubuntu Server 20.04/22.04 LTS")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - CentOS 8/Stream")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - Debian 11/12")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - RHEL 8/9")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - Amazon Linux 2")]),t._v("\n")])])]),a("h4",{attrs:{id:"存储规划"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存储规划"}},[t._v("#")]),t._v(" 存储规划")]),t._v(" "),a("p",[t._v("为不同的Docker组件选择合适的存储驱动和位置：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 检查当前存储驱动")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" info "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Storage Driver"')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 推荐的存储驱动：")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - overlay2（首选）")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - devicemapper（配置direct-lvm模式）")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - zfs")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置存储驱动和数据目录")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/docker/daemon.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\n{\n  "storage-driver": "overlay2",\n  "data-root": "/mnt/docker-data"\n}\nEOF')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启Docker服务")]),t._v("\nsystemctl restart "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v("\n")])])]),a("h4",{attrs:{id:"网络规划"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络规划"}},[t._v("#")]),t._v(" 网络规划")]),t._v(" "),a("p",[t._v("规划Docker网络架构：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建自定义网络")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" network create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--driver")]),t._v(" overlay "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--subnet")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.10")]),t._v(".0.0/16 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--gateway")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.10")]),t._v(".0.1 prod-network\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 为不同应用创建隔离网络")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" network create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--driver")]),t._v(" overlay "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--subnet")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.20")]),t._v(".0.0/16 frontend-network\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" network create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--driver")]),t._v(" overlay "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--subnet")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.30")]),t._v(".0.0/16 backend-network\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" network create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--driver")]),t._v(" overlay "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--subnet")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.40")]),t._v(".0.0/16 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--internal")]),t._v(" db-network\n")])])]),a("h3",{attrs:{id:"容器编排选择"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#容器编排选择"}},[t._v("#")]),t._v(" 容器编排选择")]),t._v(" "),a("p",[t._v("根据项目规模和需求选择合适的容器编排系统：")]),t._v(" "),a("h4",{attrs:{id:"docker-swarm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-swarm"}},[t._v("#")]),t._v(" Docker Swarm")]),t._v(" "),a("p",[t._v("适合中小型部署，与Docker紧密集成，易于设置和管理。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 初始化Swarm集群")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" swarm init --advertise-addr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("MANAGER-IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加工作节点")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在管理节点上获取加入命令")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" swarm join-token worker\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在工作节点上执行加入命令")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" swarm "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--token")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("TOKEN"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("MANAGER-IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":2377\n")])])]),a("h4",{attrs:{id:"kubernetes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes"}},[t._v("#")]),t._v(" Kubernetes")]),t._v(" "),a("p",[t._v("适合大型复杂部署，功能丰富，生态系统完善，但学习曲线较陡。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用kubeadm安装Kubernetes")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 安装kubeadm、kubelet和kubectl")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" apt-transport-https "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" https://packages.cloud.google.com/apt/doc/apt-key.gpg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" apt-key "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" -\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tee")]),t._v(" /etc/apt/sources.list.d/kubernetes.list")]),t._v("\ndeb https://apt.kubernetes.io/ kubernetes-xenial main\nEOF")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" kubelet kubeadm kubectl\napt-mark hold kubelet kubeadm kubectl\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 初始化控制平面")]),t._v("\nkubeadm init --pod-network-cidr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.0/16\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 设置kubectl配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-i")]),t._v(" /etc/kubernetes/admin.conf "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chown")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-u")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-g")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. 安装网络插件（例如Calico）")]),t._v("\nkubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" https://docs.projectcalico.org/manifests/calico.yaml\n")])])]),a("h4",{attrs:{id:"docker-compose"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose"}},[t._v("#")]),t._v(" Docker Compose")]),t._v(" "),a("p",[t._v("适合单主机部署或开发环境，简单易用。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装Docker Compose")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-L")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://github.com/docker/compose/releases/download/v2.20.3/docker-compose-'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uname")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("-"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uname")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-m")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v('"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-o")]),t._v(" /usr/local/bin/docker-compose\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x /usr/local/bin/docker-compose\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建生产环境配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" docker-compose.yml docker-compose.prod.yml\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用生产配置启动服务")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker-compose")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" docker-compose.yml "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" docker-compose.prod.yml up "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v("\n")])])]),a("h2",{attrs:{id:"镜像管理策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#镜像管理策略"}},[t._v("#")]),t._v(" 镜像管理策略")]),t._v(" "),a("h3",{attrs:{id:"私有镜像仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#私有镜像仓库"}},[t._v("#")]),t._v(" 私有镜像仓库")]),t._v(" "),a("p",[t._v("在生产环境中，建议使用私有镜像仓库来存储和管理容器镜像。")]),t._v(" "),a("h4",{attrs:{id:"部署docker-registry"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署docker-registry"}},[t._v("#")]),t._v(" 部署Docker Registry")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用TLS和认证部署私有仓库")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 创建自签名证书")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" certs\nopenssl req "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-newkey")]),t._v(" rsa:4096 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-nodes")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-sha256")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-keyout")]),t._v(" certs/domain.key "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-x509")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-days")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("365")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-out")]),t._v(" certs/domain.crt\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 创建认证文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" auth\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--rm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--entrypoint")]),t._v(" htpasswd httpd:2 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-Bbn")]),t._v(" admin secure_password "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" auth/htpasswd\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 启动私有仓库")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" registry "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("always "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v(":5000 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("pwd")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v('"')]),t._v("/certs:/certs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("pwd")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v('"')]),t._v("/auth:/auth "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("REGISTRY_HTTP_TLS_CERTIFICATE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/certs/domain.crt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("REGISTRY_HTTP_TLS_KEY")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/certs/domain.key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("REGISTRY_AUTH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("htpasswd "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("REGISTRY_AUTH_HTPASSWD_REALM")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Registry Realm"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("REGISTRY_AUTH_HTPASSWD_PATH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/auth/htpasswd "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  registry:2\n")])])]),a("h4",{attrs:{id:"使用harbor作为企业级镜像仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用harbor作为企业级镜像仓库"}},[t._v("#")]),t._v(" 使用Harbor作为企业级镜像仓库")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 下载Harbor安装包")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://github.com/goharbor/harbor/releases/download/v2.7.0/harbor-offline-installer-v2.7.0.tgz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" xzvf harbor-offline-installer-v2.7.0.tgz\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" harbor\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 配置Harbor")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" harbor.yml.tmpl harbor.yml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 编辑harbor.yml配置文件")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 安装Harbor")]),t._v("\n./install.sh --with-clair --with-trivy\n")])])]),a("h3",{attrs:{id:"镜像标签策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#镜像标签策略"}},[t._v("#")]),t._v(" 镜像标签策略")]),t._v(" "),a("p",[t._v("制定清晰的镜像标签策略，确保镜像的可追溯性和版本管理。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 推荐的标签策略：")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 使用语义化版本")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" build "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v(" myregistry.example.com/myapp:1.2.3 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 使用Git提交哈希")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" build "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v(" myregistry.example.com/myapp:"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" rev-parse "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--short")]),t._v(" HEAD"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 使用构建时间戳")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" build "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v(" myregistry.example.com/myapp:"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("date")]),t._v(" +%Y%m%d%H%M%S"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. 使用环境标签")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" build "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v(" myregistry.example.com/myapp:1.2.3-production "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" build "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v(" myregistry.example.com/myapp:1.2.3-staging "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 5. 推送镜像到私有仓库")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" push myregistry.example.com/myapp:1.2.3\n")])])]),a("h3",{attrs:{id:"镜像安全扫描"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#镜像安全扫描"}},[t._v("#")]),t._v(" 镜像安全扫描")]),t._v(" "),a("p",[t._v("在生产环境中部署前，对镜像进行安全扫描，确保没有已知漏洞。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用Trivy扫描镜像")]),t._v("\ntrivy image myregistry.example.com/myapp:1.2.3\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在CI/CD流程中集成镜像扫描")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" .gitlab-ci.yml "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\nstages:\n  - build\n  - scan\n  - deploy\n\nbuild:\n  stage: build\n  script:\n    - docker build -t myregistry.example.com/myapp:"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${CI_COMMIT_SHA}")]),t._v(" .\n\nscan:\n  stage: scan\n  script:\n    - trivy image --exit-code 1 --severity HIGH,CRITICAL myregistry.example.com/myapp:"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${CI_COMMIT_SHA}")]),t._v("\n\ndeploy:\n  stage: deploy\n  script:\n    - docker push myregistry.example.com/myapp:"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${CI_COMMIT_SHA}")]),t._v("\n    - docker service update --image myregistry.example.com/myapp:"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${CI_COMMIT_SHA}")]),t._v(" my_service\n  only:\n    - master\nEOF")]),t._v("\n")])])]),a("h2",{attrs:{id:"部署策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署策略"}},[t._v("#")]),t._v(" 部署策略")]),t._v(" "),a("h3",{attrs:{id:"蓝绿部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#蓝绿部署"}},[t._v("#")]),t._v(" 蓝绿部署")]),t._v(" "),a("p",[t._v("蓝绿部署通过同时维护两个生产环境（蓝色和绿色），实现零停机部署。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.blue.yml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.8'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myregistry.example.com/myapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1.2.3\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DEPLOYMENT=blue\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" frontend\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" backend\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.green.yml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.8'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myregistry.example.com/myapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1.3.0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DEPLOYMENT=green\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" frontend\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" backend\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 部署蓝色环境")]),t._v("\ndocker stack deploy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("c docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("compose.blue.yml myapp\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 部署绿色环境并切换流量")]),t._v("\ndocker service scale myapp_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("green=3\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 更新负载均衡器配置指向绿色环境")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 确认绿色环境正常后，缩减蓝色环境")]),t._v("\ndocker service scale myapp_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("blue=0\n")])])]),a("h3",{attrs:{id:"金丝雀部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#金丝雀部署"}},[t._v("#")]),t._v(" 金丝雀部署")]),t._v(" "),a("p",[t._v("金丝雀部署通过逐步将流量从旧版本转移到新版本，降低风险。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用Docker Swarm进行金丝雀部署")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 部署当前版本")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--replicas")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.2.3\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 更新服务，使用金丝雀策略")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" update "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--image")]),t._v(" myregistry.example.com/myapp:1.3.0 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --update-parallelism "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --update-delay 1m "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myapp\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 监控更新过程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" myapp\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. 如果发现问题，回滚更新")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" update "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--rollback")]),t._v(" myapp\n")])])]),a("h3",{attrs:{id:"滚动更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#滚动更新"}},[t._v("#")]),t._v(" 滚动更新")]),t._v(" "),a("p",[t._v("滚动更新是最常用的部署策略，逐步替换旧版本的实例。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.yml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.8'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myregistry.example.com/myapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1.3.0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("update_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("parallelism")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("delay")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 30s\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("order")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("first\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("failure_action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rollback\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("monitor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 60s\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rollback_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("parallelism")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("delay")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10s\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("order")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" stop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("first\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 部署服务")]),t._v("\ndocker stack deploy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("c docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("compose.yml myapp\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 更新服务镜像")]),t._v("\ndocker service update "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("image myregistry.example.com/myapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1.3.1 myapp_app\n")])])]),a("h2",{attrs:{id:"高可用性配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高可用性配置"}},[t._v("#")]),t._v(" 高可用性配置")]),t._v(" "),a("h3",{attrs:{id:"docker-swarm高可用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-swarm高可用"}},[t._v("#")]),t._v(" Docker Swarm高可用")]),t._v(" "),a("p",[t._v("配置Docker Swarm集群以实现高可用性。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 初始化第一个管理节点")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" swarm init --advertise-addr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("MANAGER1-IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 获取管理节点加入令牌")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" swarm join-token manager\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 在其他管理节点上执行加入命令")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在Manager2上")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" swarm "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--token")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("MANAGER-TOKEN"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("MANAGER1-IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":2377\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在Manager3上")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" swarm "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--token")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("MANAGER-TOKEN"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("MANAGER1-IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":2377\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. 获取工作节点加入令牌")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" swarm join-token worker\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 5. 在工作节点上执行加入命令")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" swarm "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--token")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("WORKER-TOKEN"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("MANAGER1-IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":2377\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 6. 查看集群状态")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v("\n")])])]),a("h3",{attrs:{id:"服务高可用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务高可用"}},[t._v("#")]),t._v(" 服务高可用")]),t._v(" "),a("p",[t._v("配置服务以实现高可用性。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 创建具有多个副本的服务")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--replicas")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--publish")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":80 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.3.0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 配置服务约束和偏好，确保副本分布在不同节点")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" update "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --constraint-add "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node.labels.zone==east"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --constraint-add "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node.role==worker"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --placement-pref-add "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"spread=node.labels.rack"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myapp\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 配置健康检查")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" update "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --health-cmd "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"curl -f http://localhost/health || exit 1"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --health-interval 5s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --health-retries "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --health-timeout 2s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --health-start-period 10s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myapp\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. 配置重启策略")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" update "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --restart-condition any "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --restart-delay 5s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --restart-max-attempts "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --restart-window 120s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myapp\n")])])]),a("h3",{attrs:{id:"数据持久化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据持久化"}},[t._v("#")]),t._v(" 数据持久化")]),t._v(" "),a("p",[t._v("确保数据的持久化和高可用性。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 创建命名卷")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" volume create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--driver")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("local")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--opt")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nfs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--opt")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("o")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("addr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.1,rw "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--opt")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("device")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(":/path/to/nfs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myapp-data\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 使用卷创建服务")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" db "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--mount")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("volume,source"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("myapp-data,target"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/var/lib/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--replicas")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  mysql:5.7\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 配置数据备份")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" backup.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'EOF'\n#!/bin/bash\nDATETIME=$(date +%Y%m%d_%H%M%S)\nBACKUP_DIR=/backup\n\ndocker run --rm \\\n  -v myapp-data:/data \\\n  -v $BACKUP_DIR:/backup \\\n  alpine \\\n  tar -czf /backup/myapp-data-$DATETIME.tar.gz -C /data .\nEOF")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x backup.sh\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. 设置定时备份")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0 2 * * * /path/to/backup.sh"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("crontab")]),t._v(" -\n")])])]),a("h2",{attrs:{id:"监控和日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#监控和日志"}},[t._v("#")]),t._v(" 监控和日志")]),t._v(" "),a("h3",{attrs:{id:"监控系统"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#监控系统"}},[t._v("#")]),t._v(" 监控系统")]),t._v(" "),a("p",[t._v("部署监控系统，实时监控Docker容器和主机的状态。")]),t._v(" "),a("h4",{attrs:{id:"prometheus和grafana"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prometheus和grafana"}},[t._v("#")]),t._v(" Prometheus和Grafana")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.monitoring.yml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.8'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("prometheus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" prom/prometheus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./prometheus.yml"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/prometheus/prometheus.yml\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" prometheus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/prometheus\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--config.file=/etc/prometheus/prometheus.yml'")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--storage.tsdb.path=/prometheus'")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--web.console.libraries=/etc/prometheus/console_libraries'")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--web.console.templates=/etc/prometheus/consoles'")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--web.enable-lifecycle'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9090:9090"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("placement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("constraints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node.role == manager\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("node-exporter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" prom/node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("exporter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /proc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/host/proc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ro\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/host/sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ro\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/rootfs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ro\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--path.procfs=/host/proc'")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--path.sysfs=/host/sys'")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9100:9100"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" global\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cadvisor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gcr.io/cadvisor/cadvisor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/rootfs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ro\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("rw\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ro\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/lib/docker/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/lib/docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ro\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8080:8080"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" global\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("grafana")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" grafana/grafana"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" grafana"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/lib/grafana\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GF_SECURITY_ADMIN_PASSWORD=secure_password\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GF_USERS_ALLOW_SIGN_UP=false\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3000:3000"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("placement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("constraints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node.role == manager\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("prometheus-data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("grafana-data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n")])])]),a("h4",{attrs:{id:"配置prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置prometheus"}},[t._v("#")]),t._v(" 配置Prometheus")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# prometheus.yml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("global")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrape_interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 15s\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("evaluation_interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 15s\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("alerting")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("alertmanagers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("static_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - alertmanager:9093")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule_files")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# - "first_rules.yml"')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrape_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'prometheus'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("static_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost:9090'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node-exporter'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dns_sd_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("names")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tasks.node-exporter'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9100")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cadvisor'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dns_sd_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("names")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tasks.cadvisor'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'docker'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("static_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'host.docker.internal:9323'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("h3",{attrs:{id:"日志管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志管理"}},[t._v("#")]),t._v(" 日志管理")]),t._v(" "),a("p",[t._v("配置集中式日志管理系统，收集和分析容器日志。")]),t._v(" "),a("h4",{attrs:{id:"elk-stack"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elk-stack"}},[t._v("#")]),t._v(" ELK Stack")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.logging.yml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.8'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("elasticsearch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.elastic.co/elasticsearch/elasticsearch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.17.0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" discovery.type=single"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("node\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" bootstrap.memory_lock=true\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ES_JAVA_OPTS=-Xms512m -Xmx512m"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ulimits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("soft")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("-1")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hard")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("-1")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" elasticsearch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/usr/share/elasticsearch/data\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9200:9200"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1g\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("logstash")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.elastic.co/logstash/logstash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.17.0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./logstash.conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/usr/share/logstash/pipeline/logstash.conf\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"5000:5000"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"5000:5000/udp"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9600:9600"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("depends_on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" elasticsearch\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kibana")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.elastic.co/kibana/kibana"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.17.0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ELASTICSEARCH_HOSTS=http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//elasticsearch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9200")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"5601:5601"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("depends_on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" elasticsearch\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("elasticsearch-data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n")])])]),a("h4",{attrs:{id:"配置logstash"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置logstash"}},[t._v("#")]),t._v(" 配置Logstash")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('# logstash.conf\ninput {\n  gelf {\n    port => 5000\n  }\n}\n\nfilter {\n  if [docker][image] =~ /^myregistry\\.example\\.com\\/myapp/ {\n    mutate {\n      add_field => { "application" => "myapp" }\n    }\n  }\n}\n\noutput {\n  elasticsearch {\n    hosts => ["elasticsearch:9200"]\n    index => "logstash-%{+YYYY.MM.dd}"\n  }\n}\n')])])]),a("h4",{attrs:{id:"配置docker日志驱动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置docker日志驱动"}},[t._v("#")]),t._v(" 配置Docker日志驱动")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在/etc/docker/daemon.json中配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/docker/daemon.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\n{\n  "log-driver": "gelf",\n  "log-opts": {\n    "gelf-address": "udp://localhost:5000",\n    "tag": "{{.Name}}/{{.ID}}"\n  }\n}\nEOF')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启Docker服务")]),t._v("\nsystemctl restart "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 或者为特定容器配置日志驱动")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --log-driver gelf "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --log-opt gelf-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("udp://logstash:5000 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --log-opt "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"myapp/{{.Name}}/{{.ID}}"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.3.0\n")])])]),a("h2",{attrs:{id:"性能优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#性能优化"}},[t._v("#")]),t._v(" 性能优化")]),t._v(" "),a("h3",{attrs:{id:"容器性能优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#容器性能优化"}},[t._v("#")]),t._v(" 容器性能优化")]),t._v(" "),a("p",[t._v("优化容器配置以提高性能。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 限制容器资源")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --limit-cpu "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.5")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --limit-memory 512M "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --reserve-cpu "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --reserve-memory 128M "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.3.0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 优化容器网络")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --network-add "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("fast-network,alias"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--dns")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --dns-option ndots:2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --dns-search example.com "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.3.0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 优化存储性能")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--mount")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("volume,source"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("fast-data,target"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/data,volume-driver"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("local,volume-opt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("tmpfs,volume-opt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("device"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("tmpfs,volume-opt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("o"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("size"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("100m "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.3.0\n")])])]),a("h3",{attrs:{id:"docker守护进程优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker守护进程优化"}},[t._v("#")]),t._v(" Docker守护进程优化")]),t._v(" "),a("p",[t._v("优化Docker守护进程配置以提高性能。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在/etc/docker/daemon.json中配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/docker/daemon.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\n{\n  "storage-driver": "overlay2",\n  "storage-opts": ["overlay2.override_kernel_check=true"],\n  "log-driver": "json-file",\n  "log-opts": {\n    "max-size": "10m",\n    "max-file": "3"\n  },\n  "default-ulimits": {\n    "nofile": {\n      "Name": "nofile",\n      "Hard": 64000,\n      "Soft": 64000\n    }\n  },\n  "live-restore": true,\n  "max-concurrent-downloads": 10,\n  "max-concurrent-uploads": 10,\n  "registry-mirrors": ["https://mirror.example.com"],\n  "insecure-registries": ["registry.internal:5000"],\n  "experimental": false,\n  "metrics-addr": "0.0.0.0:9323",\n  "dns": ["8.8.8.8", "8.8.4.4"]\n}\nEOF')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启Docker服务")]),t._v("\nsystemctl restart "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v("\n")])])]),a("h3",{attrs:{id:"主机系统优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主机系统优化"}},[t._v("#")]),t._v(" 主机系统优化")]),t._v(" "),a("p",[t._v("优化主机系统配置以提高Docker性能。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 调整内核参数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/sysctl.d/99-docker.conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n# 最大文件句柄数\nfs.file-max = 1000000\n\n# 允许更多的PIDs\nkernel.pid_max = 4194303\n\n# 增加网络性能相关参数\nnet.core.somaxconn = 65535\nnet.ipv4.tcp_max_syn_backlog = 65536\nnet.core.netdev_max_backlog = 65536\nnet.ipv4.ip_local_port_range = 1024 65535\nnet.ipv4.tcp_fin_timeout = 15\nnet.ipv4.tcp_keepalive_time = 300\nnet.ipv4.tcp_keepalive_intvl = 30\nnet.ipv4.tcp_keepalive_probes = 5\n\n# 启用IP转发（容器网络需要）\nnet.ipv4.ip_forward = 1\n\n# 增加inotify限制（容器文件系统监控需要）\nfs.inotify.max_user_watches = 1048576\nfs.inotify.max_user_instances = 8192\nEOF")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 应用内核参数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sysctl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--system")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 调整用户限制")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/security/limits.d/99-docker.conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n* soft nofile 1048576\n* hard nofile 1048576\nroot soft nofile 1048576\nroot hard nofile 1048576\n* soft nproc 1048576\n* hard nproc 1048576\nroot soft nproc 1048576\nroot hard nproc 1048576\nEOF")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 优化磁盘I/O调度器（对SSD）")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mq-deadline"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /sys/block/sda/queue/scheduler\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. 禁用不必要的服务")]),t._v("\nsystemctl disable snapd\nsystemctl disable lxcfs\nsystemctl disable accounts-daemon\n")])])]),a("h2",{attrs:{id:"备份和恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#备份和恢复"}},[t._v("#")]),t._v(" 备份和恢复")]),t._v(" "),a("h3",{attrs:{id:"数据备份策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据备份策略"}},[t._v("#")]),t._v(" 数据备份策略")]),t._v(" "),a("p",[t._v("实施全面的备份策略，确保数据安全。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 创建备份脚本")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/local/bin/docker-backup.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'EOF\'\n#!/bin/bash\n\nBACKUP_DIR="/mnt/backups/$(date +%Y%m%d)"\nDOCKER_DATA_DIR="/var/lib/docker"\nVOLUME_BACKUP_DIR="${BACKUP_DIR}/volumes"\n\n# 创建备份目录\nmkdir -p "${VOLUME_BACKUP_DIR}"\n\n# 备份Docker配置\nmkdir -p "${BACKUP_DIR}/config"\ncp -r /etc/docker "${BACKUP_DIR}/config/"\n\n# 备份Swarm配置（如果使用Swarm）\nif docker info | grep -q "Swarm: active"; then\n  mkdir -p "${BACKUP_DIR}/swarm"\n  sudo systemctl stop docker\n  cp -r "${DOCKER_DATA_DIR}/swarm" "${BACKUP_DIR}/swarm/"\n  sudo systemctl start docker\nfi\n\n# 备份命名卷\nfor volume in $(docker volume ls -q); do\n  echo "Backing up volume: ${volume}"\n  mkdir -p "${VOLUME_BACKUP_DIR}/${volume}"\n  docker run --rm \\\n    -v "${volume}":/source \\\n    -v "${VOLUME_BACKUP_DIR}/${volume}":/backup \\\n    alpine \\\n    tar -czf "/backup/${volume}.tar.gz" -C /source .\ndone\n\n# 备份运行中的容器配置\nmkdir -p "${BACKUP_DIR}/containers"\nfor container in $(docker ps -q); do\n  container_name=$(docker inspect --format="{{.Name}}" "${container}" | sed \'s/^\\/*//\')\n  echo "Backing up container config: ${container_name}"\n  docker inspect "${container}" > "${BACKUP_DIR}/containers/${container_name}.json"\ndone\n\n# 备份自定义网络配置\nmkdir -p "${BACKUP_DIR}/networks"\nfor network in $(docker network ls --filter "driver=overlay" --format "{{.Name}}" | grep -v "ingress"); do\n  echo "Backing up network config: ${network}"\n  docker network inspect "${network}" > "${BACKUP_DIR}/networks/${network}.json"\ndone\n\n# 压缩备份\ncd "$(dirname "${BACKUP_DIR}")"\ntar -czf "docker-backup-$(date +%Y%m%d).tar.gz" "$(basename "${BACKUP_DIR}")"\nrm -rf "${BACKUP_DIR}"\n\necho "Backup completed: docker-backup-$(date +%Y%m%d).tar.gz"\nEOF')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x /usr/local/bin/docker-backup.sh\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 设置定时备份")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0 1 * * * /usr/local/bin/docker-backup.sh"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("crontab")]),t._v(" -\n")])])]),a("h3",{attrs:{id:"系统恢复流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统恢复流程"}},[t._v("#")]),t._v(" 系统恢复流程")]),t._v(" "),a("p",[t._v("制定系统恢复流程，确保在灾难发生时能够快速恢复。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 创建恢复脚本")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/local/bin/docker-restore.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'EOF\'\n#!/bin/bash\n\nif [ $# -ne 1 ]; then\n  echo "Usage: $0 <backup-file>"\n  exit 1\nfi\n\nBACKUP_FILE="$1"\nRESTORE_DIR="/tmp/docker-restore"\n\n# 解压备份\nrm -rf "${RESTORE_DIR}"\nmkdir -p "${RESTORE_DIR}"\ntar -xzf "${BACKUP_FILE}" -C "${RESTORE_DIR}"\nBACKUP_DIR=$(find "${RESTORE_DIR}" -type d -name "[0-9]*" | head -1)\n\n# 恢复Docker配置\nif [ -d "${BACKUP_DIR}/config/docker" ]; then\n  echo "Restoring Docker configuration..."\n  cp -r "${BACKUP_DIR}/config/docker"/* /etc/docker/\nfi\n\n# 停止Docker服务\nsystemctl stop docker\n\n# 恢复Swarm配置（如果存在）\nif [ -d "${BACKUP_DIR}/swarm" ]; then\n  echo "Restoring Swarm configuration..."\n  rm -rf /var/lib/docker/swarm\n  mkdir -p /var/lib/docker/swarm\n  cp -r "${BACKUP_DIR}/swarm/swarm"/* /var/lib/docker/swarm/\nfi\n\n# 启动Docker服务\nsystemctl start docker\n\n# 恢复命名卷\nif [ -d "${BACKUP_DIR}/volumes" ]; then\n  echo "Restoring volumes..."\n  for volume_tar in "${BACKUP_DIR}/volumes"/*/*.tar.gz; do\n    volume_name=$(basename "$(dirname "${volume_tar}")")\n    echo "Restoring volume: ${volume_name}"\n    \n    # 创建卷（如果不存在）\n    if ! docker volume inspect "${volume_name}" &>/dev/null; then\n      docker volume create "${volume_name}"\n    fi\n    \n    # 恢复卷数据\n    docker run --rm \\\n      -v "${volume_name}":/target \\\n      -v "$(dirname "${volume_tar}")":/backup \\\n      alpine \\\n      sh -c "rm -rf /target/* && tar -xzf /backup/$(basename "${volume_tar}") -C /target"\n  done\nfi\n\n# 恢复网络配置\nif [ -d "${BACKUP_DIR}/networks" ]; then\n  echo "Restoring networks..."\n  for network_file in "${BACKUP_DIR}/networks"/*.json; do\n    network_name=$(basename "${network_file}" .json)\n    echo "Restoring network: ${network_name}"\n    \n    # 检查网络是否存在\n    if ! docker network inspect "${network_name}" &>/dev/null; then\n      # 从备份文件提取网络配置\n      driver=$(jq -r \'.[0].Driver\' "${network_file}")\n      subnet=$(jq -r \'.[0].IPAM.Config[0].Subnet\' "${network_file}")\n      gateway=$(jq -r \'.[0].IPAM.Config[0].Gateway\' "${network_file}")\n      \n      # 创建网络\n      docker network create \\\n        --driver "${driver}" \\\n        --subnet "${subnet}" \\\n        --gateway "${gateway}" \\\n        "${network_name}"\n    fi\n  done\nfi\n\n# 恢复容器（可选，通常使用编排工具重新部署）\n# ...\n\necho "Restore completed."\nEOF')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x /usr/local/bin/docker-restore.sh\n")])])]),a("h3",{attrs:{id:"灾难恢复演练"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#灾难恢复演练"}},[t._v("#")]),t._v(" 灾难恢复演练")]),t._v(" "),a("p",[t._v("定期进行灾难恢复演练，确保恢复流程有效。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 创建演练脚本")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/local/bin/dr-drill.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'EOF\'\n#!/bin/bash\n\n# 设置测试环境\nTEST_DIR="/tmp/dr-test"\nmkdir -p "${TEST_DIR}"\n\n# 创建测试卷和数据\ndocker volume create test-volume\ndocker run --rm -v test-volume:/data alpine sh -c "echo \'test data\' > /data/test.txt"\n\n# 备份测试环境\necho "Backing up test environment..."\n/usr/local/bin/docker-backup.sh\nBACKUP_FILE=$(ls -t docker-backup-*.tar.gz | head -1)\n\n# 删除测试卷\ndocker volume rm test-volume\n\n# 恢复测试环境\necho "Restoring test environment..."\n/usr/local/bin/docker-restore.sh "${BACKUP_FILE}"\n\n# 验证恢复结果\necho "Verifying restore..."\nRESTORE_RESULT=$(docker run --rm -v test-volume:/data alpine cat /data/test.txt)\n\nif [ "${RESTORE_RESULT}" = "test data" ]; then\n  echo "Disaster recovery drill: SUCCESS"\nelse\n  echo "Disaster recovery drill: FAILED"\nfi\n\n# 清理\ndocker volume rm test-volume\nrm -rf "${TEST_DIR}"\nEOF')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x /usr/local/bin/dr-drill.sh\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 设置定期演练")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0 2 1 * * /usr/local/bin/dr-drill.sh"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("crontab")]),t._v(" -\n")])])]),a("h2",{attrs:{id:"安全最佳实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安全最佳实践"}},[t._v("#")]),t._v(" 安全最佳实践")]),t._v(" "),a("h3",{attrs:{id:"容器安全配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#容器安全配置"}},[t._v("#")]),t._v(" 容器安全配置")]),t._v(" "),a("p",[t._v("实施容器安全最佳实践。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 以非root用户运行容器")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--user")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(":1000 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.3.0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 使用只读文件系统")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --read-only "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--tmpfs")]),t._v(" /tmp:rw,noexec,nosuid "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.3.0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 限制容器功能")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --cap-drop ALL "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --cap-add NET_BIND_SERVICE "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --security-opt no-new-privileges "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.3.0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. 使用seccomp配置文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" myapp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --security-opt "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("seccomp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/docker/seccomp-profile.json "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  myregistry.example.com/myapp:1.3.0\n")])])]),a("h3",{attrs:{id:"网络安全"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络安全"}},[t._v("#")]),t._v(" 网络安全")]),t._v(" "),a("p",[t._v("实施网络安全最佳实践。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 创建隔离网络")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" network create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--driver")]),t._v(" overlay "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--internal")]),t._v(" backend-network\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 使用加密的覆盖网络")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" network create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--driver")]),t._v(" overlay "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--opt")]),t._v(" encrypted secure-network\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 配置网络策略")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在Kubernetes中使用NetworkPolicy")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" network-policy.yaml "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: db-policy\nspec:\n  podSelector:\n    matchLabels:\n      app: db\n  policyTypes:\n  - Ingress\n  ingress:\n  - from:\n    - podSelector:\n        matchLabels:\n          app: api\n    ports:\n    - protocol: TCP\n      port: 3306\nEOF")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. 使用TLS加密通信")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" web "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--secret")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("source")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("ssl-cert,target"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/nginx/ssl/cert.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--secret")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("source")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("ssl-key,target"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/nginx/ssl/key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--config")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("source")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx-ssl,target"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/nginx/conf.d/default.conf "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  nginx:latest\n")])])]),a("h3",{attrs:{id:"访问控制和认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#访问控制和认证"}},[t._v("#")]),t._v(" 访问控制和认证")]),t._v(" "),a("p",[t._v("实施访问控制和认证最佳实践。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 使用Docker Content Trust签名和验证镜像")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DOCKER_CONTENT_TRUST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" pull myregistry.example.com/myapp:1.3.0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 使用RBAC控制API访问（在Kubernetes中）")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" rbac.yaml "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  namespace: default\n  name: pod-reader\nrules:\n- apiGroups: [""] # "" 表示核心API组\n  resources: ["pods"]\n  verbs: ["get", "watch", "list"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: read-pods\n  namespace: default\nsubjects:\n- kind: User\n  name: jane\n  apiGroup: rbac.authorization.k8s.io\nroleRef:\n  kind: Role\n  name: pod-reader\n  apiGroup: rbac.authorization.k8s.io\nEOF')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 使用Docker Secrets管理敏感信息")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" secret create db-password /path/to/password.txt\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" db "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--secret")]),t._v(" db-password "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--env")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_PASSWORD_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/run/secrets/db-password "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  mysql:5.7\n")])])]),a("h2",{attrs:{id:"自动化和ci-cd"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自动化和ci-cd"}},[t._v("#")]),t._v(" 自动化和CI/CD")]),t._v(" "),a("h3",{attrs:{id:"ci-cd流水线"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ci-cd流水线"}},[t._v("#")]),t._v(" CI/CD流水线")]),t._v(" "),a("p",[t._v("实施CI/CD流水线，自动化构建、测试和部署过程。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .gitlab-ci.yml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" scan\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" verify\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("variables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DOCKER_REGISTRY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myregistry.example.com\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("IMAGE_NAME")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myapp\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("IMAGE_TAG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $CI_COMMIT_SHA\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t $DOCKER_REGISTRY/$IMAGE_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$IMAGE_TAG .\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker push $DOCKER_REGISTRY/$IMAGE_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$IMAGE_TAG\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker pull $DOCKER_REGISTRY/$IMAGE_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$IMAGE_TAG\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker run "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rm $DOCKER_REGISTRY/$IMAGE_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$IMAGE_TAG npm test\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" scan\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" trivy image "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("exit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("code 1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("severity HIGH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("CRITICAL $DOCKER_REGISTRY/$IMAGE_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$IMAGE_TAG\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy_staging")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker stack deploy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("c docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("compose.staging.yml "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("registry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("auth myapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("staging\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker service update "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("image $DOCKER_REGISTRY/$IMAGE_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$IMAGE_TAG myapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("staging_app\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" staging\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" develop\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy_production")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker stack deploy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("c docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("compose.prod.yml "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("registry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("auth myapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("prod\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker service update "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("image $DOCKER_REGISTRY/$IMAGE_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$IMAGE_TAG myapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("prod_app\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" production\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" manual\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" master\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("verify")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" verify\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" curl "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//staging.example.com/health "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" exit 1\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" staging\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" develop\n")])])]),a("h3",{attrs:{id:"自动化测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自动化测试"}},[t._v("#")]),t._v(" 自动化测试")]),t._v(" "),a("p",[t._v("实施自动化测试，确保应用质量。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 单元测试")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--rm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("pwd")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(":/app "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-w")]),t._v(" /app "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  node:14 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run test:unit\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 集成测试")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker-compose")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" docker-compose.test.yml up --abort-on-container-exit\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. 端到端测试")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--rm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--network")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("pwd")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(":/app "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-w")]),t._v(" /app "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  cypress/included:8.3.0 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  cypress run\n")])])]),a("h3",{attrs:{id:"基础设施即代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基础设施即代码"}},[t._v("#")]),t._v(" 基础设施即代码")]),t._v(" "),a("p",[t._v("使用基础设施即代码工具管理Docker环境。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.yml with environment variables")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.8'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_REGISTRY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("IMAGE_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("IMAGE_TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("REPLICAS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("-3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("update_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("parallelism")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("UPDATE_PARALLELISM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("-1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("delay")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("UPDATE_DELAY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("30s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("order")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("first\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("failure_action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rollback\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CPU_LIMIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("-0.5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("MEMORY_LIMIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("512M"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" NODE_ENV=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("NODE_ENV"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("production"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_HOST=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DB_HOST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" frontend\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" backend\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.7")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/lib/mysql\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" MYSQL_ROOT_PASSWORD_FILE=/run/secrets/db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("password\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" MYSQL_DATABASE=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DB_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("myapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("secrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("password\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" backend\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("frontend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("driver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" overlay\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("driver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" overlay\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("internal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("db-data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("secrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("db-password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n")])])]),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("Docker生产环境部署是一个复杂的过程，涉及多个方面的考虑和优化。通过本文介绍的最佳实践，您可以构建一个可靠、高效、安全的Docker生产环境。")]),t._v(" "),a("p",[t._v("关键要点包括：")]),t._v(" "),a("ol",[a("li",[a("strong",[t._v("基础设施规划")]),t._v("：根据工作负载需求规划硬件、操作系统、存储和网络。")]),t._v(" "),a("li",[a("strong",[t._v("容器编排")]),t._v("：选择合适的容器编排系统（Docker Swarm、Kubernetes或Docker Compose）。")]),t._v(" "),a("li",[a("strong",[t._v("镜像管理")]),t._v("：使用私有镜像仓库、制定标签策略、进行安全扫描。")]),t._v(" "),a("li",[a("strong",[t._v("部署策略")]),t._v("：实施蓝绿部署、金丝雀部署或滚动更新。")]),t._v(" "),a("li",[a("strong",[t._v("高可用性")]),t._v("：配置集群高可用、服务高可用和数据持久化。")]),t._v(" "),a("li",[a("strong",[t._v("监控和日志")]),t._v("：部署监控系统和集中式日志管理。")]),t._v(" "),a("li",[a("strong",[t._v("性能优化")]),t._v("：优化容器、Docker守护进程和主机系统。")]),t._v(" "),a("li",[a("strong",[t._v("备份和恢复")]),t._v("：实施备份策略、制定恢复流程、进行灾难恢复演练。")]),t._v(" "),a("li",[a("strong",[t._v("安全最佳实践")]),t._v("：实施容器安全配置、网络安全和访问控制。")]),t._v(" "),a("li",[a("strong",[t._v("自动化和CI/CD")]),t._v("：实施CI/CD流水线、自动化测试和基础设施即代码。")])]),t._v(" "),a("p",[t._v("通过遵循这些最佳实践，您可以构建一个稳定、安全、高效的Docker生产环境，为您的应用提供可靠的运行平台。")]),t._v(" "),a("h2",{attrs:{id:"下一步学习"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下一步学习"}},[t._v("#")]),t._v(" 下一步学习")]),t._v(" "),a("ul",[a("li",[a("RouterLink",{attrs:{to:"/docker/docker-security.html"}},[t._v("Docker安全最佳实践")])],1),t._v(" "),a("li",[a("RouterLink",{attrs:{to:"/docker/docker-swarm.html"}},[t._v("Docker Swarm集群")])],1),t._v(" "),a("li",[a("RouterLink",{attrs:{to:"/docker/docker-compose.html"}},[t._v("Docker Compose详解")])],1),t._v(" "),a("li",[a("RouterLink",{attrs:{to:"/docker/docker-volumes.html"}},[t._v("Docker数据卷管理")])],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);