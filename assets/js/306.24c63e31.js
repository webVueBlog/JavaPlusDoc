(window.webpackJsonp=window.webpackJsonp||[]).push([[306],{1123:function(a,s,t){"use strict";t.r(s);var e=t(1),r=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"docker安全最佳实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker安全最佳实践"}},[a._v("#")]),a._v(" Docker安全最佳实践")]),a._v(" "),s("h2",{attrs:{id:"docker安全概述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker安全概述"}},[a._v("#")]),a._v(" Docker安全概述")]),a._v(" "),s("p",[a._v("Docker容器技术为应用部署带来了便利，但同时也引入了新的安全挑战。Docker安全涉及多个层面，包括主机安全、镜像安全、容器运行时安全、网络安全和数据安全等。本文将详细介绍Docker环境中的安全最佳实践，帮助您构建更安全的容器化环境。")]),a._v(" "),s("h2",{attrs:{id:"docker主机安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker主机安全"}},[a._v("#")]),a._v(" Docker主机安全")]),a._v(" "),s("h3",{attrs:{id:"操作系统加固"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#操作系统加固"}},[a._v("#")]),a._v(" 操作系统加固")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 保持系统更新")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt")]),a._v(" upgrade "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Debian/Ubuntu")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" yum update "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# CentOS/RHEL")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 禁用不必要的服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl disable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("service-name"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl stop "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("service-name"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置防火墙，只开放必要端口")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ufw allow "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ssh")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Ubuntu")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ufw allow "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2376")]),a._v("/tcp  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Docker TLS")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ufw allow "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2377")]),a._v("/tcp  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Swarm mode")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ufw allow "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("7946")]),a._v("/tcp  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Swarm mode node communication")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ufw allow "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("7946")]),a._v("/udp  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Swarm mode node communication")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ufw allow "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4789")]),a._v("/udp  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Swarm overlay network")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ufw "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 或使用firewalld (CentOS/RHEL)")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" firewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--permanent")]),a._v(" --add-port"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v("/tcp\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" firewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--permanent")]),a._v(" --add-port"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2376")]),a._v("/tcp\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" firewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--permanent")]),a._v(" --add-port"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2377")]),a._v("/tcp\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" firewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--permanent")]),a._v(" --add-port"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("7946")]),a._v("/tcp\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" firewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--permanent")]),a._v(" --add-port"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("7946")]),a._v("/udp\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" firewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--permanent")]),a._v(" --add-port"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4789")]),a._v("/udp\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" firewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--reload")]),a._v("\n")])])]),s("h3",{attrs:{id:"docker守护进程安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker守护进程安全"}},[a._v("#")]),a._v(" Docker守护进程安全")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("使用TLS加密Docker API通信")])])]),a._v(" "),s("p",[a._v("创建CA和证书：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建CA私钥和证书")]),a._v("\nopenssl genrsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-aes256")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" ca-key.pem "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\nopenssl req "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x509")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-days")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("365")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-key")]),a._v(" ca-key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-sha256")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" ca.pem\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建服务器密钥和CSR")]),a._v("\nopenssl genrsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" server-key.pem "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\nopenssl req "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-subj")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/CN=your-server-name"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-sha256")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-key")]),a._v(" server-key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" server.csr\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置服务器证书的扩展属性")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" subjectAltName "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" DNS:your-server-name,IP:10.10.10.20,IP:127.0.0.1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" extfile.cnf\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" extendedKeyUsage "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" serverAuth "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" extfile.cnf\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 生成服务器证书")]),a._v("\nopenssl x509 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-req")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-days")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("365")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-sha256")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-in")]),a._v(" server.csr "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CA")]),a._v(" ca.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CAkey")]),a._v(" ca-key.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CAcreateserial")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" server-cert.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-extfile")]),a._v(" extfile.cnf\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建客户端密钥和CSR")]),a._v("\nopenssl genrsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" key.pem "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\nopenssl req "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-subj")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'/CN=client'")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-key")]),a._v(" key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" client.csr\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置客户端证书的扩展属性")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" extendedKeyUsage "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" clientAuth "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" extfile-client.cnf\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 生成客户端证书")]),a._v("\nopenssl x509 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-req")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-days")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("365")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-sha256")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-in")]),a._v(" client.csr "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CA")]),a._v(" ca.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CAkey")]),a._v(" ca-key.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CAcreateserial")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" cert.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-extfile")]),a._v(" extfile-client.cnf\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除不需要的文件")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" client.csr server.csr extfile.cnf extfile-client.cnf\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置权限")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" 0400 ca-key.pem key.pem server-key.pem\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" 0444 ca.pem server-cert.pem cert.pem\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("配置Docker守护进程")])])]),a._v(" "),s("p",[a._v("编辑Docker配置文件 "),s("code",[a._v("/etc/docker/daemon.json")]),a._v("：")]),a._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"tls"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"tlsverify"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"tlscacert"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/path/to/ca.pem"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"tlscert"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/path/to/server-cert.pem"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"tlskey"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/path/to/server-key.pem"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"hosts"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"tcp://0.0.0.0:2376"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"unix:///var/run/docker.sock"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"log-level"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"info"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"icc"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"no-new-privileges"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"userns-remap"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"default"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"live-restore"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"userland-proxy"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"default-ulimits"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"nofile"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"Name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"nofile"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"Hard"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("64000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"Soft"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("64000")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[s("strong",[a._v("重启Docker服务")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl restart "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[s("strong",[a._v("使用客户端证书连接Docker")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlsverify")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlscacert")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("ca.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlscert")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("cert.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlskey")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("key.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-H")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("your-server-name:2376 version\n")])])]),s("h3",{attrs:{id:"用户权限管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用户权限管理"}},[a._v("#")]),a._v(" 用户权限管理")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("创建Docker用户组")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建docker组（通常安装Docker时已创建）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("groupadd")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将用户添加到docker组")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("usermod")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-aG")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[a._v("$USER")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 应用更改（重新登录或运行以下命令）")]),a._v("\nnewgrp "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("限制Docker用户组权限")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建专用的Docker管理员用户")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("useradd")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" dockeradmin\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("usermod")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-aG")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" dockeradmin\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用sudo授予特定命令权限")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" visudo\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 添加以下行")]),a._v("\ndockeradmin "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("ALL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ALL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" /usr/bin/docker\n")])])]),s("h2",{attrs:{id:"容器镜像安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#容器镜像安全"}},[a._v("#")]),a._v(" 容器镜像安全")]),a._v(" "),s("h3",{attrs:{id:"使用官方和验证的镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用官方和验证的镜像"}},[a._v("#")]),a._v(" 使用官方和验证的镜像")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 拉取官方镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" pull ubuntu:20.04\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 拉取经过验证的镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" pull nginx:latest\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 检查镜像签名（需要Docker Content Trust）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("DOCKER_CONTENT_TRUST")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" pull nginx:latest\n")])])]),s("h3",{attrs:{id:"启用docker-content-trust"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启用docker-content-trust"}},[a._v("#")]),a._v(" 启用Docker Content Trust")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 启用Docker Content Trust")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("DOCKER_CONTENT_TRUST")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 生成签名密钥")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" trust key generate my-key\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将密钥添加到仓库")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" trust signer "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--key")]),a._v(" my-key.pub my-key my-registry.example.com/my-image\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 签名并推送镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" tag my-image:latest my-registry.example.com/my-image:latest\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" push my-registry.example.com/my-image:latest\n")])])]),s("h3",{attrs:{id:"镜像扫描和漏洞管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#镜像扫描和漏洞管理"}},[a._v("#")]),a._v(" 镜像扫描和漏洞管理")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("使用Docker Scout")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 安装Docker Scout CLI")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" extension "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" docker/scout-extension\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 扫描本地镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" scout cves nginx:latest\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看详细漏洞报告")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" scout recommendations nginx:latest\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("使用第三方扫描工具")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用Trivy扫描镜像")]),a._v("\ntrivy image nginx:latest\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用Clair扫描镜像")]),a._v("\nclairctl analyze "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-l")]),a._v(" nginx:latest\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用Anchore扫描镜像")]),a._v("\nanchore-cli image "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" docker.io/library/nginx:latest\nanchore-cli image "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("wait")]),a._v(" docker.io/library/nginx:latest\nanchore-cli image vuln docker.io/library/nginx:latest os\n")])])]),s("h3",{attrs:{id:"构建安全的docker镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#构建安全的docker镜像"}},[a._v("#")]),a._v(" 构建安全的Docker镜像")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("最小化基础镜像")])])]),a._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用Alpine作为基础镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" alpine:3.14")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 或使用distroless镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" gcr.io/distroless/static-debian10")]),a._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("多阶段构建")])])]),a._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 构建阶段")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" node:14 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("AS")]),a._v(" builder")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("WORKDIR")]),a._v(" /app")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COPY")]),a._v(" package*.json ./")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("RUN")]),a._v(" npm ci")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COPY")]),a._v(" . .")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("RUN")]),a._v(" npm run build")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 运行阶段")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" nginx:alpine")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COPY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[a._v("--from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("builder")])]),a._v(" /app/build /usr/share/nginx/html")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("EXPOSE")]),a._v(" 80")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("CMD")]),a._v(" ["),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"nginx"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"-g"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"daemon off;"')]),a._v("]")]),a._v("\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[s("strong",[a._v("不要在镜像中包含敏感信息")])])]),a._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 错误示例 - 不要这样做")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" ubuntu:20.04")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ENV")]),a._v(" DB_PASSWORD=supersecret")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 正确示例 - 使用构建参数，但不保存在最终镜像中")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" ubuntu:20.04")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ARG")]),a._v(" DB_PASSWORD")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("RUN")]),a._v(" echo "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$DB_PASSWORD")]),a._v(" > /tmp/setup && ./setup.sh && rm /tmp/setup")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更好的方式 - 使用Docker Secrets或环境变量注入")]),a._v("\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[s("strong",[a._v("定期更新基础镜像")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 拉取最新的基础镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" pull ubuntu:20.04\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 重新构建应用镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" my-app:latest "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])])]),s("h2",{attrs:{id:"容器运行时安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#容器运行时安全"}},[a._v("#")]),a._v(" 容器运行时安全")]),a._v(" "),s("h3",{attrs:{id:"以非root用户运行容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#以非root用户运行容器"}},[a._v("#")]),a._v(" 以非root用户运行容器")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("在Dockerfile中设置用户")])])]),a._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" ubuntu:20.04")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建非root用户")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("RUN")]),a._v(" groupadd -r appuser && useradd -r -g appuser appuser")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置应用目录权限")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("WORKDIR")]),a._v(" /app")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COPY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[a._v("--chown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("appuser:appuser")])]),a._v(" . .")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 切换到非root用户")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("USER")]),a._v(" appuser")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("CMD")]),a._v(" ["),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"./app"')]),a._v("]")]),a._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("运行时指定用户")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用--user标志")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1000")]),a._v(":1000 nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 或使用用户名")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),a._v(" appuser nginx\n")])])]),s("h3",{attrs:{id:"限制容器资源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#限制容器资源"}},[a._v("#")]),a._v(" 限制容器资源")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 限制CPU和内存")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" limited-container "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--cpus")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0.5")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--memory")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("512m "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --memory-swap"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("512m "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 限制IO")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" io-limited "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --device-write-bps /dev/sda:1mb "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --device-read-bps /dev/sda:1mb "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 限制进程数")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" process-limited "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --pids-limit"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  nginx\n")])])]),s("h3",{attrs:{id:"使用安全计算-seccomp-配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用安全计算-seccomp-配置文件"}},[a._v("#")]),a._v(" 使用安全计算（seccomp）配置文件")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("使用默认seccomp配置文件")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Docker默认启用seccomp")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" ubuntu:20.04 "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("bash")]),a._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("使用自定义seccomp配置文件")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 下载Docker默认seccomp配置作为起点")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("wget")]),a._v(" https://raw.githubusercontent.com/docker/engine/master/profiles/seccomp/default.json\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 编辑配置文件后使用")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run --security-opt "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("seccomp")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/path/to/custom-seccomp.json nginx\n")])])]),s("h3",{attrs:{id:"使用apparmor或selinux"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用apparmor或selinux"}},[a._v("#")]),a._v(" 使用AppArmor或SELinux")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("AppArmor (Ubuntu/Debian)")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 检查AppArmor状态")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" aa-status\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建自定义AppArmor配置")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("nano")]),a._v(" /etc/apparmor.d/docker-nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 加载配置")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" apparmor_parser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-W")]),a._v(" /etc/apparmor.d/docker-nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 运行容器时使用")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run --security-opt "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("apparmor")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("docker-nginx nginx\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("SELinux (CentOS/RHEL)")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 检查SELinux状态")]),a._v("\ngetenforce\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建自定义SELinux策略")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" semodule "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-i")]),a._v(" my-docker.pp\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 运行容器时使用")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run --security-opt "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("label")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("type:my_container_t nginx\n")])])]),s("h3",{attrs:{id:"使用只读文件系统"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用只读文件系统"}},[a._v("#")]),a._v(" 使用只读文件系统")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将根文件系统设为只读")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run --read-only nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 为特定目录提供写入权限")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run --read-only "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tmpfs")]),a._v(" /tmp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tmpfs")]),a._v(" /var/cache "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tmpfs")]),a._v(" /var/log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  nginx\n")])])]),s("h3",{attrs:{id:"限制容器功能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#限制容器功能"}},[a._v("#")]),a._v(" 限制容器功能")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除所有功能并只添加需要的功能")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run --cap-drop"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("ALL --cap-add"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("NET_BIND_SERVICE nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 常用的安全组合")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --cap-drop"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("ALL "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --cap-add"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("NET_BIND_SERVICE "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --cap-add"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("SYS_NICE "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --security-opt"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("no-new-privileges "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  nginx\n")])])]),s("h3",{attrs:{id:"使用docker-secrets管理敏感数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用docker-secrets管理敏感数据"}},[a._v("#")]),a._v(" 使用Docker Secrets管理敏感数据")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建secret")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"mydbpassword"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" secret create db_password -\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在服务中使用secret")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" db "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--secret")]),a._v(" db_password "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--env")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_ROOT_PASSWORD_FILE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/run/secrets/db_password "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  mysql:5.7\n")])])]),s("h2",{attrs:{id:"网络安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#网络安全"}},[a._v("#")]),a._v(" 网络安全")]),a._v(" "),s("h3",{attrs:{id:"使用用户定义的网络隔离容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用用户定义的网络隔离容器"}},[a._v("#")]),a._v(" 使用用户定义的网络隔离容器")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建自定义网络")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--driver")]),a._v(" bridge app-network\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将容器连接到自定义网络")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" web "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--network")]),a._v(" app-network nginx\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" db "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--network")]),a._v(" app-network mysql:5.7\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建内部网络（不连接到外部）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--internal")]),a._v(" internal-only\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" db "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--network")]),a._v(" internal-only mysql:5.7\n")])])]),s("h3",{attrs:{id:"限制容器间通信"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#限制容器间通信"}},[a._v("#")]),a._v(" 限制容器间通信")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 禁用默认桥接网络上的容器间通信")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在/etc/docker/daemon.json中设置")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"icc"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 重启Docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl restart "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n")])])]),s("h3",{attrs:{id:"使用tls保护容器通信"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用tls保护容器通信"}},[a._v("#")]),a._v(" 使用TLS保护容器通信")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在Docker Swarm中创建覆盖网络时启用加密")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--driver")]),a._v(" overlay "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--opt")]),a._v(" encrypted "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  secure-network\n")])])]),s("h3",{attrs:{id:"安全地发布端口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全地发布端口"}},[a._v("#")]),a._v(" 安全地发布端口")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 仅绑定到特定接口")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),a._v(".0.1:80:80 nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用动态端口映射")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),a._v(".0.1::80 nginx\n")])])]),s("h2",{attrs:{id:"数据安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据安全"}},[a._v("#")]),a._v(" 数据安全")]),a._v(" "),s("h3",{attrs:{id:"安全地管理卷和挂载"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全地管理卷和挂载"}},[a._v("#")]),a._v(" 安全地管理卷和挂载")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用命名卷")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" volume create secure-data\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" secure-data:/data nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用只读挂载")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /host/config:/container/config:ro nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用临时文件系统")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tmpfs")]),a._v(" /tmp:rw,noexec,nosuid,size"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("1g nginx\n")])])]),s("h3",{attrs:{id:"加密存储数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#加密存储数据"}},[a._v("#")]),a._v(" 加密存储数据")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在主机上创建加密卷")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" cryptsetup luksFormat /dev/sdX\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" cryptsetup "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("open")]),a._v(" /dev/sdX encrypted-data\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" mkfs.ext4 /dev/mapper/encrypted-data\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mount")]),a._v(" /dev/mapper/encrypted-data /mnt/encrypted-data\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将加密卷挂载到容器")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /mnt/encrypted-data:/data nginx\n")])])]),s("h3",{attrs:{id:"安全备份和恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全备份和恢复"}},[a._v("#")]),a._v(" 安全备份和恢复")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 备份Docker卷")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" secure-data:/data "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(":/backup alpine "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-czf")]),a._v(" /backup/secure-data-backup.tar.gz "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" /data "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 恢复Docker卷")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" secure-data:/data "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(":/backup alpine "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"cd /data && tar -xzf /backup/secure-data-backup.tar.gz"')]),a._v("\n")])])]),s("h2",{attrs:{id:"监控和审计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#监控和审计"}},[a._v("#")]),a._v(" 监控和审计")]),a._v(" "),s("h3",{attrs:{id:"启用docker审计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启用docker审计"}},[a._v("#")]),a._v(" 启用Docker审计")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("使用auditd监控Docker活动")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 安装auditd")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" auditd  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Debian/Ubuntu")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" yum "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" audit  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# CentOS/RHEL")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置Docker审计规则")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("nano")]),a._v(" /etc/audit/rules.d/docker.rules\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 添加以下规则")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" /usr/bin/docker "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" /var/lib/docker "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" /etc/docker "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" /lib/systemd/system/docker.service "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" /lib/systemd/system/docker.socket "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" /etc/default/docker "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" /etc/docker/daemon.json "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" /usr/lib/systemd/system/docker.service "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" /usr/lib/systemd/system/docker.socket "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 重新加载审计规则")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" auditctl "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-R")]),a._v(" /etc/audit/rules.d/docker.rules\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看Docker相关审计日志")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ausearch "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n")])])]),s("h3",{attrs:{id:"使用容器日志记录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用容器日志记录"}},[a._v("#")]),a._v(" 使用容器日志记录")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置Docker日志驱动")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在/etc/docker/daemon.json中设置")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"log-driver"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"json-file"')]),a._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"log-opts"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"max-size"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"10m"')]),a._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"max-file"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"3"')]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 为特定容器配置日志驱动")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --log-driver"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("syslog "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --log-opt syslog-address"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("udp://syslog-server:514 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看容器日志")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" logs container_id\n")])])]),s("h3",{attrs:{id:"使用监控工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用监控工具"}},[a._v("#")]),a._v(" 使用监控工具")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("使用cAdvisor监控容器")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--volume")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/:/rootfs:ro "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--volume")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/run:/var/run:ro "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--volume")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/sys:/sys:ro "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--volume")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/lib/docker/:/var/lib/docker:ro "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--volume")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/dev/disk/:/dev/disk:ro "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--publish")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("8080")]),a._v(":8080 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--detach")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("cadvisor "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--privileged")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--device")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/dev/kmsg "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  gcr.io/cadvisor/cadvisor:v0.39.3\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("使用Prometheus和Grafana")])])]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'3'")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("prometheus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" prom/prometheus\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" ./prometheus.yml"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/etc/prometheus/prometheus.yml\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"9090:9090"')]),a._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("node-exporter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" prom/node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("exporter\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /proc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/host/proc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/host/sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/rootfs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'--path.procfs=/host/proc'")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'--path.sysfs=/host/sys'")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"9100:9100"')]),a._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cadvisor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" gcr.io/cadvisor/cadvisor\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/rootfs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /var/run"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/run"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("rw\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /var/lib/docker/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/lib/docker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"8080:8080"')]),a._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("grafana")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" grafana/grafana\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"3000:3000"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" grafana"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/lib/grafana\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("grafana-data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n")])])]),s("h2",{attrs:{id:"安全更新和补丁管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全更新和补丁管理"}},[a._v("#")]),a._v(" 安全更新和补丁管理")]),a._v(" "),s("h3",{attrs:{id:"自动化镜像更新"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#自动化镜像更新"}},[a._v("#")]),a._v(" 自动化镜像更新")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("使用Watchtower自动更新容器")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 运行Watchtower以自动更新所有容器")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" watchtower "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),a._v(" always "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /var/run/docker.sock:/var/run/docker.sock "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  containrrr/watchtower "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--interval")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("86400")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 仅更新特定容器")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" watchtower "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),a._v(" always "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /var/run/docker.sock:/var/run/docker.sock "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  containrrr/watchtower "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--interval")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("86400")]),a._v(" container1 container2\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("使用CI/CD管道自动构建和部署")])])]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# .gitlab-ci.yml示例")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" scan\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" deploy\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" docker build "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("t my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("$CI_COMMIT_SHA .\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" docker push my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("$CI_COMMIT_SHA\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" docker run my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("$CI_COMMIT_SHA npm test\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("scan")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" scan\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" trivy image my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("$CI_COMMIT_SHA\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" docker service update "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("image my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("$CI_COMMIT_SHA my_service\n")])])]),s("h3",{attrs:{id:"定期安全审计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#定期安全审计"}},[a._v("#")]),a._v(" 定期安全审计")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用Docker Bench Security进行安全审计")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /var/run/docker.sock:/var/run/docker.sock "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /usr/bin/docker:/usr/bin/docker "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /etc/docker:/etc/docker "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /etc:/host/etc "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /lib/systemd:/host/lib/systemd "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /usr/lib/systemd:/host/usr/lib/systemd "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /var/lib:/host/var/lib "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  docker/docker-bench-security\n")])])]),s("h2",{attrs:{id:"安全合规性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全合规性"}},[a._v("#")]),a._v(" 安全合规性")]),a._v(" "),s("h3",{attrs:{id:"符合cis-docker基准"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#符合cis-docker基准"}},[a._v("#")]),a._v(" 符合CIS Docker基准")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用Docker Bench Security检查CIS合规性")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /var/run/docker.sock:/var/run/docker.sock "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /usr/bin/docker:/usr/bin/docker "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /etc/docker:/etc/docker "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /etc:/host/etc "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /lib/systemd:/host/lib/systemd "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /usr/lib/systemd:/host/usr/lib/systemd "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /var/lib:/host/var/lib "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  docker/docker-bench-security\n")])])]),s("h3",{attrs:{id:"符合gdpr-hipaa等法规"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#符合gdpr-hipaa等法规"}},[a._v("#")]),a._v(" 符合GDPR/HIPAA等法规")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("数据加密")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用加密卷")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v('# 参见前面的"加密存储数据"部分')]),a._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[a._v("数据隔离")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用专用网络")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--internal")]),a._v(" sensitive-data-network\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用专用卷")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" volume create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--label")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("data")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("sensitive sensitive-data\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[s("strong",[a._v("访问控制")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用RBAC（在Docker Enterprise或Kubernetes中）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用Docker Content Trust签名镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("DOCKER_CONTENT_TRUST")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n")])])]),s("h2",{attrs:{id:"安全事件响应"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全事件响应"}},[a._v("#")]),a._v(" 安全事件响应")]),a._v(" "),s("h3",{attrs:{id:"创建安全事件响应计划"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建安全事件响应计划"}},[a._v("#")]),a._v(" 创建安全事件响应计划")]),a._v(" "),s("ol",[s("li",[s("p",[s("strong",[a._v("准备阶段")])]),a._v(" "),s("ul",[s("li",[a._v("记录Docker环境")]),a._v(" "),s("li",[a._v("建立基线")]),a._v(" "),s("li",[a._v("设置监控和警报")])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("检测阶段")])]),a._v(" "),s("ul",[s("li",[a._v("监控异常活动")]),a._v(" "),s("li",[a._v("使用入侵检测系统")])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("遏制阶段")])])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 隔离受影响的容器")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network disconnect bridge compromised-container\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 停止受影响的容器")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" stop compromised-container\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 保存容器状态以供分析")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" commit compromised-container forensic-image\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[s("strong",[a._v("根除阶段")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除受影响的容器和镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" compromised-container\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" rmi compromised-image\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新基础镜像和应用")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" pull base-image:latest\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" my-app:latest "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])])]),s("ol",{attrs:{start:"5"}},[s("li",[s("strong",[a._v("恢复阶段")])])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 从备份恢复数据")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" backup-volume:/backup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" data-volume:/data alpine "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"cd /data && tar -xzf /backup/backup.tar.gz"')]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 部署更新后的应用")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--image")]),a._v(" my-app:latest my_service\n")])])]),s("h2",{attrs:{id:"docker安全清单"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker安全清单"}},[a._v("#")]),a._v(" Docker安全清单")]),a._v(" "),s("h3",{attrs:{id:"主机安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主机安全"}},[a._v("#")]),a._v(" 主机安全")]),a._v(" "),s("ul",[s("li",[a._v("[ ] 保持主机操作系统更新")]),a._v(" "),s("li",[a._v("[ ] 使用最小化的主机操作系统")]),a._v(" "),s("li",[a._v("[ ] 配置主机防火墙")]),a._v(" "),s("li",[a._v("[ ] 启用SELinux或AppArmor")]),a._v(" "),s("li",[a._v("[ ] 限制对Docker套接字的访问")]),a._v(" "),s("li",[a._v("[ ] 配置Docker守护进程使用TLS")]),a._v(" "),s("li",[a._v("[ ] 禁用不必要的服务")])]),a._v(" "),s("h3",{attrs:{id:"镜像安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#镜像安全"}},[a._v("#")]),a._v(" 镜像安全")]),a._v(" "),s("ul",[s("li",[a._v("[ ] 使用官方或验证的基础镜像")]),a._v(" "),s("li",[a._v("[ ] 使用最小化的基础镜像")]),a._v(" "),s("li",[a._v("[ ] 定期更新基础镜像")]),a._v(" "),s("li",[a._v("[ ] 使用多阶段构建")]),a._v(" "),s("li",[a._v("[ ] 不在镜像中存储敏感信息")]),a._v(" "),s("li",[a._v("[ ] 扫描镜像中的漏洞")]),a._v(" "),s("li",[a._v("[ ] 使用Docker Content Trust签名镜像")])]),a._v(" "),s("h3",{attrs:{id:"容器运行时安全-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#容器运行时安全-2"}},[a._v("#")]),a._v(" 容器运行时安全")]),a._v(" "),s("ul",[s("li",[a._v("[ ] 以非root用户运行容器")]),a._v(" "),s("li",[a._v("[ ] 使用只读文件系统")]),a._v(" "),s("li",[a._v("[ ] 限制容器资源")]),a._v(" "),s("li",[a._v("[ ] 限制容器功能")]),a._v(" "),s("li",[a._v("[ ] 使用seccomp配置文件")]),a._v(" "),s("li",[a._v("[ ] 使用AppArmor或SELinux配置文件")]),a._v(" "),s("li",[a._v("[ ] 禁用特权容器")]),a._v(" "),s("li",[a._v("[ ] 使用--no-new-privileges标志")])]),a._v(" "),s("h3",{attrs:{id:"网络安全-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#网络安全-2"}},[a._v("#")]),a._v(" 网络安全")]),a._v(" "),s("ul",[s("li",[a._v("[ ] 使用用户定义的网络")]),a._v(" "),s("li",[a._v("[ ] 限制容器间通信")]),a._v(" "),s("li",[a._v("[ ] 仅发布必要的端口")]),a._v(" "),s("li",[a._v("[ ] 使用TLS加密网络通信")]),a._v(" "),s("li",[a._v("[ ] 使用内部网络隔离敏感服务")])]),a._v(" "),s("h3",{attrs:{id:"数据安全-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据安全-2"}},[a._v("#")]),a._v(" 数据安全")]),a._v(" "),s("ul",[s("li",[a._v("[ ] 使用卷管理持久数据")]),a._v(" "),s("li",[a._v("[ ] 加密敏感数据")]),a._v(" "),s("li",[a._v("[ ] 定期备份数据")]),a._v(" "),s("li",[a._v("[ ] 使用Docker Secrets管理敏感信息")])]),a._v(" "),s("h3",{attrs:{id:"监控和审计-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#监控和审计-2"}},[a._v("#")]),a._v(" 监控和审计")]),a._v(" "),s("ul",[s("li",[a._v("[ ] 配置容器日志记录")]),a._v(" "),s("li",[a._v("[ ] 设置主机和容器监控")]),a._v(" "),s("li",[a._v("[ ] 启用Docker审计")]),a._v(" "),s("li",[a._v("[ ] 定期审查安全策略和配置")])]),a._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("p",[a._v("Docker安全是一个多层面的挑战，需要从主机、镜像、容器运行时、网络和数据等多个方面进行考虑。通过实施本文介绍的最佳实践，您可以显著提高Docker环境的安全性，降低安全风险。")]),a._v(" "),s("p",[a._v("记住，安全是一个持续的过程，而不是一次性的工作。定期更新、监控、审计和改进您的Docker安全策略，以应对不断变化的安全威胁。")]),a._v(" "),s("h2",{attrs:{id:"下一步学习"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#下一步学习"}},[a._v("#")]),a._v(" 下一步学习")]),a._v(" "),s("ul",[s("li",[s("RouterLink",{attrs:{to:"/docker/docker-production.html"}},[a._v("Docker生产环境部署")])],1),a._v(" "),s("li",[s("RouterLink",{attrs:{to:"/docker/docker-swarm.html"}},[a._v("Docker Swarm集群")])],1),a._v(" "),s("li",[s("RouterLink",{attrs:{to:"/docker/docker-compose.html"}},[a._v("Docker Compose详解")])],1),a._v(" "),s("li",[s("RouterLink",{attrs:{to:"/docker/docker-volumes.html"}},[a._v("Docker数据卷管理")])],1)])])}),[],!1,null,null,null);s.default=r.exports}}]);