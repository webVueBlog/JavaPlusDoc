(window.webpackJsonp=window.webpackJsonp||[]).push([[356],{1172:function(t,s,v){"use strict";v.r(s);var _=v(1),a=Object(_.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"架构懂了就来了解数据库存储扩展千亿读写"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#架构懂了就来了解数据库存储扩展千亿读写"}},[t._v("#")]),t._v(" 架构懂了就来了解数据库存储扩展千亿读写")]),t._v(" "),s("h1",{attrs:{id:"一键可用的三档假设-你直接选"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一键可用的三档假设-你直接选"}},[t._v("#")]),t._v(" 一键可用的三档假设（你直接选）")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("档位")]),t._v(" "),s("th",{staticStyle:{"text-align":"right"}},[t._v("峰值写入 W (条/s)")]),t._v(" "),s("th",{staticStyle:{"text-align":"right"}},[t._v("单行大小 R (字节)")]),t._v(" "),s("th",{staticStyle:{"text-align":"right"}},[t._v("热数据保留 T (天)")]),t._v(" "),s("th",[t._v("适用场景")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("A 保守")]),t._v(" "),s("td",{staticStyle:{"text-align":"right"}},[t._v("50,000")]),t._v(" "),s("td",{staticStyle:{"text-align":"right"}},[t._v("200")]),t._v(" "),s("td",{staticStyle:{"text-align":"right"}},[t._v("30")]),t._v(" "),s("td",[t._v("早期 PoC / 小规模上线")])]),t._v(" "),s("tr",[s("td",[t._v("B 均衡（推荐）")]),t._v(" "),s("td",{staticStyle:{"text-align":"right"}},[t._v("200,000")]),t._v(" "),s("td",{staticStyle:{"text-align":"right"}},[t._v("300")]),t._v(" "),s("td",{staticStyle:{"text-align":"right"}},[t._v("30（热）+ 180（温）")]),t._v(" "),s("td",[t._v("典型 IoT/日志明细")])]),t._v(" "),s("tr",[s("td",[t._v("C 激进")]),t._v(" "),s("td",{staticStyle:{"text-align":"right"}},[t._v("1,000,000")]),t._v(" "),s("td",{staticStyle:{"text-align":"right"}},[t._v("500")]),t._v(" "),s("td",{staticStyle:{"text-align":"right"}},[t._v("30（热）+ 365（温）")]),t._v(" "),s("td",[t._v("海量设备/重分析")])])])]),t._v(" "),s("blockquote",[s("p",[t._v("说明："),s("strong",[t._v("热数据")]),t._v("放 OLTP/时序/列式集群用于线上与报表；"),s("strong",[t._v("温/冷数据")]),t._v("分层到 ClickHouse + 对象存储。")])]),t._v(" "),s("hr"),t._v(" "),s("h1",{attrs:{id:"关键资源测算-已算好-可直接用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关键资源测算-已算好-可直接用"}},[t._v("#")]),t._v(" 关键资源测算（已算好，可直接用）")]),t._v(" "),s("p",[t._v("（经验公式：Kafka 分区≈W/5k；OLTP 分片≈W/10k；Redis 分片≈(0.1×W)/50k；吞吐(MB/s)=W×R/1e6）")]),t._v(" "),s("h2",{attrs:{id:"a-保守-5-万写-s-200b-30-天"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#a-保守-5-万写-s-200b-30-天"}},[t._v("#")]),t._v(" A 保守（5 万写/s，200B，30 天）")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("Kafka")]),t._v("：≈ "),s("strong",[t._v("10 分区")]),t._v("（建议 3–4 台 broker 起步）")]),t._v(" "),s("li",[s("strong",[t._v("OLTP 分片")]),t._v("（MySQL+Vitess 或 TiDB）：≈ "),s("strong",[t._v("5 分片")])]),t._v(" "),s("li",[s("strong",[t._v("Redis Cluster")]),t._v("：≈ "),s("strong",[t._v("1 分片")]),t._v("（假设 10% 写入走状态存取）")]),t._v(" "),s("li",[s("strong",[t._v("入口吞吐")]),t._v("：≈ "),s("strong",[t._v("10 MB/s")])]),t._v(" "),s("li",[s("strong",[t._v("ClickHouse 存储")]),t._v("（仅热 30 天；压缩后≈原始/3）：≈ "),s("strong",[t._v("8.64 TB")]),t._v("（无副本）；"),s("strong",[t._v("RF=2")]),t._v("≈ "),s("strong",[t._v("17.28 TB")])])]),t._v(" "),s("h2",{attrs:{id:"b-均衡-20-万写-s-300b-热-30-天-温-180-天"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#b-均衡-20-万写-s-300b-热-30-天-温-180-天"}},[t._v("#")]),t._v(" B 均衡（20 万写/s，300B，热 30 天 + 温 180 天）")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("Kafka")]),t._v("：≈ "),s("strong",[t._v("40 分区")]),t._v("（建议 6–8 broker）")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("OLTP 分片")]),t._v("：≈ "),s("strong",[t._v("20 分片")]),t._v("（倾向 TiDB 降低运维复杂度）")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("Redis Cluster")]),t._v("：≈ "),s("strong",[t._v("1 分片")]),t._v("（0.1×W 假设）")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("入口吞吐")]),t._v("：≈ "),s("strong",[t._v("60 MB/s")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("ClickHouse（热 30 天）")]),t._v("：压缩后≈ "),s("strong",[t._v("51.84 TB")]),t._v("；"),s("strong",[t._v("RF=2")]),t._v("≈ "),s("strong",[t._v("103.68 TB")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("ClickHouse（温 180 天）")]),t._v("：压缩后≈ "),s("strong",[t._v("311.04 TB")]),t._v("；"),s("strong",[t._v("RF=2")]),t._v("≈ "),s("strong",[t._v("622.08 TB")])]),t._v(" "),s("blockquote",[s("p",[t._v("建议：温数据落"),s("strong",[t._v("分层存储")]),t._v("（HDD/对象存储 + S3 Cache），并用"),s("strong",[t._v("物化视图/预聚合")]),t._v("显著降体量。")])])])]),t._v(" "),s("h2",{attrs:{id:"c-激进-100-万写-s-500b-热-30-天-温-365-天"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#c-激进-100-万写-s-500b-热-30-天-温-365-天"}},[t._v("#")]),t._v(" C 激进（100 万写/s，500B，热 30 天 + 温 365 天）")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("Kafka")]),t._v("：≈ "),s("strong",[t._v("200 分区")]),t._v("（建议 12–16 broker）")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("OLTP 分片")]),t._v("：≈ "),s("strong",[t._v("100 分片")]),t._v("（强烈建议 TiDB/CockroachDB）")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("Redis Cluster")]),t._v("：≈ "),s("strong",[t._v("2 分片")]),t._v("（按 10% 写入估算）")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("入口吞吐")]),t._v("：≈ "),s("strong",[t._v("500 MB/s")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("ClickHouse（热 30 天）")]),t._v("：压缩后≈ "),s("strong",[t._v("144 TB")]),t._v("；"),s("strong",[t._v("RF=2")]),t._v("≈ "),s("strong",[t._v("288 TB")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("ClickHouse（温 365 天）")]),t._v("：压缩后≈ "),s("strong",[t._v("5,256 TB")]),t._v("；"),s("strong",[t._v("RF=2")]),t._v("≈ "),s("strong",[t._v("10,512 TB")])]),t._v(" "),s("blockquote",[s("p",[t._v("必须做"),s("strong",[t._v("冷热分层 + 强预聚合 + 近实时明细裁剪")]),t._v("（比如明细仅保留 7–14 天）。")])])])]),t._v(" "),s("hr"),t._v(" "),s("h1",{attrs:{id:"跨地域多活怎么选"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#跨地域多活怎么选"}},[t._v("#")]),t._v(" 跨地域多活怎么选？")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("不多活 / 同城双活")]),t._v("（推荐起步）：\n事务库同城多副本；Kafka 多 AZ；ClickHouse 分片跨 AZ。"),s("strong",[t._v("RPO≈0，RTO 分钟级")]),t._v("。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("异地灾备（Active-Passive）")]),t._v("：\n生产 Region 全量，异地 "),s("strong",[t._v("异步")]),t._v("复制（TiCDC/Debezium→Kafka→下游）。"),s("strong",[t._v("写延迟最低，RPO 秒级")]),t._v("。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("异地多活（Active-Active）")]),t._v("：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("强一致多活")]),t._v("（跨区共识）：写延迟受 RTT 影响，适合"),s("strong",[t._v("读多写少")]),t._v("或"),s("strong",[t._v("按业务键做就地写入")]),t._v("（CockroachDB/TiDB 多区域表位置信策）。")]),t._v(" "),s("li",[s("strong",[t._v("最终一致多活")]),t._v("（推荐 IoT）：每区本地落库 + "),s("strong",[t._v("Kafka Mirror")]),t._v(" 做跨区汇聚，"),s("strong",[t._v("冲突用业务键/时间戳解决")]),t._v("。写入延迟最低，但对一致性要求要“可最终一致”。")])])])]),t._v(" "),s("hr"),t._v(" "),s("h1",{attrs:{id:"现在就能落地的小蓝图-按-均衡档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#现在就能落地的小蓝图-按-均衡档"}},[t._v("#")]),t._v(" 现在就能落地的小蓝图（按“均衡档”）")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("入口")]),t._v("：Kafka（40 分区，acks=all，幂等生产者，压缩 lz4/zstd）")]),t._v(" "),s("li",[s("strong",[t._v("事务库")]),t._v("：TiDB（3 TiKV×N，按 20 分片规模起步；或 MySQL+Vitess 20 分片）")]),t._v(" "),s("li",[s("strong",[t._v("缓存")]),t._v("：Redis Cluster（起 3–6 节点，1–2 分片；Key 设计含哈希标签 "),s("code",[t._v("{deviceId}")]),t._v("）")]),t._v(" "),s("li",[s("strong",[t._v("分析")]),t._v("：ClickHouse（热 30 天：建议 4–6 分片×2 副本起步，分层存储）")]),t._v(" "),s("li",[s("strong",[t._v("CDC")]),t._v("：TiCDC/Debezium → Kafka → ClickHouse/ES/缓存回填")]),t._v(" "),s("li",[s("strong",[t._v("分区策略")]),t._v("：事务库按 "),s("code",[t._v("device_id, ts")]),t._v(" 复合主键 + "),s("strong",[t._v("按日/周分区")]),t._v("；CH "),s("code",[t._v("PARTITION BY toYYYYMMDD(ts) ORDER BY (device_id, ts)")]),t._v(" + TTL")])]),t._v(" "),s("h1",{attrs:{id:"目标拆解-两种常见场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#目标拆解-两种常见场景"}},[t._v("#")]),t._v(" 目标拆解（两种常见场景）")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("场景 A：1000 亿总数据量（长期沉淀）")]),t._v("\n例：IoT/日志/交易明细累计 1000 亿行。")]),t._v(" "),s("li",[s("strong",[t._v("场景 B：超高吞吐（持续写入/查询）")]),t._v("\n例：峰值 20–200 万条/秒写入，实时查询。")])]),t._v(" "),s("p",[t._v("下面给你可落地的架构与选型。")]),t._v(" "),s("h1",{attrs:{id:"架构蓝图-通用且好落地"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#架构蓝图-通用且好落地"}},[t._v("#")]),t._v(" 架构蓝图（通用且好落地）")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("入口层（写入解耦）")]),t._v("：Kafka / Pulsar（写入缓冲、削峰、重放、顺序性）")]),t._v(" "),s("li",[s("strong",[t._v("在线事务库（强一致、主业务）")]),t._v("：MySQL(分库分表/ Vitess) / PostgreSQL(Citus) / NewSQL（TiDB / CockroachDB / OceanBase）")]),t._v(" "),s("li",[s("strong",[t._v("热 Key/实时状态")]),t._v("：Redis Cluster / Aerospike / Scylla（KV 毫秒级读写）")]),t._v(" "),s("li",[s("strong",[t._v("时序/明细分析")]),t._v("：ClickHouse / Pinot / Druid（列式 + 分区，近实时 OLAP）")]),t._v(" "),s("li",[s("strong",[t._v("搜索")]),t._v("：OpenSearch / Elasticsearch（全文检索、模糊查）")]),t._v(" "),s("li",[s("strong",[t._v("CDC/数据流")]),t._v("：Debezium/TiCDC → Kafka → ClickHouse（离线与实时打通）")]),t._v(" "),s("li",[s("strong",[t._v("冷存/归档")]),t._v("：对象存储（S3/OSS/COS）+ 冷分区 TTL")])]),t._v(" "),s("blockquote",[s("p",[t._v("核心思想："),s("strong",[t._v("写入用日志（Kafka）解耦，OLTP 只做强一致交易，OLAP/时序做大吞吐分析，状态查询走 KV")]),t._v("。CQRS + 分层存储。")])]),t._v(" "),s("h1",{attrs:{id:"怎么选数据库-一句话攻略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#怎么选数据库-一句话攻略"}},[t._v("#")]),t._v(" 怎么选数据库（一句话攻略）")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("强一致交易")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("小规模先 MySQL 单机 → 读写分离 → 分库分表 → "),s("strong",[t._v("Vitess")]),t._v(" 或 "),s("strong",[t._v("ShardingSphere")]),t._v("。")]),t._v(" "),s("li",[t._v("一步到位选 "),s("strong",[t._v("TiDB/CockroachDB/OceanBase")]),t._v("（分布式事务、自动水平扩展）。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("超高写 & 时序/明细分析")]),t._v("："),s("strong",[t._v("ClickHouse")]),t._v("（MergeTree 家族）或 "),s("strong",[t._v("Pinot/Druid")]),t._v("。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("实时状态/排行榜/会话")]),t._v("："),s("strong",[t._v("Redis Cluster")]),t._v("（哈希槽、Pipeline、Lua 原子）。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("全文搜索")]),t._v("："),s("strong",[t._v("OpenSearch/ES")]),t._v("（注意写入背压、刷新间隔）。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("KV 超大规模且持久化")]),t._v("："),s("strong",[t._v("Aerospike/ScyllaDB")]),t._v("（低延迟、可持久化）。")])])]),t._v(" "),s("h1",{attrs:{id:"容量与分片估算-手把手"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#容量与分片估算-手把手"}},[t._v("#")]),t._v(" 容量与分片估算（手把手）")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("吞吐估算")]),t._v("：\n假设 1000 万设备、每分钟 1 次上报 → 10,000,000 / 60 ≈ "),s("strong",[t._v("166,666 次/秒")]),t._v(" 写入。")]),t._v(" "),s("li",[s("strong",[t._v("Kafka 分区数")]),t._v("（保守每分区 5k msg/s）：\n166,666 / 5,000 ≈ "),s("strong",[t._v("34 分区")]),t._v("（取 48/64 方便均衡）。")]),t._v(" "),s("li",[s("strong",[t._v("OLTP 分片数")]),t._v("（保守每分片 10k 写/s）：\n166,666 / 10,000 ≈ "),s("strong",[t._v("17 分片")]),t._v("（取 24），每分片主从复制。")]),t._v(" "),s("li",[s("strong",[t._v("存储估算")]),t._v("：\n1000 亿行 × 100B/行 ≈ "),s("strong",[t._v("10 TB 原始")]),t._v("；复制因子 3 → "),s("strong",[t._v("30 TB")]),t._v("；\n索引与额外列粗略 ×2 → "),s("strong",[t._v("~60 TB")]),t._v("（放在列式/对象存储更省）。")])]),t._v(" "),s("h1",{attrs:{id:"表设计与分区-示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#表设计与分区-示例"}},[t._v("#")]),t._v(" 表设计与分区（示例）")]),t._v(" "),s("p",[s("strong",[t._v("OLTP（TiDB/MySQL + Vitess）")]),t._v("：按业务键 + 时间分库分表，避免热点。")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 设备上报明细（事务库：写入 + 最近短期查询）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" device_event_202508 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  device_id    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ts           "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATETIME")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  evt_type     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TINYINT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  payload      JSON"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("device_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 复合主键，利于范围查询")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" RANGE "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COLUMNS")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" p20250801 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUES")]),t._v(" LESS THAN "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2025-08-02'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" p20250802 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUES")]),t._v(" LESS THAN "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2025-08-03'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 每日/每周分区，便于冷热分离与快速清理")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[s("strong",[t._v("时序/分析（ClickHouse）")]),t._v("：按天/周分区，排序键放查询维度。")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" events_local "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" CLUSTER cluster_3r3s\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  device_id  UInt64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ts         "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DateTime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  evt_type   UInt8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  v          Float64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  payload    String\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ReplicatedMergeTree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/clickhouse/tables/{shard}/events_local'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{replica}'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" toYYYYMMDD"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("device_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nTTL ts "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTERVAL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("180")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DAY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TO")]),t._v(" VOLUME "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cold'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 180 天后走冷存")]),t._v("\n")])])]),s("p",[s("strong",[t._v("Redis（热数据/状态）")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("Key 设计："),s("code",[t._v("dev:{deviceId}:stat")]),t._v("，哈希结构；")]),t._v(" "),s("li",[s("strong",[t._v("哈希标签")]),t._v("："),s("code",[t._v("{deviceId}")]),t._v(" 保证同一设备落同槽，降低跨槽多键操作；")]),t._v(" "),s("li",[t._v("开启 Pipeline、合理 "),s("code",[t._v("tcp-keepalive")]),t._v("，"),s("strong",[t._v("禁用")]),t._v("大 Lua 脚本长阻塞。")])]),t._v(" "),s("h1",{attrs:{id:"写入链路与幂等"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#写入链路与幂等"}},[t._v("#")]),t._v(" 写入链路与幂等")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("入口 → "),s("strong",[t._v("Kafka")]),t._v("（"),s("code",[t._v("acks=all")]),t._v("，幂等生产者，开启压缩）")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("消费入库")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("OLTP："),s("strong",[t._v("批量写")]),t._v("（500–1k 批），失败重试 + "),s("strong",[t._v("幂等键")]),t._v("（device_id+ts 或业务 id）；")]),t._v(" "),s("li",[t._v("分析："),s("strong",[t._v("Kafka → ClickHouse Kafka 引擎 / 自研 Sink")]),t._v("（大批量、列式友好）。")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("CDC")]),t._v("：OLTP 变更 → Debezium/TiCDC → Kafka → 下游（ES、ClickHouse、缓存回填）。")])])]),t._v(" "),s("h1",{attrs:{id:"查询路径-qps-高时要分层"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查询路径-qps-高时要分层"}},[t._v("#")]),t._v(" 查询路径（QPS 高时要分层）")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("强一致/交易查询")]),t._v(" → OLTP（MySQL/TiDB）")]),t._v(" "),s("li",[s("strong",[t._v("状态/排行榜/首页秒开")]),t._v(" → Redis")]),t._v(" "),s("li",[s("strong",[t._v("报表/聚合/多维分析")]),t._v(" → ClickHouse/Pinot（Pre-Aggregation + 物化视图）")]),t._v(" "),s("li",[s("strong",[t._v("搜索")]),t._v(" → OpenSearch（定时/实时索引）")])]),t._v(" "),s("h1",{attrs:{id:"典型配置要点-踩坑少"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#典型配置要点-踩坑少"}},[t._v("#")]),t._v(" 典型配置要点（踩坑少）")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("MySQL/InnoDB")]),t._v("："),s("code",[t._v("binlog_format=ROW")]),t._v("，"),s("code",[t._v("sync_binlog=1")]),t._v("（强一致）、"),s("code",[t._v("innodb_flush_log_at_trx_commit=1")]),t._v("；分表用 "),s("strong",[t._v("Vitess/ShardingSphere")]),t._v(" 管理路由。")]),t._v(" "),s("li",[s("strong",[t._v("PostgreSQL")]),t._v("：连接池 "),s("strong",[t._v("PgBouncer")]),t._v("，声明式分区，"),s("strong",[t._v("Citus")]),t._v(" 做分布式。")]),t._v(" "),s("li",[s("strong",[t._v("Kafka")]),t._v("："),s("code",[t._v("min.insync.replicas=2")]),t._v("（RF=3），保留策略基于时间/大小；消费者组 "),s("code",[t._v("max.poll.records")]),t._v(" 控制批量。")]),t._v(" "),s("li",[s("strong",[t._v("ClickHouse")]),t._v("：MergeTree 系列，"),s("code",[t._v("max_partitions_per_insert_block")]),t._v(" 合理；写入尽量大批；冷热分层 + TTL。")]),t._v(" "),s("li",[s("strong",[t._v("Redis")]),t._v("：Cluster，合理 "),s("code",[t._v("hash-max-ziplist-entries")]),t._v(" 等小对象优化，"),s("strong",[t._v("不要")]),t._v("在主线程做重型 Lua。")]),t._v(" "),s("li",[s("strong",[t._v("ES/OpenSearch")]),t._v("：写入用大批量 Bulk，降低刷新频率（"),s("code",[t._v("refresh_interval")]),t._v("），映射固定字段类型，避免动态映射爆炸。")])]),t._v(" "),s("h1",{attrs:{id:"分阶段扩容路线图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分阶段扩容路线图"}},[t._v("#")]),t._v(" 分阶段扩容路线图")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("Phase 0（< 每秒 2 万写）")]),t._v("：MySQL 主从 + Redis，ClickHouse 单集群小规模，Kafka 6–12 分区。")]),t._v(" "),s("li",[s("strong",[t._v("Phase 1（~10 万写/s）")]),t._v("：Vitess/TiDB/Citus 上线；Kafka 32–64 分区；ClickHouse 3–6 分片×3 副本；Redis Cluster 6–12 分片。")]),t._v(" "),s("li",[s("strong",[t._v("Phase 2（~20–50 万写/s）")]),t._v("：多 Region 同城双活/两地三中心；跨 Region 采用"),s("strong",[t._v("异步复制 + 最终一致")]),t._v("；ES/ClickHouse 做冷热分层与成本优化。")]),t._v(" "),s("li",[s("strong",[t._v("Phase 3（>50 万写/s & 1000 亿级总量）")]),t._v("：OLTP 只保留近 7–30 天，"),s("strong",[t._v("长期落列式 + 对象存储")]),t._v("；索引窄化；精细化限流与降级。")])]),t._v(" "),s("h1",{attrs:{id:"你现在就能用的最小闭环-结合你常用栈-java-kafka-redis-mysql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#你现在就能用的最小闭环-结合你常用栈-java-kafka-redis-mysql"}},[t._v("#")]),t._v(" 你现在就能用的最小闭环（结合你常用栈：Java + Kafka + Redis + MySQL）")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("Kafka")]),t._v(" 入口（分区按 "),s("code",[t._v("hash(deviceId)%N")]),t._v("，"),s("code",[t._v("acks=all")]),t._v("，幂等生产者）")]),t._v(" "),s("li",[s("strong",[t._v("MySQL → Vitess")]),t._v(" 或直接 "),s("strong",[t._v("TiDB")]),t._v(" 做事务与强一致")]),t._v(" "),s("li",[s("strong",[t._v("Redis Cluster")]),t._v(" 做设备实时状态/首页")]),t._v(" "),s("li",[s("strong",[t._v("ClickHouse")]),t._v(" 承接 Kafka 明细（近实时分析 + 报表）")]),t._v(" "),s("li",[s("strong",[t._v("CDC")]),t._v("（TiCDC/Debezium）把交易变更送到 Kafka，再同步到下游（ES/ClickHouse/缓存）")]),t._v(" "),s("li",[s("strong",[t._v("数据生命周期")]),t._v("：OLTP 仅保留近数据，ClickHouse 分区 + TTL，冷数据上云存储")])]),t._v(" "),s("h1",{attrs:{id:"反模式-尽量别踩"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#反模式-尽量别踩"}},[t._v("#")]),t._v(" 反模式（尽量别踩）")]),t._v(" "),s("ul",[s("li",[t._v("试图用 "),s("strong",[t._v("一个数据库")]),t._v(" 同时搞事务 + 高并发写 + 大规模分析")]),t._v(" "),s("li",[s("strong",[t._v("无分区")]),t._v("的大表：删除/归档会把库打爆")]),t._v(" "),s("li",[t._v("盲目 "),s("strong",[t._v("主从读扩")]),t._v(" 扛写入：写放大、复制延迟一来就炸")]),t._v(" "),s("li",[t._v("ES 当主库（事务一致性要求高的场景）")]),t._v(" "),s("li",[t._v("Redis 当数据库（需要强一致/持久就别这么干）")])])])}),[],!1,null,null,null);s.default=a.exports}}]);