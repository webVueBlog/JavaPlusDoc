(window.webpackJsonp=window.webpackJsonp||[]).push([[307],{1122:function(a,s,t){"use strict";t.r(s);var n=t(1),e=Object(n.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"docker-swarm集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-swarm集群"}},[a._v("#")]),a._v(" Docker Swarm集群")]),a._v(" "),s("h2",{attrs:{id:"什么是docker-swarm"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是docker-swarm"}},[a._v("#")]),a._v(" 什么是Docker Swarm")]),a._v(" "),s("p",[a._v("Docker Swarm是Docker的原生集群管理工具，它将多个Docker主机组合成一个虚拟的Docker主机，提供标准的Docker API，使得应用可以像在单个Docker主机上一样被部署到Swarm集群中。")]),a._v(" "),s("p",[a._v("Docker Swarm的主要特点：")]),a._v(" "),s("ul",[s("li",[s("strong",[a._v("分布式设计")]),a._v("：内置分布式设计，无单点故障")]),a._v(" "),s("li",[s("strong",[a._v("声明式服务模型")]),a._v("：使用声明式API定义服务的期望状态")]),a._v(" "),s("li",[s("strong",[a._v("服务扩展")]),a._v("：可以轻松扩展或缩减服务实例数量")]),a._v(" "),s("li",[s("strong",[a._v("服务发现")]),a._v("：内置服务发现机制，自动为服务分配DNS名称")]),a._v(" "),s("li",[s("strong",[a._v("负载均衡")]),a._v("：自动为服务提供负载均衡")]),a._v(" "),s("li",[s("strong",[a._v("滚动更新")]),a._v("：支持服务的滚动更新和回滚")]),a._v(" "),s("li",[s("strong",[a._v("安全通信")]),a._v("：节点间通信采用TLS加密，提供自动密钥轮换功能")])]),a._v(" "),s("h2",{attrs:{id:"swarm架构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#swarm架构"}},[a._v("#")]),a._v(" Swarm架构")]),a._v(" "),s("h3",{attrs:{id:"节点类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#节点类型"}},[a._v("#")]),a._v(" 节点类型")]),a._v(" "),s("p",[a._v("Swarm集群由两种类型的节点组成：")]),a._v(" "),s("ol",[s("li",[s("p",[s("strong",[a._v("管理节点（Manager Node）")]),a._v("：")]),a._v(" "),s("ul",[s("li",[a._v("维护集群状态")]),a._v(" "),s("li",[a._v("调度服务")]),a._v(" "),s("li",[a._v("提供Swarm API")]),a._v(" "),s("li",[a._v("可以配置为高可用模式（通常建议3、5或7个管理节点）")])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("工作节点（Worker Node）")]),a._v("：")]),a._v(" "),s("ul",[s("li",[a._v("执行容器")]),a._v(" "),s("li",[a._v("不参与集群管理决策")]),a._v(" "),s("li",[a._v("可以根据需要扩展")])])])]),a._v(" "),s("h3",{attrs:{id:"核心概念"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心概念"}},[a._v("#")]),a._v(" 核心概念")]),a._v(" "),s("ul",[s("li",[s("strong",[a._v("节点（Node）")]),a._v("：参与Swarm集群的Docker引擎实例")]),a._v(" "),s("li",[s("strong",[a._v("服务（Service）")]),a._v("：在Swarm上运行的任务的定义")]),a._v(" "),s("li",[s("strong",[a._v("任务（Task）")]),a._v("：调度到节点上的Docker容器实例")]),a._v(" "),s("li",[s("strong",[a._v("堆栈（Stack）")]),a._v("：一组相关服务，通常通过Compose文件定义")])]),a._v(" "),s("h2",{attrs:{id:"创建和管理swarm集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建和管理swarm集群"}},[a._v("#")]),a._v(" 创建和管理Swarm集群")]),a._v(" "),s("h3",{attrs:{id:"初始化swarm集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#初始化swarm集群"}},[a._v("#")]),a._v(" 初始化Swarm集群")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 初始化一个新的Swarm集群（在管理节点上执行）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm init --advertise-addr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("MANAGER-IP"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 输出将显示加入集群的命令，例如：")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# docker swarm join --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c 192.168.99.100:2377")]),a._v("\n")])])]),s("h3",{attrs:{id:"添加节点到集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加节点到集群"}},[a._v("#")]),a._v(" 添加节点到集群")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 获取加入集群的命令（在管理节点上执行）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 获取工作节点的加入命令")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm join-token worker\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 获取管理节点的加入命令")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm join-token manager\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在新节点上执行加入命令")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("join")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--token")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("TOKEN"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("MANAGER-IP"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(":2377\n")])])]),s("h3",{attrs:{id:"查看集群信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看集群信息"}},[a._v("#")]),a._v(" 查看集群信息")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看集群中的节点")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看节点详细信息")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" inspect "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 以可读格式查看节点信息")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" inspect "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--pretty")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])]),s("h3",{attrs:{id:"管理节点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#管理节点"}},[a._v("#")]),a._v(" 管理节点")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 提升工作节点为管理节点")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" promote "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 降级管理节点为工作节点")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" demote "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新节点")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置节点可用性")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--availability")]),a._v(" active"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v("pause"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v("drain "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 添加节点标签")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" update --label-add "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("datacenter")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("east "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除节点")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])]),s("h3",{attrs:{id:"离开swarm集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#离开swarm集群"}},[a._v("#")]),a._v(" 离开Swarm集群")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在工作节点上执行")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm leave\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在管理节点上执行（强制离开）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm leave "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--force")]),a._v("\n")])])]),s("h2",{attrs:{id:"服务管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务管理"}},[a._v("#")]),a._v(" 服务管理")]),a._v(" "),s("h3",{attrs:{id:"创建服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建服务"}},[a._v("#")]),a._v(" 创建服务")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建基本服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" my-web nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建带端口映射的服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" my-web "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--publish")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("8080")]),a._v(":80 nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建带环境变量的服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" my-db "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--env")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_ROOT_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("secret "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--env")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_DATABASE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("mydb "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  mysql:5.7\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建带卷的服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" my-db "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--mount")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("volume,source"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("db-data,target"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/lib/mysql "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  mysql:5.7\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建带约束的服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" my-web "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--constraint")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("node.role")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),a._v("worker "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--constraint")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("node.labels.datacenter")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),a._v("east "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建带资源限制的服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" my-web "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --limit-cpu "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0.5")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --limit-memory 512M "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  nginx\n")])])]),s("h3",{attrs:{id:"查看服务信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看服务信息"}},[a._v("#")]),a._v(" 查看服务信息")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 列出所有服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看服务详细信息")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" inspect "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("SERVICE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 以可读格式查看服务信息")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" inspect "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--pretty")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("SERVICE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看服务日志")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" logs "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("SERVICE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看服务任务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ps")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("SERVICE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])]),s("h3",{attrs:{id:"更新服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#更新服务"}},[a._v("#")]),a._v(" 更新服务")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新服务镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--image")]),a._v(" nginx:1.19 my-web\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 扩展服务实例数量")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" scale my-web"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 或者使用update命令扩展")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--replicas")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v(" my-web\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新端口映射")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" update --publish-add "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("8081")]),a._v(":80 my-web\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新环境变量")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" update --env-add "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("NODE_ENV")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("production my-web\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新挂载")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" update --mount-add "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("volume,source"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("new-data,target"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data my-web\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置滚动更新策略")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --update-parallelism "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --update-delay 10s "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  my-web\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 回滚服务更新")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rollback")]),a._v(" my-web\n")])])]),s("h3",{attrs:{id:"删除服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#删除服务"}},[a._v("#")]),a._v(" 删除服务")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" my-web\n")])])]),s("h2",{attrs:{id:"使用docker-stack部署应用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用docker-stack部署应用"}},[a._v("#")]),a._v(" 使用Docker Stack部署应用")]),a._v(" "),s("p",[a._v("Docker Stack允许使用Compose文件格式在Swarm上部署完整的应用程序堆栈。")]),a._v(" "),s("h3",{attrs:{id:"创建堆栈文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建堆栈文件"}},[a._v("#")]),a._v(" 创建堆栈文件")]),a._v(" "),s("p",[s("code",[a._v("docker-stack.yml")]),a._v("：")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'3.8'")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("web")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("latest\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"80:80"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("update_config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("parallelism")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("delay")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 10s\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("restart_policy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("condition")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("failure\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("placement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("constraints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" node.role == worker\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("visualizer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dockersamples/visualizer\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"8080:8080"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /var/run/docker.sock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/run/docker.sock\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("placement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("constraints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" node.role == manager\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("webnet")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("data-volume")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n")])])]),s("h3",{attrs:{id:"部署堆栈"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署堆栈"}},[a._v("#")]),a._v(" 部署堆栈")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 部署堆栈")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" stack deploy "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v(" docker-stack.yml my-app\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 列出所有堆栈")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" stack "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 列出堆栈中的服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" stack services my-app\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 列出堆栈中的任务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" stack "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ps")]),a._v(" my-app\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除堆栈")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" stack "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" my-app\n")])])]),s("h2",{attrs:{id:"swarm网络"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#swarm网络"}},[a._v("#")]),a._v(" Swarm网络")]),a._v(" "),s("p",[a._v("Swarm模式提供了多种网络驱动，用于不同的网络需求。")]),a._v(" "),s("h3",{attrs:{id:"覆盖网络-overlay-network"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#覆盖网络-overlay-network"}},[a._v("#")]),a._v(" 覆盖网络（Overlay Network）")]),a._v(" "),s("p",[a._v("覆盖网络允许不同节点上的容器相互通信。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建覆盖网络")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--driver")]),a._v(" overlay my-network\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建加密的覆盖网络")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--driver")]),a._v(" overlay "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--opt")]),a._v(" encrypted my-secure-network\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建服务并连接到覆盖网络")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" my-web "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--network")]),a._v(" my-network nginx\n")])])]),s("h3",{attrs:{id:"入口网络-ingress-network"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#入口网络-ingress-network"}},[a._v("#")]),a._v(" 入口网络（Ingress Network）")]),a._v(" "),s("p",[a._v("入口网络是一个特殊的覆盖网络，用于服务的负载均衡和路由网格。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看入口网络")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--filter")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("ingress\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 重新创建入口网络（如果需要）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" ingress\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--driver")]),a._v(" overlay "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--ingress")]),a._v(" ingress\n")])])]),s("h2",{attrs:{id:"swarm安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#swarm安全"}},[a._v("#")]),a._v(" Swarm安全")]),a._v(" "),s("h3",{attrs:{id:"tls配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tls配置"}},[a._v("#")]),a._v(" TLS配置")]),a._v(" "),s("p",[a._v("Swarm使用TLS进行节点间通信加密。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看当前TLS配置")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" info "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Swarm"')]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 轮换证书（在管理节点上执行）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm ca "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rotate")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看证书有效期")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm ca "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--quiet")]),a._v(" --cert-expiry\n")])])]),s("h3",{attrs:{id:"使用secrets管理敏感数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用secrets管理敏感数据"}},[a._v("#")]),a._v(" 使用Secrets管理敏感数据")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 从文件创建secret")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"mypassword"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" secret create db_password -\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 或者从文件创建")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" secret create db_password ./password.txt\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 列出secrets")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" secret "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看secret详情")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" secret inspect db_password\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建使用secret的服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" db "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--secret")]),a._v(" db_password "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--env")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_ROOT_PASSWORD_FILE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/run/secrets/db_password "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  mysql:5.7\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除secret")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" secret "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" db_password\n")])])]),s("h3",{attrs:{id:"使用configs管理配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用configs管理配置文件"}},[a._v("#")]),a._v(" 使用Configs管理配置文件")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 从文件创建config")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" config create nginx_conf ./nginx.conf\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 列出configs")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" config "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看config详情")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" config inspect nginx_conf\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建使用config的服务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" web "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--config")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("source")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("nginx_conf,target"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/etc/nginx/nginx.conf "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除config")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" config "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" nginx_conf\n")])])]),s("h2",{attrs:{id:"高可用性配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#高可用性配置"}},[a._v("#")]),a._v(" 高可用性配置")]),a._v(" "),s("h3",{attrs:{id:"管理节点高可用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#管理节点高可用"}},[a._v("#")]),a._v(" 管理节点高可用")]),a._v(" "),s("p",[a._v("为了实现高可用性，Swarm使用Raft共识算法，建议使用奇数个管理节点。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 推荐的管理节点数量：")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# - 3个管理节点可以容忍1个节点故障")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# - 5个管理节点可以容忍2个节点故障")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# - 7个管理节点可以容忍3个节点故障")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 添加管理节点")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm join-token manager\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 然后在新节点上执行返回的命令")]),a._v("\n")])])]),s("h3",{attrs:{id:"备份和恢复swarm状态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#备份和恢复swarm状态"}},[a._v("#")]),a._v(" 备份和恢复Swarm状态")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 备份Swarm状态（在管理节点上执行）")]),a._v("\nsystemctl stop "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-czvf")]),a._v(" swarm-backup.tar.gz /var/lib/docker/swarm\nsystemctl start "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 恢复Swarm状态")]),a._v("\nsystemctl stop "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-rf")]),a._v(" /var/lib/docker/swarm\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-xzvf")]),a._v(" swarm-backup.tar.gz "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" /var/lib/docker\nsystemctl start "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n")])])]),s("h2",{attrs:{id:"监控和日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#监控和日志"}},[a._v("#")]),a._v(" 监控和日志")]),a._v(" "),s("h3",{attrs:{id:"服务日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务日志"}},[a._v("#")]),a._v(" 服务日志")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看服务日志")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" logs my-service\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 实时查看日志")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" logs "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" my-service\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看最近的日志")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" logs "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tail")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("100")]),a._v(" my-service\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看特定时间段的日志")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" logs "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--since")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2020")]),a._v("-01-01T00:00:00 my-service\n")])])]),s("h3",{attrs:{id:"使用prometheus和grafana监控swarm"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用prometheus和grafana监控swarm"}},[a._v("#")]),a._v(" 使用Prometheus和Grafana监控Swarm")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'3.8'")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("prometheus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" prom/prometheus\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" ./prometheus.yml"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/etc/prometheus/prometheus.yml\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"9090:9090"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("placement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("constraints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" node.role == manager\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("node-exporter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" prom/node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("exporter\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /proc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/host/proc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/host/sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/rootfs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'--path.procfs=/host/proc'")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'--path.sysfs=/host/sys'")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("mode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" global\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cadvisor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" google/cadvisor\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/rootfs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /var/run"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/run"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("rw\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" /var/lib/docker/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/lib/docker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("ro\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"8080:8080"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("mode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" global\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("grafana")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" grafana/grafana\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"3000:3000"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" grafana"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/lib/grafana\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("placement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("constraints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" node.role == manager\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("grafana-data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n")])])]),s("h2",{attrs:{id:"实际应用示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实际应用示例"}},[a._v("#")]),a._v(" 实际应用示例")]),a._v(" "),s("h3",{attrs:{id:"部署web应用和数据库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署web应用和数据库"}},[a._v("#")]),a._v(" 部署Web应用和数据库")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'3.8'")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("web")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("latest\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"80:80"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("update_config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("parallelism")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("delay")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 10s\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("restart_policy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("condition")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("failure\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("placement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("constraints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" node.role == worker\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" webnet\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("api")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("api"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("latest\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("update_config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("parallelism")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("delay")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 10s\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("restart_policy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("condition")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("failure\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" DB_HOST=db\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" DB_USER=root\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" DB_PASSWORD_FILE=/run/secrets/db_password\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" DB_NAME=myapp\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" webnet\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" dbnet\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("secrets")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" db_password\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("db")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" mysql"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5.7")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("placement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("constraints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" node.labels.db == true\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/var/lib/mysql\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" MYSQL_ROOT_PASSWORD_FILE=/run/secrets/db_password\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" MYSQL_DATABASE=myapp\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" dbnet\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("secrets")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" db_password\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("webnet")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("dbnet")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("driver")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" overlay\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("internal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[a._v("true")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("db-data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("secrets")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("db_password")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("external")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[a._v("true")]),a._v("\n")])])]),s("h3",{attrs:{id:"蓝绿部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#蓝绿部署"}},[a._v("#")]),a._v(" 蓝绿部署")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'3.8'")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("blue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" myapp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1.0")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" frontend\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("green")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" myapp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2.0")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" frontend\n  \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("proxy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("latest\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"80:80"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" ./nginx.conf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/etc/nginx/nginx.conf\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("placement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("constraints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" node.role == manager\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" frontend\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("frontend")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n")])])]),s("p",[a._v("蓝绿切换：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 扩展绿色版本")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" scale my-app_green"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新Nginx配置指向绿色版本")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# ...")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 缩减蓝色版本")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" scale my-app_blue"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n")])])]),s("h2",{attrs:{id:"最佳实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#最佳实践"}},[a._v("#")]),a._v(" 最佳实践")]),a._v(" "),s("h3",{attrs:{id:"管理节点配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#管理节点配置"}},[a._v("#")]),a._v(" 管理节点配置")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("使用奇数个管理节点")]),a._v("：3、5或7个，以实现高可用性")]),a._v(" "),s("li",[s("strong",[a._v("限制管理节点数量")]),a._v("：不要超过7个管理节点，以避免共识性能下降")]),a._v(" "),s("li",[s("strong",[a._v("管理节点专用")]),a._v("：在生产环境中，考虑将管理节点设置为仅管理，不运行工作负载"),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--availability")]),a._v(" drain "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("MANAGER-NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])])])]),a._v(" "),s("h3",{attrs:{id:"服务部署策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务部署策略"}},[a._v("#")]),a._v(" 服务部署策略")]),a._v(" "),s("ol",[s("li",[s("p",[s("strong",[a._v("使用标签和约束")]),a._v("：根据节点特性分配服务")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 添加标签")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" update --label-add "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("ssd")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 使用约束")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--constraint")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("node.labels.ssd")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),a._v("true "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" db mysql:5.7\n")])])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("资源分配")]),a._v("：为服务设置资源限制")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create --limit-cpu "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0.5")]),a._v(" --limit-memory 512M "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" app myapp\n")])])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("滚动更新")]),a._v("：配置适当的更新策略")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --update-parallelism "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --update-delay 30s "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --update-failure-action rollback "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" web nginx\n")])])])])]),a._v(" "),s("h3",{attrs:{id:"网络安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#网络安全"}},[a._v("#")]),a._v(" 网络安全")]),a._v(" "),s("ol",[s("li",[s("p",[s("strong",[a._v("使用内部网络")]),a._v("：对于不需要外部访问的服务")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--driver")]),a._v(" overlay "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--internal")]),a._v(" db-network\n")])])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("加密覆盖网络")]),a._v("：对敏感数据传输")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--driver")]),a._v(" overlay "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--opt")]),a._v(" encrypted secure-network\n")])])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("使用Secrets")]),a._v("：管理敏感信息")])])]),a._v(" "),s("h3",{attrs:{id:"数据管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据管理"}},[a._v("#")]),a._v(" 数据管理")]),a._v(" "),s("ol",[s("li",[s("p",[s("strong",[a._v("使用命名卷")]),a._v("：确保数据持久化")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" create "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--mount")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("volume,source"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("db-data,target"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/lib/mysql "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" db mysql:5.7\n")])])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("备份策略")]),a._v("：定期备份关键数据")])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("考虑使用外部存储")]),a._v("：对于关键数据，考虑使用NFS、AWS EBS等")])])]),a._v(" "),s("h2",{attrs:{id:"常见问题与解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常见问题与解决方案"}},[a._v("#")]),a._v(" 常见问题与解决方案")]),a._v(" "),s("h3",{attrs:{id:"节点通信问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#节点通信问题"}},[a._v("#")]),a._v(" 节点通信问题")]),a._v(" "),s("p",[s("strong",[a._v("问题")]),a._v("：节点无法加入集群或节点间通信失败")]),a._v(" "),s("p",[s("strong",[a._v("解决方案")]),a._v("：")]),a._v(" "),s("ol",[s("li",[s("p",[a._v("检查防火墙设置，确保以下端口开放：")]),a._v(" "),s("ul",[s("li",[a._v("TCP 2377：集群管理通信")]),a._v(" "),s("li",[a._v("TCP/UDP 7946：节点间通信")]),a._v(" "),s("li",[a._v("UDP 4789：覆盖网络流量")])])]),a._v(" "),s("li",[s("p",[a._v("检查网络配置：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看Docker网络设置")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" info\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 重新初始化Swarm，指定正确的IP")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm init --advertise-addr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("CORRECT-IP"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])])])]),a._v(" "),s("h3",{attrs:{id:"服务无法启动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务无法启动"}},[a._v("#")]),a._v(" 服务无法启动")]),a._v(" "),s("p",[s("strong",[a._v("问题")]),a._v("：服务创建后无法启动或处于准备状态")]),a._v(" "),s("p",[s("strong",[a._v("解决方案")]),a._v("：")]),a._v(" "),s("ol",[s("li",[s("p",[a._v("检查服务日志：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" logs "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("SERVICE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])])]),a._v(" "),s("li",[s("p",[a._v("检查任务状态：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ps")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("SERVICE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])])]),a._v(" "),s("li",[s("p",[a._v("检查资源约束：")]),a._v(" "),s("ul",[s("li",[a._v("确保节点有足够的资源")]),a._v(" "),s("li",[a._v("检查服务的约束条件是否有节点满足")])])]),a._v(" "),s("li",[s("p",[a._v("检查镜像可用性：")]),a._v(" "),s("ul",[s("li",[a._v("确保所有节点都能访问镜像仓库")]),a._v(" "),s("li",[a._v("考虑预先在节点上拉取镜像")])])])]),a._v(" "),s("h3",{attrs:{id:"负载均衡问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡问题"}},[a._v("#")]),a._v(" 负载均衡问题")]),a._v(" "),s("p",[s("strong",[a._v("问题")]),a._v("：服务负载不均衡或路由网格不工作")]),a._v(" "),s("p",[s("strong",[a._v("解决方案")]),a._v("：")]),a._v(" "),s("ol",[s("li",[s("p",[a._v("检查入口网络：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network inspect ingress\n")])])])]),a._v(" "),s("li",[s("p",[a._v("确认端口发布正确：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("service")]),a._v(" inspect "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--format")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'{{.Endpoint.Ports}}'")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("SERVICE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])])]),a._v(" "),s("li",[s("p",[a._v("尝试重新创建入口网络：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" ingress\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--driver")]),a._v(" overlay "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--ingress")]),a._v(" ingress\n")])])])])]),a._v(" "),s("h3",{attrs:{id:"管理节点故障"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#管理节点故障"}},[a._v("#")]),a._v(" 管理节点故障")]),a._v(" "),s("p",[s("strong",[a._v("问题")]),a._v("：管理节点故障或无法访问")]),a._v(" "),s("p",[s("strong",[a._v("解决方案")]),a._v("：")]),a._v(" "),s("ol",[s("li",[s("p",[a._v("如果仍有法定数量的管理节点运行：")]),a._v(" "),s("ul",[s("li",[a._v("系统将自动恢复")]),a._v(" "),s("li",[a._v("可以移除故障节点："),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--force")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("NODE-ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])])])])]),a._v(" "),s("li",[s("p",[a._v("如果失去法定数量的管理节点：")]),a._v(" "),s("ul",[s("li",[a._v("需要强制恢复集群："),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在剩余的管理节点上")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" swarm init --force-new-cluster\n")])])])]),a._v(" "),s("li",[a._v("然后添加新的管理节点恢复冗余")])])])]),a._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("p",[a._v("Docker Swarm是一个强大的容器编排工具，提供了简单易用的集群管理功能。通过Swarm，您可以将多个Docker主机组合成一个虚拟的Docker主机，实现服务的高可用性、负载均衡和扩展。")]),a._v(" "),s("p",[a._v("Swarm的核心优势在于其与Docker紧密集成，使用标准Docker API，学习曲线平缓。对于中小规模的容器部署，Swarm提供了足够的功能和性能。")]),a._v(" "),s("p",[a._v("通过本文介绍的命令和最佳实践，您应该能够创建、管理和维护一个健壮的Docker Swarm集群，为您的应用提供可靠的运行环境。")]),a._v(" "),s("h2",{attrs:{id:"下一步学习"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#下一步学习"}},[a._v("#")]),a._v(" 下一步学习")]),a._v(" "),s("ul",[s("li",[s("RouterLink",{attrs:{to:"/docker/docker-security.html"}},[a._v("Docker安全最佳实践")])],1),a._v(" "),s("li",[s("RouterLink",{attrs:{to:"/docker/docker-compose.html"}},[a._v("Docker Compose详解")])],1),a._v(" "),s("li",[s("RouterLink",{attrs:{to:"/docker/docker-volumes.html"}},[a._v("Docker数据卷管理")])],1),a._v(" "),s("li",[s("RouterLink",{attrs:{to:"/docker/docker-production.html"}},[a._v("Docker生产环境部署")])],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);