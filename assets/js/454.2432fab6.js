(window.webpackJsonp=window.webpackJsonp||[]).push([[454],{1304:function(t,s,a){"use strict";a.r(s);var n=a(1),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("点击勘误"),s("a",{attrs:{href:"https://github.com/webVueBlog/JavaPlusDoc/issues",target:"_blank",rel:"noopener noreferrer"}},[t._v("issues"),s("OutboundLink")],1),t._v("，哪吒感谢大家的阅读")])]),t._v(" "),s("img",{attrs:{align:"right",width:"100",src:"https://cdn.jsdelivr.net/gh/YunYouJun/yun/images/yun-alpha-compressed.png"}}),t._v(" "),s("h1",{attrs:{id:"深入分析redis-lua脚本运行原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#深入分析redis-lua脚本运行原理"}},[t._v("#")]),t._v(" 深入分析Redis Lua脚本运行原理")]),t._v(" "),s("h2",{attrs:{id:"_1-lua脚本基础"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-lua脚本基础"}},[t._v("#")]),t._v(" 1. Lua脚本基础")]),t._v(" "),s("h3",{attrs:{id:"_1-1-什么是lua"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-什么是lua"}},[t._v("#")]),t._v(" 1.1 什么是Lua")]),t._v(" "),s("p",[t._v("Lua是一种轻量级、高效的脚本语言，设计目标是嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。Lua由标准C编写而成，几乎可以在所有操作系统和平台上运行。")]),t._v(" "),s("h3",{attrs:{id:"_1-2-lua的主要特性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-lua的主要特性"}},[t._v("#")]),t._v(" 1.2 Lua的主要特性")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("轻量级")]),t._v("：Lua解释器只有约200KB")]),t._v(" "),s("li",[s("strong",[t._v("高效性")]),t._v("：Lua的执行速度在脚本语言中名列前茅")]),t._v(" "),s("li",[s("strong",[t._v("可嵌入性")]),t._v("：易于嵌入到其他语言和应用中")]),t._v(" "),s("li",[s("strong",[t._v("简洁的语法")]),t._v("：语法简单易学")]),t._v(" "),s("li",[s("strong",[t._v("动态类型")]),t._v("：变量不需要类型定义")]),t._v(" "),s("li",[s("strong",[t._v("自动内存管理")]),t._v("：内置垃圾回收")]),t._v(" "),s("li",[s("strong",[t._v("函数式编程特性")]),t._v("：函数是一等公民")])]),t._v(" "),s("h3",{attrs:{id:"_1-3-lua在redis中的基本语法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-lua在redis中的基本语法"}},[t._v("#")]),t._v(" 1.3 Lua在Redis中的基本语法")]),t._v(" "),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 这是单行注释")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--[[\n这是多行注释\n可以跨越多行\n--]]")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 变量和赋值")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" x "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Redis"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 条件语句")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" x "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"大于5"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"小于等于5"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 循环")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" sum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v("\n    sum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" i\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 函数定义")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" a "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" b\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 表（Lua中的主要数据结构）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello"')]),t._v("\nt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"world"')]),t._v("\nt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"table example"')]),t._v("\n")])])]),s("h2",{attrs:{id:"_2-redis中的lua脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis中的lua脚本"}},[t._v("#")]),t._v(" 2. Redis中的Lua脚本")]),t._v(" "),s("h3",{attrs:{id:"_2-1-为什么redis需要lua脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-为什么redis需要lua脚本"}},[t._v("#")]),t._v(" 2.1 为什么Redis需要Lua脚本")]),t._v(" "),s("p",[t._v("Redis引入Lua脚本主要解决以下问题：")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("原子性操作")]),t._v("：Redis的单个命令是原子性的，但多个命令的组合不是。Lua脚本可以将多个操作打包成一个原子操作。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("减少网络开销")]),t._v("：使用脚本可以将多个命令一次性发送到Redis服务器，减少网络往返次数。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("复杂逻辑处理")]),t._v("：某些业务逻辑在客户端实现会很复杂，而使用Lua脚本可以在服务器端直接处理。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("提高性能")]),t._v("：将复杂操作放在服务器端执行，可以减少客户端与服务器之间的数据传输。")])])]),t._v(" "),s("h3",{attrs:{id:"_2-2-redis中执行lua脚本的命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-redis中执行lua脚本的命令"}},[t._v("#")]),t._v(" 2.2 Redis中执行Lua脚本的命令")]),t._v(" "),s("p",[t._v("Redis提供了两个主要命令来执行Lua脚本：")]),t._v(" "),s("h4",{attrs:{id:"_2-2-1-eval命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-eval命令"}},[t._v("#")]),t._v(" 2.2.1 EVAL命令")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("EVAL script numkeys key [key ...] arg [arg ...]\n")])])]),s("ul",[s("li",[s("strong",[t._v("script")]),t._v("：Lua脚本内容")]),t._v(" "),s("li",[s("strong",[t._v("numkeys")]),t._v("：键名参数的个数")]),t._v(" "),s("li",[s("strong",[t._v("key")]),t._v("：键名参数列表，在Lua脚本中通过KEYS[1], KEYS[2]等访问")]),t._v(" "),s("li",[s("strong",[t._v("arg")]),t._v("：附加参数列表，在Lua脚本中通过ARGV[1], ARGV[2]等访问")])]),t._v(" "),s("p",[t._v("示例：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('EVAL "return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}" 2 key1 key2 first second\n')])])]),s("h4",{attrs:{id:"_2-2-2-evalsha命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-evalsha命令"}},[t._v("#")]),t._v(" 2.2.2 EVALSHA命令")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("EVALSHA sha1 numkeys key [key ...] arg [arg ...]\n")])])]),s("ul",[s("li",[s("strong",[t._v("sha1")]),t._v("：脚本的SHA1校验和")]),t._v(" "),s("li",[t._v("其他参数与EVAL相同")])]),t._v(" "),s("p",[t._v("EVALSHA命令用于执行已经缓存在Redis服务器中的脚本，避免每次都传输完整的脚本内容。")]),t._v(" "),s("h4",{attrs:{id:"_2-2-3-脚本管理命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-3-脚本管理命令"}},[t._v("#")]),t._v(" 2.2.3 脚本管理命令")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("SCRIPT LOAD script")]),t._v("：将脚本加载到脚本缓存，但不执行")]),t._v(" "),s("li",[s("strong",[t._v("SCRIPT EXISTS sha1 [sha1 ...]")]),t._v("：检查脚本是否已缓存")]),t._v(" "),s("li",[s("strong",[t._v("SCRIPT FLUSH")]),t._v("：清空脚本缓存")]),t._v(" "),s("li",[s("strong",[t._v("SCRIPT KILL")]),t._v("：杀死当前正在运行的脚本")])]),t._v(" "),s("h2",{attrs:{id:"_3-redis-lua脚本的执行机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-redis-lua脚本的执行机制"}},[t._v("#")]),t._v(" 3. Redis Lua脚本的执行机制")]),t._v(" "),s("h3",{attrs:{id:"_3-1-lua环境初始化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-lua环境初始化"}},[t._v("#")]),t._v(" 3.1 Lua环境初始化")]),t._v(" "),s("p",[t._v("Redis在启动时会初始化一个Lua环境，这个环境是所有客户端共享的。Redis对这个Lua环境做了以下定制：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("沙箱化")]),t._v("：移除了可能造成安全问题的Lua标准库函数")]),t._v(" "),s("li",[s("strong",[t._v("添加Redis API")]),t._v("：提供了redis.call()和redis.pcall()等函数来执行Redis命令")]),t._v(" "),s("li",[s("strong",[t._v("随机数控制")]),t._v("：确保脚本的确定性执行")]),t._v(" "),s("li",[s("strong",[t._v("执行时间限制")]),t._v("：防止脚本执行时间过长")])]),t._v(" "),s("h3",{attrs:{id:"_3-2-脚本的加载与缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-脚本的加载与缓存"}},[t._v("#")]),t._v(" 3.2 脚本的加载与缓存")]),t._v(" "),s("p",[t._v("当Redis接收到EVAL命令时，会执行以下步骤：")]),t._v(" "),s("ol",[s("li",[t._v("计算脚本的SHA1校验和")]),t._v(" "),s("li",[t._v("检查脚本缓存中是否已存在该校验和")]),t._v(" "),s("li",[t._v("如果不存在，将脚本编译并存入缓存")]),t._v(" "),s("li",[t._v("执行脚本")])]),t._v(" "),s("p",[t._v("而EVALSHA命令则直接从第2步开始，如果缓存中不存在该校验和，会返回错误。")]),t._v(" "),s("h3",{attrs:{id:"_3-3-脚本执行流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-脚本执行流程"}},[t._v("#")]),t._v(" 3.3 脚本执行流程")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("参数传递")]),t._v("：将KEYS和ARGV参数传递给Lua环境")]),t._v(" "),s("li",[s("strong",[t._v("脚本执行")]),t._v("：在Lua环境中执行脚本")]),t._v(" "),s("li",[s("strong",[t._v("结果转换")]),t._v("：将Lua返回值转换为Redis协议格式")]),t._v(" "),s("li",[s("strong",[t._v("返回结果")]),t._v("：将结果返回给客户端")])]),t._v(" "),s("h3",{attrs:{id:"_3-4-redis与lua的数据类型映射"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-redis与lua的数据类型映射"}},[t._v("#")]),t._v(" 3.4 Redis与Lua的数据类型映射")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("Redis类型")]),t._v(" "),s("th",[t._v("Lua类型")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("整数")]),t._v(" "),s("td",[t._v("数值")])]),t._v(" "),s("tr",[s("td",[t._v("字符串")]),t._v(" "),s("td",[t._v("字符串")])]),t._v(" "),s("tr",[s("td",[t._v("列表")]),t._v(" "),s("td",[t._v("表")])]),t._v(" "),s("tr",[s("td",[t._v("哈希表")]),t._v(" "),s("td",[t._v("表")])]),t._v(" "),s("tr",[s("td",[t._v("集合")]),t._v(" "),s("td",[t._v("表")])]),t._v(" "),s("tr",[s("td",[t._v("有序集合")]),t._v(" "),s("td",[t._v("表")])]),t._v(" "),s("tr",[s("td",[t._v("NULL")]),t._v(" "),s("td",[t._v("false")])])])]),t._v(" "),s("h2",{attrs:{id:"_4-lua脚本的原子性与事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-lua脚本的原子性与事务"}},[t._v("#")]),t._v(" 4. Lua脚本的原子性与事务")]),t._v(" "),s("h3",{attrs:{id:"_4-1-原子性保证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-原子性保证"}},[t._v("#")]),t._v(" 4.1 原子性保证")]),t._v(" "),s("p",[t._v("Redis保证Lua脚本的原子性，即脚本执行期间，不会有其他脚本或命令执行。这是通过以下机制实现的：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("单线程执行")]),t._v("：Redis的单线程模型确保同一时间只有一个命令在执行")]),t._v(" "),s("li",[s("strong",[t._v("脚本不可中断")]),t._v("：一旦脚本开始执行，除非使用SCRIPT KILL命令（且脚本未执行写操作），否则不能中断")])]),t._v(" "),s("h3",{attrs:{id:"_4-2-与multi-exec事务的比较"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-与multi-exec事务的比较"}},[t._v("#")]),t._v(" 4.2 与MULTI/EXEC事务的比较")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("特性")]),t._v(" "),s("th",[t._v("Lua脚本")]),t._v(" "),s("th",[t._v("MULTI/EXEC事务")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("原子性")]),t._v(" "),s("td",[t._v("支持")]),t._v(" "),s("td",[t._v("支持")])]),t._v(" "),s("tr",[s("td",[t._v("隔离性")]),t._v(" "),s("td",[t._v("支持")]),t._v(" "),s("td",[t._v("支持")])]),t._v(" "),s("tr",[s("td",[t._v("条件判断")]),t._v(" "),s("td",[t._v("支持")]),t._v(" "),s("td",[t._v("不支持（WATCH命令提供乐观锁）")])]),t._v(" "),s("tr",[s("td",[t._v("复杂逻辑")]),t._v(" "),s("td",[t._v("支持")]),t._v(" "),s("td",[t._v("不支持")])]),t._v(" "),s("tr",[s("td",[t._v("性能")]),t._v(" "),s("td",[t._v("较高")]),t._v(" "),s("td",[t._v("较低（多次网络往返）")])])])]),t._v(" "),s("h3",{attrs:{id:"_4-3-脚本超时处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-脚本超时处理"}},[t._v("#")]),t._v(" 4.3 脚本超时处理")]),t._v(" "),s("p",[t._v("Redis默认不允许脚本执行时间超过一定限制（可通过lua-time-limit配置）。当脚本执行时间过长时：")]),t._v(" "),s("ol",[s("li",[t._v("Redis服务器会开始接受SCRIPT KILL和SHUTDOWN NOSAVE命令")]),t._v(" "),s("li",[t._v("如果脚本未执行写操作，可以使用SCRIPT KILL终止脚本")]),t._v(" "),s("li",[t._v("如果脚本已执行写操作，只能使用SHUTDOWN NOSAVE关闭服务器")])]),t._v(" "),s("h2",{attrs:{id:"_5-lua脚本的性能优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-lua脚本的性能优化"}},[t._v("#")]),t._v(" 5. Lua脚本的性能优化")]),t._v(" "),s("h3",{attrs:{id:"_5-1-性能优势"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-性能优势"}},[t._v("#")]),t._v(" 5.1 性能优势")]),t._v(" "),s("p",[t._v("Lua脚本相比于客户端执行多个命令有以下性能优势：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("减少网络往返")]),t._v("：一次网络请求完成多个操作")]),t._v(" "),s("li",[s("strong",[t._v("减少上下文切换")]),t._v("：服务器端一次性执行所有操作")]),t._v(" "),s("li",[s("strong",[t._v("原子性保证")]),t._v("：无需使用WATCH/MULTI/EXEC等机制")])]),t._v(" "),s("h3",{attrs:{id:"_5-2-性能优化技巧"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-性能优化技巧"}},[t._v("#")]),t._v(" 5.2 性能优化技巧")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("使用EVALSHA代替EVAL")]),t._v("：减少脚本传输开销")]),t._v(" "),s("li",[s("strong",[t._v("最小化脚本复杂度")]),t._v("：保持脚本简单高效")]),t._v(" "),s("li",[s("strong",[t._v("避免长时间运行")]),t._v("：脚本执行会阻塞Redis服务器")]),t._v(" "),s("li",[s("strong",[t._v("合理使用redis.call和redis.pcall")]),t._v("：redis.pcall会捕获错误但性能略低")]),t._v(" "),s("li",[s("strong",[t._v("预加载常用脚本")]),t._v("：使用SCRIPT LOAD预加载常用脚本")])]),t._v(" "),s("h3",{attrs:{id:"_5-3-常见性能陷阱"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-常见性能陷阱"}},[t._v("#")]),t._v(" 5.3 常见性能陷阱")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("无限循环")]),t._v("：脚本中的无限循环会导致Redis服务器阻塞")]),t._v(" "),s("li",[s("strong",[t._v("大量数据处理")]),t._v("：在脚本中处理大量数据会消耗大量内存和CPU")]),t._v(" "),s("li",[s("strong",[t._v("频繁调用redis.call")]),t._v("：每次调用都有开销，应尽量减少调用次数")]),t._v(" "),s("li",[s("strong",[t._v("复杂计算")]),t._v("：Lua不适合进行复杂计算，应将复杂计算放在客户端")])]),t._v(" "),s("h2",{attrs:{id:"_6-lua脚本的实际应用场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-lua脚本的实际应用场景"}},[t._v("#")]),t._v(" 6. Lua脚本的实际应用场景")]),t._v(" "),s("h3",{attrs:{id:"_6-1-计数器和限流器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-计数器和限流器"}},[t._v("#")]),t._v(" 6.1 计数器和限流器")]),t._v(" "),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 简单的限流器：每个用户每分钟最多访问10次")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" user_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" current_time "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" time_window "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 60秒")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" max_requests "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 清理过期的访问记录")]),t._v("\nredis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ZREMRANGEBYSCORE"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" current_time "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" time_window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 获取当前时间窗口内的访问次数")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ZCARD"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" max_requests "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 记录本次访问")]),t._v("\n    redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ZADD"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" current_time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" current_time "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('":"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v(" math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("random")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 允许访问")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 拒绝访问")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),s("h3",{attrs:{id:"_6-2-分布式锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-分布式锁"}},[t._v("#")]),t._v(" 6.2 分布式锁")]),t._v(" "),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 获取锁")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" lock_key "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" lock_value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 通常是一个唯一标识符")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" ttl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 锁的过期时间")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SET"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lock_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lock_value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"NX"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PX"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ttl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 获取锁成功")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 获取锁失败")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 释放锁（确保只有锁的持有者才能释放锁）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" lock_key "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" lock_value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lock_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" lock_value "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"DEL"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lock_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),s("h3",{attrs:{id:"_6-3-原子性计数器更新"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-原子性计数器更新"}},[t._v("#")]),t._v(" 6.3 原子性计数器更新")]),t._v(" "),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 原子性地更新多个计数器")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" counter1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" counter2 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" counter3 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" increment "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nredis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INCRBY"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" counter1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" increment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nredis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INCRBY"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" counter2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" increment "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nredis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INCRBY"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" counter3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" increment "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" counter1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" counter2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" counter3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"_6-4-复杂数据结构操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-复杂数据结构操作"}},[t._v("#")]),t._v(" 6.4 复杂数据结构操作")]),t._v(" "),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 在有序集合中查找并更新元素")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" zset_key "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" member "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" new_score "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" current_score "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ZSCORE"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" zset_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" member"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" current_score "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 元素存在，更新分数")]),t._v("\n    redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ZADD"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" zset_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" new_score"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" member"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" new_score "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current_score"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 元素不存在，添加新元素")]),t._v("\n    redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ZADD"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" zset_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" new_score"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" member"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" new_score"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),s("h2",{attrs:{id:"_7-lua脚本的调试与测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-lua脚本的调试与测试"}},[t._v("#")]),t._v(" 7. Lua脚本的调试与测试")]),t._v(" "),s("h3",{attrs:{id:"_7-1-调试技巧"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-调试技巧"}},[t._v("#")]),t._v(" 7.1 调试技巧")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("使用redis.log")]),t._v("：在脚本中使用redis.log()函数记录调试信息")]),t._v(" "),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[t._v("redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("LOG_WARNING"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Debug: value = "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tostring")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("分步测试")]),t._v("：将复杂脚本分解为简单步骤，逐步测试")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("使用redis-cli --eval")]),t._v("：redis-cli提供了--eval选项来执行Lua脚本文件")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("redis-cli "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--eval")]),t._v(" script.lua key1 key2 , arg1 arg2\n")])])])])]),t._v(" "),s("h3",{attrs:{id:"_7-2-常见错误及解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-常见错误及解决方案"}},[t._v("#")]),t._v(" 7.2 常见错误及解决方案")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("语法错误")]),t._v("：检查Lua语法，特别是括号、引号和关键字")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("类型错误")]),t._v("：确保数据类型转换正确，特别是字符串和数字之间的转换")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("键不存在")]),t._v("：处理键不存在的情况，使用条件判断")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("脚本超时")]),t._v("：优化脚本性能，避免长时间运行")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("内存溢出")]),t._v("：控制数据量，避免在脚本中处理大量数据")])])]),t._v(" "),s("h3",{attrs:{id:"_7-3-单元测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-单元测试"}},[t._v("#")]),t._v(" 7.3 单元测试")]),t._v(" "),s("p",[t._v("可以使用以下方法对Lua脚本进行单元测试：")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("使用测试框架")]),t._v("：如Busted（Lua测试框架）")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("模拟Redis环境")]),t._v("：创建模拟的redis.call和redis.pcall函数")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("集成测试")]),t._v("：在实际Redis环境中测试脚本")])])]),t._v(" "),s("h2",{attrs:{id:"_8-lua脚本的最佳实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-lua脚本的最佳实践"}},[t._v("#")]),t._v(" 8. Lua脚本的最佳实践")]),t._v(" "),s("h3",{attrs:{id:"_8-1-安全性考虑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-安全性考虑"}},[t._v("#")]),t._v(" 8.1 安全性考虑")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("避免使用外部输入")]),t._v("：不要直接将用户输入作为脚本内容")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("限制脚本权限")]),t._v("：使用redis.replicate_commands()控制脚本复制行为")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("设置执行时间限制")]),t._v("：配置lua-time-limit参数")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("避免敏感操作")]),t._v("：不要在脚本中执行FLUSHALL、SHUTDOWN等敏感命令")])])]),t._v(" "),s("h3",{attrs:{id:"_8-2-可维护性建议"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-可维护性建议"}},[t._v("#")]),t._v(" 8.2 可维护性建议")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("添加注释")]),t._v("：详细注释脚本功能和逻辑")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("模块化")]),t._v("：将复杂脚本分解为小型、可重用的函数")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("版本控制")]),t._v("：使用版本控制系统管理脚本")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("文档化")]),t._v("：记录脚本的用途、参数和返回值")])])]),t._v(" "),s("h3",{attrs:{id:"_8-3-部署策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-部署策略"}},[t._v("#")]),t._v(" 8.3 部署策略")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("预加载脚本")]),t._v("：在应用启动时预加载常用脚本")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("脚本管理")]),t._v("：使用工具或框架管理脚本")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("监控脚本执行")]),t._v("：监控脚本执行时间和资源消耗")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("灰度发布")]),t._v("：新脚本先在测试环境验证，再逐步部署到生产环境")])])]),t._v(" "),s("h2",{attrs:{id:"_9-redis-lua脚本与redis模块的比较"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-redis-lua脚本与redis模块的比较"}},[t._v("#")]),t._v(" 9. Redis Lua脚本与Redis模块的比较")]),t._v(" "),s("h3",{attrs:{id:"_9-1-lua脚本的局限性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-lua脚本的局限性"}},[t._v("#")]),t._v(" 9.1 Lua脚本的局限性")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("功能受限")]),t._v("：只能使用Redis提供的API")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("性能限制")]),t._v("：复杂计算会影响Redis性能")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("调试困难")]),t._v("：缺乏完善的调试工具")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("无状态")]),t._v("：每次执行都是独立的，无法保存状态")])])]),t._v(" "),s("h3",{attrs:{id:"_9-2-redis模块的优势"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-redis模块的优势"}},[t._v("#")]),t._v(" 9.2 Redis模块的优势")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("更高性能")]),t._v("：C语言编写，直接访问Redis内部API")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("功能更强")]),t._v("：可以实现更复杂的功能")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("可以保存状态")]),t._v("：模块可以维护自己的状态")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("更好的集成")]),t._v("：可以与Redis核心功能更紧密集成")])])]),t._v(" "),s("h3",{attrs:{id:"_9-3-选择建议"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-3-选择建议"}},[t._v("#")]),t._v(" 9.3 选择建议")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("使用Lua脚本")]),t._v("：简单的原子操作、临时性需求、不需要高性能")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("使用Redis模块")]),t._v("：复杂功能、高性能需求、需要保存状态、长期使用")])])]),t._v(" "),s("h2",{attrs:{id:"_10-实战案例-基于lua脚本的秒杀系统"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_10-实战案例-基于lua脚本的秒杀系统"}},[t._v("#")]),t._v(" 10. 实战案例：基于Lua脚本的秒杀系统")]),t._v(" "),s("h3",{attrs:{id:"_10-1-需求分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_10-1-需求分析"}},[t._v("#")]),t._v(" 10.1 需求分析")]),t._v(" "),s("p",[t._v("秒杀系统需要解决的核心问题：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("并发控制")]),t._v("：防止超卖")]),t._v(" "),s("li",[s("strong",[t._v("性能要求")]),t._v("：高并发、低延迟")]),t._v(" "),s("li",[s("strong",[t._v("防重复购买")]),t._v("：一个用户只能购买一次")]),t._v(" "),s("li",[s("strong",[t._v("库存实时性")]),t._v("：库存数据需要实时准确")])]),t._v(" "),s("h3",{attrs:{id:"_10-2-lua脚本实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_10-2-lua脚本实现"}},[t._v("#")]),t._v(" 10.2 Lua脚本实现")]),t._v(" "),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 秒杀脚本")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- KEYS[1]: 商品库存key")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- KEYS[2]: 已购买用户集合key")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- ARGV[1]: 用户ID")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- ARGV[2]: 购买数量")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" stock_key "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" purchased_users_key "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" user_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" quantity "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 检查用户是否已购买")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SISMEMBER"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" purchased_users_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"用户已购买"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 检查库存")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stock_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" quantity "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"库存不足"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 扣减库存并记录用户购买")]),t._v("\nredis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"DECRBY"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stock_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" quantity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nredis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SADD"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" purchased_users_key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 返回成功和剩余库存")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" quantity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"_10-3-java客户端调用示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_10-3-java客户端调用示例"}},[t._v("#")]),t._v(" 10.3 Java客户端调用示例")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clients"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jedis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Jedis")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clients"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jedis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JedisPool")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Arrays")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SecKillService")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JedisPool")]),t._v(" jedisPool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" stockKey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"product:stock:"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" purchasedUsersKey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"product:purchased:users:"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" secKillScript"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" secKillScriptSha1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SecKillService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JedisPool")]),t._v(" jedisPool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jedisPool "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" jedisPool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 秒杀脚本")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("secKillScript "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n            local stock_key = KEYS[1]\n            local purchased_users_key = KEYS[2]\n            local user_id = ARGV[1]\n            local quantity = tonumber(ARGV[2])\n\n            if redis.call("SISMEMBER", purchased_users_key, user_id) == 1 then\n                return {0, "用户已购买"}\n            end\n\n            local stock = tonumber(redis.call("GET", stock_key) or "0")\n            if stock < quantity then\n                return {0, "库存不足"}\n            end\n\n            redis.call("DECRBY", stock_key, quantity)\n            redis.call("SADD", purchased_users_key, user_id)\n\n            return {1, stock - quantity}\n        """')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        \n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 预加载脚本")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Jedis")]),t._v(" jedis "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" jedisPool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("secKillScriptSha1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" jedis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scriptLoad")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("secKillScript"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("secKill")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" productId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" userId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" quantity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Jedis")]),t._v(" jedis "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" jedisPool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" stockKey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stockKey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" productId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" purchasedUsersKey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("purchasedUsersKey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" productId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            \n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行秒杀脚本")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" result "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" jedis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("evalsha")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                secKillScriptSha1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Arrays")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("asList")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stockKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" purchasedUsersKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Arrays")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("asList")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("valueOf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("quantity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            \n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 解析结果")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" resultList "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" resultList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1L")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            \n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printStackTrace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"_10-4-性能分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_10-4-性能分析"}},[t._v("#")]),t._v(" 10.4 性能分析")]),t._v(" "),s("p",[t._v("使用Lua脚本实现秒杀系统的性能优势：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("原子性操作")]),t._v("：库存检查、扣减和用户记录在一个原子操作中完成")]),t._v(" "),s("li",[s("strong",[t._v("减少网络往返")]),t._v("：一次网络请求完成所有操作")]),t._v(" "),s("li",[s("strong",[t._v("服务器端处理")]),t._v("：逻辑在Redis服务器端执行，减轻应用服务器负担")]),t._v(" "),s("li",[s("strong",[t._v("高并发支持")]),t._v("：Redis单线程模型能高效处理并发请求")])]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("Redis Lua脚本是Redis提供的一种强大功能，它允许开发者在Redis服务器端执行Lua脚本，实现复杂的原子操作。通过深入理解Lua脚本的运行原理，开发者可以更好地利用这一功能，提高应用性能，简化业务逻辑实现。")]),t._v(" "),s("p",[t._v("在实际应用中，Lua脚本特别适合需要原子性操作、减少网络往返、实现复杂逻辑的场景。但同时也需要注意脚本的性能优化、安全性和可维护性，避免影响Redis服务器的正常运行。")]),t._v(" "),s("p",[t._v("随着Redis的不断发展，Lua脚本功能也在不断完善，成为Redis生态系统中不可或缺的一部分。掌握Redis Lua脚本的运行原理和最佳实践，将帮助开发者更好地利用Redis解决实际问题。")])])}),[],!1,null,null,null);s.default=r.exports}}]);