(window.webpackJsonp=window.webpackJsonp||[]).push([[300],{1117:function(s,t,a){"use strict";a.r(t);var r=a(1),n=Object(r.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"dockerfile最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile最佳实践"}},[s._v("#")]),s._v(" Dockerfile最佳实践")]),s._v(" "),t("h2",{attrs:{id:"dockerfile基础"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile基础"}},[s._v("#")]),s._v(" Dockerfile基础")]),s._v(" "),t("h3",{attrs:{id:"什么是dockerfile"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是dockerfile"}},[s._v("#")]),s._v(" 什么是Dockerfile")]),s._v(" "),t("p",[s._v("Dockerfile是一个文本文件，包含了一系列指令和参数，用于自动构建Docker镜像。通过Dockerfile，您可以定义镜像的基础环境、安装软件包、配置环境变量、暴露端口等，实现镜像构建过程的自动化和标准化。")]),s._v(" "),t("h3",{attrs:{id:"dockerfile的基本结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile的基本结构"}},[s._v("#")]),s._v(" Dockerfile的基本结构")]),s._v(" "),t("p",[s._v("Dockerfile由一系列指令组成，每条指令都会创建一个新的镜像层。基本结构如下：")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注释")]),s._v("\nINSTRUCTION arguments\n")])])]),t("p",[s._v("常用的Dockerfile指令包括：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("指令")]),s._v(" "),t("th",[s._v("描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("FROM")]),s._v(" "),t("td",[s._v("指定基础镜像")])]),s._v(" "),t("tr",[t("td",[s._v("LABEL")]),s._v(" "),t("td",[s._v("添加元数据（如维护者信息）")])]),s._v(" "),t("tr",[t("td",[s._v("RUN")]),s._v(" "),t("td",[s._v("执行命令")])]),s._v(" "),t("tr",[t("td",[s._v("COPY/ADD")]),s._v(" "),t("td",[s._v("复制文件到镜像中")])]),s._v(" "),t("tr",[t("td",[s._v("WORKDIR")]),s._v(" "),t("td",[s._v("设置工作目录")])]),s._v(" "),t("tr",[t("td",[s._v("ENV")]),s._v(" "),t("td",[s._v("设置环境变量")])]),s._v(" "),t("tr",[t("td",[s._v("EXPOSE")]),s._v(" "),t("td",[s._v("声明容器监听的端口")])]),s._v(" "),t("tr",[t("td",[s._v("VOLUME")]),s._v(" "),t("td",[s._v("创建挂载点")])]),s._v(" "),t("tr",[t("td",[s._v("USER")]),s._v(" "),t("td",[s._v("指定运行容器时的用户")])]),s._v(" "),t("tr",[t("td",[s._v("CMD")]),s._v(" "),t("td",[s._v("指定容器启动时执行的命令")])]),s._v(" "),t("tr",[t("td",[s._v("ENTRYPOINT")]),s._v(" "),t("td",[s._v("指定容器启动时执行的入口点")])])])]),s._v(" "),t("h3",{attrs:{id:"构建和运行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建和运行"}},[s._v("#")]),s._v(" 构建和运行")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建镜像")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" build "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" myapp:1.0 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行容器")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":80 myapp:1.0\n")])])]),t("h2",{attrs:{id:"dockerfile最佳实践-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile最佳实践-2"}},[s._v("#")]),s._v(" Dockerfile最佳实践")]),s._v(" "),t("h3",{attrs:{id:"使用合适的基础镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用合适的基础镜像"}},[s._v("#")]),s._v(" 使用合适的基础镜像")]),s._v(" "),t("p",[s._v("选择合适的基础镜像对于构建高效、安全的Docker镜像至关重要。")]),s._v(" "),t("h4",{attrs:{id:"官方镜像优先"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#官方镜像优先"}},[s._v("#")]),s._v(" 官方镜像优先")]),s._v(" "),t("p",[s._v("优先使用Docker Hub上的官方镜像，这些镜像通常由软件维护者或Docker官方维护，安全性和稳定性较高。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：使用官方镜像")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:14-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不推荐：使用非官方镜像")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" someone/node:14")]),s._v("\n")])])]),t("h4",{attrs:{id:"选择精简版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#选择精简版本"}},[s._v("#")]),s._v(" 选择精简版本")]),s._v(" "),t("p",[s._v("使用Alpine或Slim版本的基础镜像可以显著减小镜像体积。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：使用Alpine版本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" python:3.9-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者使用Slim版本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" python:3.9-slim")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不推荐：使用完整版本（除非有特殊需求）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" python:3.9")]),s._v("\n")])])]),t("h4",{attrs:{id:"指定具体版本标签"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#指定具体版本标签"}},[s._v("#")]),s._v(" 指定具体版本标签")]),s._v(" "),t("p",[s._v("使用具体的版本标签而不是"),t("code",[s._v("latest")]),s._v("，确保构建的可重复性。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：指定具体版本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" nginx:1.21.3-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不推荐：使用latest标签")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" nginx:latest")]),s._v("\n")])])]),t("h3",{attrs:{id:"优化层次结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#优化层次结构"}},[s._v("#")]),s._v(" 优化层次结构")]),s._v(" "),t("p",[s._v("合理组织Dockerfile指令，优化镜像层次结构，可以减小镜像体积并提高构建效率。")]),s._v(" "),t("h4",{attrs:{id:"合并run指令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#合并run指令"}},[s._v("#")]),s._v(" 合并RUN指令")]),s._v(" "),t("p",[s._v("将多个RUN指令合并为一个，减少镜像层数。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：合并RUN指令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt-get update && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    apt-get install -y --no-install-recommends "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        package1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        package2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        package3 && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    apt-get clean && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    rm -rf /var/lib/apt/lists/*")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不推荐：多个RUN指令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt-get update")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt-get install -y package1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt-get install -y package2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt-get install -y package3")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt-get clean")]),s._v("\n")])])]),t("h4",{attrs:{id:"按照变更频率排序指令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#按照变更频率排序指令"}},[s._v("#")]),s._v(" 按照变更频率排序指令")]),s._v(" "),t("p",[s._v("将不经常变更的指令放在Dockerfile的前面，经常变更的放在后面，利用Docker的构建缓存机制提高构建效率。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：按变更频率排序")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:14-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不经常变更的依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk add --no-cache python3 make g++")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制package.json和package-lock.json")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package*.json ./")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm ci")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 经常变更的源代码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n")])])]),t("h4",{attrs:{id:"使用-dockerignore文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-dockerignore文件"}},[s._v("#")]),s._v(" 使用.dockerignore文件")]),s._v(" "),t("p",[s._v("创建"),t("code",[s._v(".dockerignore")]),s._v("文件，排除不需要的文件和目录，减小构建上下文大小。")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# .dockerignore示例\nnode_modules\nnpm-debug.log\n.git\n.gitignore\n.env\n*.md\ntests/\ndocs/\n")])])]),t("h3",{attrs:{id:"减小镜像体积"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#减小镜像体积"}},[s._v("#")]),s._v(" 减小镜像体积")]),s._v(" "),t("p",[s._v("构建尽可能小的镜像可以减少存储空间、加快部署速度并减少攻击面。")]),s._v(" "),t("h4",{attrs:{id:"清理不必要的文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#清理不必要的文件"}},[s._v("#")]),s._v(" 清理不必要的文件")]),s._v(" "),t("p",[s._v("在同一个RUN指令中安装软件包并清理缓存文件。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：安装后清理")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt-get update && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    apt-get install -y --no-install-recommends "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        package1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        package2 && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    apt-get clean && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    rm -rf /var/lib/apt/lists/*")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对于Alpine")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk add --no-cache package1 package2")]),s._v("\n")])])]),t("h4",{attrs:{id:"使用多阶段构建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用多阶段构建"}},[s._v("#")]),s._v(" 使用多阶段构建")]),s._v(" "),t("p",[s._v("多阶段构建可以将构建环境与运行环境分离，只将必要的文件复制到最终镜像中。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建阶段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:14 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" builder")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package*.json ./")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm ci")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run build")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行阶段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" nginx:alpine")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("builder")])]),s._v(" /app/dist /usr/share/nginx/html")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 80")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-g"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"daemon off;"')]),s._v("]")]),s._v("\n")])])]),t("h4",{attrs:{id:"使用特定用户"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用特定用户"}},[s._v("#")]),s._v(" 使用特定用户")]),s._v(" "),t("p",[s._v("避免使用root用户运行应用，创建专用用户提高安全性。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建非root用户")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" addgroup -S appgroup && adduser -S appuser -G appgroup")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" appuser")]),s._v("\n")])])]),t("h3",{attrs:{id:"提高构建效率"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#提高构建效率"}},[s._v("#")]),s._v(" 提高构建效率")]),s._v(" "),t("p",[s._v("优化Dockerfile可以显著提高构建速度，特别是在开发过程中。")]),s._v(" "),t("h4",{attrs:{id:"利用构建缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#利用构建缓存"}},[s._v("#")]),s._v(" 利用构建缓存")]),s._v(" "),t("p",[s._v("了解Docker的缓存机制，合理排序指令以最大化缓存利用。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：先复制依赖文件，安装依赖，再复制源代码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json package-lock.json ./")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm ci")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不推荐：直接复制所有文件，导致源代码变更时无法利用缓存")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm ci")]),s._v("\n")])])]),t("h4",{attrs:{id:"使用buildkit"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用buildkit"}},[s._v("#")]),s._v(" 使用BuildKit")]),s._v(" "),t("p",[s._v("启用Docker BuildKit可以并行处理构建步骤，提高构建速度。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用BuildKit")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DOCKER_BUILDKIT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者在构建时指定")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DOCKER_BUILDKIT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" build "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" myapp "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])])]),t("h4",{attrs:{id:"使用缓存挂载"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用缓存挂载"}},[s._v("#")]),s._v(" 使用缓存挂载")]),s._v(" "),t("p",[s._v("在BuildKit中使用缓存挂载可以在构建之间保留某些目录，如依赖缓存。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用缓存挂载（需要BuildKit）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# syntax=docker/dockerfile:1.3")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:14-alpine")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json package-lock.json ./")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--mount")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("type=cache,target=/root/.npm")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    npm ci")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n")])])]),t("h3",{attrs:{id:"安全最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安全最佳实践"}},[s._v("#")]),s._v(" 安全最佳实践")]),s._v(" "),t("p",[s._v("构建安全的Docker镜像对于保护应用和基础设施至关重要。")]),s._v(" "),t("h4",{attrs:{id:"使用可信基础镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用可信基础镜像"}},[s._v("#")]),s._v(" 使用可信基础镜像")]),s._v(" "),t("p",[s._v("使用官方或可信的基础镜像，并定期更新以获取安全补丁。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：使用官方镜像并指定版本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" debian:bullseye-slim")]),s._v("\n")])])]),t("h4",{attrs:{id:"最小化安装包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#最小化安装包"}},[s._v("#")]),s._v(" 最小化安装包")]),s._v(" "),t("p",[s._v("只安装必要的软件包，减少潜在的漏洞。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：使用--no-install-recommends选项")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt-get update && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    apt-get install -y --no-install-recommends "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        package1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n        package2")]),s._v("\n")])])]),t("h4",{attrs:{id:"不在镜像中存储敏感信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#不在镜像中存储敏感信息"}},[s._v("#")]),s._v(" 不在镜像中存储敏感信息")]),s._v(" "),t("p",[s._v("避免在Dockerfile中包含密码、API密钥等敏感信息。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不推荐：在Dockerfile中包含敏感信息")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" API_KEY="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"my-secret-key"')])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐：使用构建参数，在运行时提供敏感信息")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建时：docker build --build-arg API_KEY=xxx -t myapp .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者在运行时提供：docker run -e API_KEY=xxx myapp")]),s._v("\n")])])]),t("h4",{attrs:{id:"扫描镜像漏洞"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#扫描镜像漏洞"}},[s._v("#")]),s._v(" 扫描镜像漏洞")]),s._v(" "),t("p",[s._v("使用工具扫描镜像中的漏洞，如Trivy、Clair或Snyk。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用Trivy扫描镜像")]),s._v("\ntrivy image myapp:1.0\n")])])]),t("h3",{attrs:{id:"可维护性最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#可维护性最佳实践"}},[s._v("#")]),s._v(" 可维护性最佳实践")]),s._v(" "),t("p",[s._v("编写清晰、可维护的Dockerfile可以提高团队协作效率。")]),s._v(" "),t("h4",{attrs:{id:"使用有意义的标签"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用有意义的标签"}},[s._v("#")]),s._v(" 使用有意义的标签")]),s._v(" "),t("p",[s._v("为镜像添加有意义的标签，提供元数据信息。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LABEL")]),s._v(" maintainer="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"team@example.com"')])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LABEL")]),s._v(" version="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.0"')])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LABEL")]),s._v(" description="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"My application"')])]),s._v("\n")])])]),t("h4",{attrs:{id:"使用参数和环境变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用参数和环境变量"}},[s._v("#")]),s._v(" 使用参数和环境变量")]),s._v(" "),t("p",[s._v("使用ARG和ENV指令使Dockerfile更加灵活。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建参数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ARG")]),s._v(" NODE_VERSION=14")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_VERSION}")]),s._v("-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 环境变量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" APP_HOME=/app")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" NODE_ENV=production")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${APP_HOME}")])]),s._v("\n")])])]),t("h4",{attrs:{id:"添加注释"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加注释"}},[s._v("#")]),s._v(" 添加注释")]),s._v(" "),t("p",[s._v("在Dockerfile中添加注释，解释复杂或不明显的步骤。")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装构建依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk add --no-cache python3 make g++")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置应用")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意：这里的配置适用于生产环境")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" config/production.json /app/config/")]),s._v("\n")])])]),t("h2",{attrs:{id:"语言特定的最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#语言特定的最佳实践"}},[s._v("#")]),s._v(" 语言特定的最佳实践")]),s._v(" "),t("h3",{attrs:{id:"node-js应用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#node-js应用"}},[s._v("#")]),s._v(" Node.js应用")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:14-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制依赖文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package*.json ./")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装生产依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm ci --only=production")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制应用代码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用非root用户")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" node")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置环境变量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" NODE_ENV production")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动应用")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"server.js"')]),s._v("]")]),s._v("\n")])])]),t("h3",{attrs:{id:"python应用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#python应用"}},[s._v("#")]),s._v(" Python应用")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" python:3.9-slim")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" requirements.txt .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" pip install --no-cache-dir -r requirements.txt")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制应用代码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建非root用户")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" adduser --disabled-password --gecos "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" appuser")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" appuser")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动应用")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"python"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"app.py"')]),s._v("]")]),s._v("\n")])])]),t("h3",{attrs:{id:"java应用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#java应用"}},[s._v("#")]),s._v(" Java应用")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建阶段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" maven:3.8-openjdk-11 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" builder")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" pom.xml .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" src ./src")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mvn package -DskipTests")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行阶段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" openjdk:11-jre-slim")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("builder")])]),s._v(" /app/target/*.jar app.jar")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建非root用户")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" adduser --system --group appuser")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" appuser")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"java"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-jar"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"app.jar"')]),s._v("]")]),s._v("\n")])])]),t("h3",{attrs:{id:"go应用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#go应用"}},[s._v("#")]),s._v(" Go应用")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建阶段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" golang:1.17-alpine "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" builder")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装构建依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk add --no-cache git")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" go.mod go.sum ./")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" go mod download")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建应用")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行阶段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" alpine:3.14")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk add --no-cache ca-certificates")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /root/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从构建阶段复制二进制文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("builder")])]),s._v(" /app/main .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./main"')]),s._v("]")]),s._v("\n")])])]),t("h2",{attrs:{id:"实际案例分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实际案例分析"}},[s._v("#")]),s._v(" 实际案例分析")]),s._v(" "),t("h3",{attrs:{id:"web应用案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#web应用案例"}},[s._v("#")]),s._v(" Web应用案例")]),s._v(" "),t("p",[s._v("以下是一个典型的Web应用Dockerfile，结合了多阶段构建、缓存优化和安全最佳实践：")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建阶段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:14-alpine "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" builder")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制并安装依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package*.json ./")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm ci")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制源代码并构建")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run build")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行阶段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" nginx:1.21-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置Nginx")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" nginx.conf /etc/nginx/conf.d/default.conf")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从构建阶段复制构建产物")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("builder")])]),s._v(" /app/dist /usr/share/nginx/html")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用非root用户")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" addgroup -S appgroup && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    adduser -S appuser -G appgroup && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    chown -R appuser:appgroup /usr/share/nginx/html && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    chmod -R 755 /usr/share/nginx/html && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    chown -R appuser:appgroup /var/cache/nginx && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    chown -R appuser:appgroup /var/log/nginx && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    chown -R appuser:appgroup /etc/nginx/conf.d && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    touch /var/run/nginx.pid && "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    chown -R appuser:appgroup /var/run/nginx.pid")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" appuser")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-g"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"daemon off;"')]),s._v("]")]),s._v("\n")])])]),t("h3",{attrs:{id:"微服务案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#微服务案例"}},[s._v("#")]),s._v(" 微服务案例")]),s._v(" "),t("p",[s._v("以下是一个Go微服务的Dockerfile，专注于构建小型、安全的容器镜像：")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建阶段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" golang:1.17-alpine "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" builder")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装构建依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk add --no-cache git ca-certificates")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" go.mod go.sum ./")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" go mod download")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建应用")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-s -w"')]),s._v(" -o microservice .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行阶段 - 使用scratch镜像")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" scratch")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从构建阶段复制SSL证书")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("builder")])]),s._v(" /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制二进制文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("builder")])]),s._v(" /app/microservice /microservice")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制配置文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("builder")])]),s._v(" /app/config.yaml /config.yaml")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/microservice"')]),s._v("]")]),s._v("\n")])])]),t("h2",{attrs:{id:"常见问题与解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#常见问题与解决方案"}},[s._v("#")]),s._v(" 常见问题与解决方案")]),s._v(" "),t("h3",{attrs:{id:"构建缓存失效"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建缓存失效"}},[s._v("#")]),s._v(" 构建缓存失效")]),s._v(" "),t("p",[t("strong",[s._v("问题")]),s._v("：每次构建都重新安装依赖，即使依赖文件没有变化。")]),s._v(" "),t("p",[t("strong",[s._v("解决方案")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("先复制依赖文件（如package.json），安装依赖，再复制其他文件")]),s._v(" "),t("li",[s._v("使用.dockerignore排除不必要的文件")])]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正确的顺序")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json package-lock.json ./")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm ci")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n")])])]),t("h3",{attrs:{id:"镜像体积过大"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#镜像体积过大"}},[s._v("#")]),s._v(" 镜像体积过大")]),s._v(" "),t("p",[t("strong",[s._v("问题")]),s._v("：构建的镜像体积过大，影响部署和传输效率。")]),s._v(" "),t("p",[t("strong",[s._v("解决方案")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("使用多阶段构建")]),s._v(" "),t("li",[s._v("使用Alpine或Slim基础镜像")]),s._v(" "),t("li",[s._v("清理构建缓存和临时文件")]),s._v(" "),t("li",[s._v("只安装生产环境必要的依赖")])]),s._v(" "),t("h3",{attrs:{id:"容器启动缓慢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#容器启动缓慢"}},[s._v("#")]),s._v(" 容器启动缓慢")]),s._v(" "),t("p",[t("strong",[s._v("问题")]),s._v("：容器启动时间过长。")]),s._v(" "),t("p",[t("strong",[s._v("解决方案")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("优化应用启动过程")]),s._v(" "),t("li",[s._v("使用适当的ENTRYPOINT脚本进行健康检查和初始化")]),s._v(" "),t("li",[s._v("考虑使用静态编译的语言（如Go）")])]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加健康检查")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("HEALTHCHECK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("5s")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("3s")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--start-period")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("5s")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--retries")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("3")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" curl -f http://localhost:8080/health || exit 1")]),s._v("\n")])])]),t("h3",{attrs:{id:"安全漏洞"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安全漏洞"}},[s._v("#")]),s._v(" 安全漏洞")]),s._v(" "),t("p",[t("strong",[s._v("问题")]),s._v("：镜像中存在安全漏洞。")]),s._v(" "),t("p",[t("strong",[s._v("解决方案")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("使用最新的基础镜像")]),s._v(" "),t("li",[s._v("定期更新依赖")]),s._v(" "),t("li",[s._v("使用漏洞扫描工具")]),s._v(" "),t("li",[s._v("以非root用户运行应用")])]),s._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("Dockerfile最佳实践是构建高效、安全、可维护Docker镜像的关键。通过遵循本文介绍的最佳实践，您可以：")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("减小镜像体积")]),s._v("：使用多阶段构建、Alpine基础镜像和清理临时文件")]),s._v(" "),t("li",[t("strong",[s._v("提高构建效率")]),s._v("：优化缓存利用、合理排序指令和使用BuildKit")]),s._v(" "),t("li",[t("strong",[s._v("增强安全性")]),s._v("：使用非root用户、最小化安装包和避免存储敏感信息")]),s._v(" "),t("li",[t("strong",[s._v("提高可维护性")]),s._v("：添加标签和注释、使用参数和环境变量")])]),s._v(" "),t("p",[s._v("通过这些实践，您可以构建出更加高效、安全和可维护的Docker镜像，为您的应用提供更好的容器化环境。")]),s._v(" "),t("h2",{attrs:{id:"下一步学习"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#下一步学习"}},[s._v("#")]),s._v(" 下一步学习")]),s._v(" "),t("ul",[t("li",[t("RouterLink",{attrs:{to:"/docker/docker-images.html"}},[s._v("Docker镜像管理")])],1),s._v(" "),t("li",[t("RouterLink",{attrs:{to:"/docker/docker-security.html"}},[s._v("Docker安全最佳实践")])],1),s._v(" "),t("li",[t("RouterLink",{attrs:{to:"/docker/docker-production.html"}},[s._v("Docker生产环境部署")])],1),s._v(" "),t("li",[t("RouterLink",{attrs:{to:"/docker/docker-compose.html"}},[s._v("Docker Compose详解")])],1)])])}),[],!1,null,null,null);t.default=n.exports}}]);