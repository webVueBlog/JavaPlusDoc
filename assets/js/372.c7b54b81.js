(window.webpackJsonp=window.webpackJsonp||[]).push([[372],{1190:function(t,s,a){"use strict";a.r(s);var n=a(1),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"å“ˆå–½ç”µæ± è®¾å¤‡nettyç½‘å…³æ¶æ„"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å“ˆå–½ç”µæ± è®¾å¤‡nettyç½‘å…³æ¶æ„"}},[t._v("#")]),t._v(" å“ˆå–½ç”µæ± è®¾å¤‡Nettyç½‘å…³æ¶æ„")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("è¯»å– "),s("code",[t._v("gateway.url.firewall")]),t._v(" é…ç½®ï¼ˆé€—å·åˆ†éš”çš„ç™½åå•è·¯å¾„ï¼‰")])]),t._v(" "),s("li",[s("p",[t._v("æ³¨å†Œä¸¤ä¸ªæ‹¦æˆªå™¨ï¼š")]),t._v(" "),s("ol",[s("li",[t._v("ä½ çš„è‡ªå®šä¹‰æ‹¦æˆªå™¨ "),s("code",[t._v("getWebInterceptor()")]),t._v("ï¼Œå¹¶å¯¹ç™½åå• "),s("code",[t._v("excludePathPatterns(...)")]),t._v(" æ”¾è¡Œ")]),t._v(" "),s("li",[s("code",[t._v("sentinelWebInterceptor")]),t._v("ï¼ˆé™æµç”¨ï¼‰ï¼Œå¯¹æ‰€æœ‰è·¯å¾„ç”Ÿæ•ˆ")])])])]),t._v(" "),s("h1",{attrs:{id:"å­˜åœ¨çš„å¸¸è§å‘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å­˜åœ¨çš„å¸¸è§å‘"}},[t._v("#")]),t._v(" å­˜åœ¨çš„å¸¸è§å‘")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("ç»§æ‰¿ "),s("code",[t._v("WebMvcConfigurationSupport")]),t._v(" ä¼šç¦ç”¨ Spring Boot çš„è‡ªåŠ¨é…ç½®")]),t._v("ï¼ˆé™æ€èµ„æºã€æ¶ˆæ¯è½¬æ¢å™¨ç­‰éƒ½è¦ä½ æ‰‹åŠ¨é…ï¼‰â€”â€”é€šå¸¸ä¸å»ºè®®ã€‚")]),t._v(" "),s("li",[s("code",[t._v("@RefreshScope")]),t._v(" æ”¾åœ¨è¿™ä¸ªç±»ä¸Šï¼Œ"),s("strong",[t._v("ç™½åå•å¹¶ä¸ä¼šâ€œçƒ­æ›´æ–°â€")]),t._v("ï¼ˆ"),s("code",[t._v("excludePathPatterns")]),t._v(" æ˜¯å¯åŠ¨æ—¶å°±å®šæ­»çš„ï¼‰ã€‚")]),t._v(" "),s("li",[t._v("æ‰‹åŠ¨ "),s("code",[t._v('replaceAll("\\\\s","")')]),t._v("+"),s("code",[t._v('split(",")')]),t._v(" å®¹æ˜“è¸©ç©ºæ ¼/ç©ºå€¼å‘ï¼ŒSpring Boot è‡ªå¸¦çš„"),s("strong",[t._v("ç±»å‹ç»‘å®š")]),t._v("æ›´ç¨³ã€‚")])]),t._v(" "),s("hr"),t._v(" "),s("h1",{attrs:{id:"æ¨èå®ç°-a-å¸¸è§„-é‡å¯åç”Ÿæ•ˆ-æœ€ç®€å•ç¨³å®š"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#æ¨èå®ç°-a-å¸¸è§„-é‡å¯åç”Ÿæ•ˆ-æœ€ç®€å•ç¨³å®š"}},[t._v("#")]),t._v(" æ¨èå®ç° Aï¼šå¸¸è§„ï¼ˆé‡å¯åç”Ÿæ•ˆï¼Œæœ€ç®€å•ç¨³å®šï¼‰")]),t._v(" "),s("p",[t._v("ğŸ‘‰ ç”¨ "),s("strong",[s("code",[t._v("WebMvcConfigurer")])]),t._v(" + "),s("strong",[t._v("é…ç½®ç»‘å®š "),s("code",[t._v("@ConfigurationProperties")])]),t._v("ã€‚")]),t._v(" "),s("blockquote",[s("p",[t._v("è¿™ç‰ˆæœ€æ¥è¿‘ä½ ç°æœ‰é€»è¾‘ï¼Œä½†éœ€è¦é‡å¯æˆ–é‡æ–°éƒ¨ç½²åæ‰ä¼šç”Ÿæ•ˆã€‚")])]),t._v(" "),s("p",[s("strong",[t._v("1) å±æ€§ç»‘å®šï¼ˆæŠŠç™½åå•ç›´æ¥ç»‘æˆ Listï¼‰")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// FirewallProperties.java")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("boot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("properties"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ConfigurationProperties")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stereotype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ArrayList")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@ConfigurationProperties")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prefix "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"gateway.url"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FirewallProperties")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * ç™½åå•è·¯å¾„ï¼Œå¦‚ï¼š/actuator/**, /public/**, /error\n     */")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" firewall "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ArrayList")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFirewall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" firewall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setFirewall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" firewall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firewall "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" firewall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("2) ä½ çš„ä¸šåŠ¡æ‹¦æˆªå™¨ï¼ˆç¤ºä¾‹éª¨æ¶ï¼‰")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// WebInterceptor.java")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("jakarta"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("servlet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletRequest")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("jakarta"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("servlet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletResponse")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lang"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Nullable")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stereotype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("servlet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HandlerInterceptor")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebInterceptor")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HandlerInterceptor")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("preHandle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletRequest")]),t._v(" request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletResponse")]),t._v(" response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// TODO æ”¾ä½ çš„é‰´æƒã€ç­¾åæ ¡éªŒã€æ—¥å¿—è„±æ•ã€IP é™åˆ¶ç­‰é€»è¾‘")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¿”å› false åˆ™æ‹¦æˆª")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("3) æ³¨å†Œæ‹¦æˆªå™¨ï¼ˆä¸å†ç»§æ‰¿ WebMvcConfigurationSupportï¼‰")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// WebMvcConfig.java")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("lombok"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RequiredArgsConstructor")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Configuration")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("servlet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("InterceptorRegistry")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("servlet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebMvcConfigurer")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequiredArgsConstructor")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebMvcConfig")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebMvcConfigurer")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebInterceptor")]),t._v(" webInterceptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FirewallProperties")]),t._v(" firewallProperties"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SentinelWebInterceptor")]),t._v(" sentinelWebInterceptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ¥è‡ª Sentinel ä¾èµ–ï¼Œèƒ½è‡ªåŠ¨æ³¨å…¥")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addInterceptors")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("InterceptorRegistry")]),t._v(" registry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1) å…ˆæ‰§è¡Œï¼šä½ çš„ä¸šåŠ¡/é˜²ç«å¢™æ‹¦æˆªå™¨ï¼ˆå¯¹ç™½åå•æ”¾è¡Œï¼‰")]),t._v("\n        registry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addInterceptor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("webInterceptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addPathPatterns")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/**"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("excludePathPatterns")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("firewallProperties"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFirewall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("order")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2) å†æ‰§è¡Œï¼šé™æµ Sentinel")]),t._v("\n        registry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addInterceptor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sentinelWebInterceptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addPathPatterns")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/**"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("order")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("4) "),s("code",[t._v("application.yml")]),t._v(" ç¤ºä¾‹")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gateway")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("firewall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /actuator/"),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /public/"),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("**")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /error\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /health\n")])])]),s("hr"),t._v(" "),s("h1",{attrs:{id:"æ¨èå®ç°-b-éœ€è¦çƒ­æ›´æ–°ç™½åå•-ä¸é‡å¯ä¹Ÿç”Ÿæ•ˆ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#æ¨èå®ç°-b-éœ€è¦çƒ­æ›´æ–°ç™½åå•-ä¸é‡å¯ä¹Ÿç”Ÿæ•ˆ"}},[t._v("#")]),t._v(" æ¨èå®ç° Bï¼šéœ€è¦"),s("strong",[t._v("çƒ­æ›´æ–°ç™½åå•")]),t._v("ï¼ˆä¸é‡å¯ä¹Ÿç”Ÿæ•ˆï¼‰")]),t._v(" "),s("p",[t._v("ğŸ‘‰ æŠŠç™½åå•â€œåŒ¹é…é€»è¾‘â€æ”¾è¿›æ‹¦æˆªå™¨ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½æŒ‰æœ€æ–°é…ç½®åˆ¤æ–­æ”¾è¡Œï¼›ç”¨ "),s("code",[t._v("@RefreshScope")]),t._v(" åªåˆ·æ–°"),s("strong",[t._v("æ•°æ®")]),t._v("ï¼Œä¸åˆ·æ–° Spring MVC æ˜ å°„ã€‚")]),t._v(" "),s("p",[s("strong",[t._v("1) å¯åˆ·æ–°çš„ç™½åå•é…ç½®")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// FirewallProperties.java")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cloud"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RefreshScope")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("boot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("properties"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ConfigurationProperties")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stereotype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ArrayList")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RefreshScope")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@ConfigurationProperties")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prefix "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"gateway.url"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FirewallProperties")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" firewall "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ArrayList")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFirewall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" firewall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setFirewall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" firewall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firewall "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" firewall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("2) åœ¨æ‹¦æˆªå™¨é‡Œè‡ªå·±åˆ¤æ–­â€œç™½åå•å³æ”¾è¡Œâ€")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// WebInterceptor.java")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("jakarta"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("servlet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletRequest")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("jakarta"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("servlet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletResponse")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stereotype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AntPathMatcher")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("servlet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HandlerInterceptor")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebInterceptor")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HandlerInterceptor")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FirewallProperties")]),t._v(" props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AntPathMatcher")]),t._v(" matcher "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AntPathMatcher")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebInterceptor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FirewallProperties")]),t._v(" props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("props "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("preHandle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletRequest")]),t._v(" req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletResponse")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" uri "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRequestURI")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å‘½ä¸­ç™½åå• => ç›´æ¥æ”¾è¡Œï¼ˆæ”¯æŒ /public/** è¿™ç±»é€šé…ï¼‰")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" p "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFirewall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("matcher"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("match")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uri"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// éç™½åå• => ä½ çš„æ ¡éªŒé€»è¾‘")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// TODO ç­¾åã€tokenã€IPã€é¢‘ç‡é™åˆ¶ç­‰")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("3) æ³¨å†Œæ—¶å°±ä¸è¦å†ç”¨ "),s("code",[t._v("excludePathPatterns")]),t._v(" äº†")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequiredArgsConstructor")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebMvcConfig")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebMvcConfigurer")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebInterceptor")]),t._v(" webInterceptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SentinelWebInterceptor")]),t._v(" sentinelWebInterceptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addInterceptors")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("InterceptorRegistry")]),t._v(" registry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        registry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addInterceptor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("webInterceptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addPathPatterns")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/**"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("order")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        registry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addInterceptor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sentinelWebInterceptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addPathPatterns")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/**"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("order")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("è¿™æ ·ï¼ŒNacos/Config åˆ·æ–° "),s("code",[t._v("gateway.url.firewall")]),t._v(" åï¼Œ"),s("strong",[t._v("ä¸‹ä¸€æ¬¡è¯·æ±‚ç«‹åˆ»æŒ‰æ–°ç™½åå•ç”Ÿæ•ˆ")]),t._v("ã€‚")])]),t._v(" "),s("hr"),t._v(" "),s("h1",{attrs:{id:"å¿…è¦ä¾èµ–-ç¤ºä¾‹"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å¿…è¦ä¾èµ–-ç¤ºä¾‹"}},[t._v("#")]),t._v(" å¿…è¦ä¾èµ–ï¼ˆç¤ºä¾‹ï¼‰")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- Spring Web --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.boot"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-boot-starter-web"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- å¦‚æœç”¨ Sentinel çš„ Web æ‹¦æˆªå™¨ --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("com.alibaba.csp"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("sentinel-parameter-flow-control"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("â€¦"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- å¦‚æœè¦ @RefreshScopeï¼ˆSpring Cloud Config / Nacosï¼‰--\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.cloud"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-cloud-starter"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("hr"),t._v(" "),s("h1",{attrs:{id:"ä½¿ç”¨é¡ºåº-å°ç™½ç‰ˆ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ä½¿ç”¨é¡ºåº-å°ç™½ç‰ˆ"}},[t._v("#")]),t._v(" ä½¿ç”¨é¡ºåºï¼ˆå°ç™½ç‰ˆï¼‰")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("æŠŠä¸Šé¢ 3 ä¸ªç±»ï¼ˆæˆ– 5 ä¸ªç±»ï¼Œå– A æˆ– B æ–¹æ¡ˆï¼‰æ”¾è¿›ä½ çš„å·¥ç¨‹ã€‚")])]),t._v(" "),s("li",[s("p",[t._v("åœ¨ "),s("code",[t._v("application.yml")]),t._v(" å†™å¥½ç™½åå•è·¯å¾„ï¼ˆå¯ä»¥å…ˆæ”¾ "),s("code",[t._v("/public/**")]),t._v(", "),s("code",[t._v("/actuator/**")]),t._v("ï¼‰ã€‚")])]),t._v(" "),s("li",[s("p",[t._v("å¯åŠ¨é¡¹ç›®ï¼š")]),t._v(" "),s("ul",[s("li",[t._v("è®¿é—®ç™½åå•é‡Œçš„åœ°å€ï¼ˆåº”ç›´æ¥é€šè¿‡ï¼‰")]),t._v(" "),s("li",[t._v("è®¿é—®éç™½åå•åœ°å€ï¼ˆåº”èµ°ä½ çš„æ‹¦æˆªé€»è¾‘ï¼‰")])])]),t._v(" "),s("li",[s("p",[t._v("å¦‚æœä½ éœ€è¦"),s("strong",[t._v("çƒ­æ›´æ–°")]),t._v("ï¼šç”¨â€œæ–¹æ¡ˆ Bâ€ï¼Œåœ¨é…ç½®ä¸­å¿ƒæ”¹ç™½åå•ï¼Œ"),s("code",[t._v("/actuator/refresh")]),t._v(" æˆ–è‡ªåŠ¨åˆ·æ–°åï¼Œ"),s("strong",[t._v("ä¸ç”¨é‡å¯")]),t._v("å°±ç”Ÿæ•ˆã€‚")])])]),t._v(" "),s("hr"),t._v(" "),s("h1",{attrs:{id:"å°æŠ€å·§-è¯´æ˜"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å°æŠ€å·§-è¯´æ˜"}},[t._v("#")]),t._v(" å°æŠ€å·§ & è¯´æ˜")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("é¡ºåº")]),t._v("ï¼š"),s("code",[t._v("order")]),t._v(" æ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼Œé€šå¸¸â€œç™½åå•/é‰´æƒâ€ä¼˜å…ˆï¼Œå†é™æµã€‚")]),t._v(" "),s("li",[s("strong",[t._v("Spring Boot 3")]),t._v(" é»˜è®¤ä½¿ç”¨ PathPatternï¼Œ"),s("code",[t._v("AntPathMatcher")]),t._v(" ä¹Ÿå¯ä»¥åœ¨æ‹¦æˆªå™¨é‡Œç”¨ï¼Œé€šé…è¯­æ³•åŸºæœ¬ä¸€è‡´ï¼ˆ"),s("code",[t._v("/a/**")]),t._v("ã€"),s("code",[t._v("/a/*")]),t._v("ï¼‰ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("ä¸è¦å†ç»§æ‰¿ "),s("code",[t._v("WebMvcConfigurationSupport")])]),t._v("ï¼Œé™¤éä½ æ˜ç¡®è¦å®Œå…¨æ¥ç®¡ MVC é…ç½®ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("åä»£ä¹‹åå–çœŸå® IP")]),t._v("ï¼šåœ¨æ‹¦æˆªå™¨é‡Œç”¨ "),s("code",[t._v("X-Forwarded-For")]),t._v("ï¼ˆè®°å¾—åœ¨ç½‘å…³/NGINX å¼€å¯é€ä¼ ï¼‰ã€‚")])]),t._v(" "),s("h1",{attrs:{id:"æ€»ä½“æ¶æ„-é€»è¾‘è§†å›¾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#æ€»ä½“æ¶æ„-é€»è¾‘è§†å›¾"}},[t._v("#")]),t._v(" æ€»ä½“æ¶æ„ï¼ˆé€»è¾‘è§†å›¾ï¼‰")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    TCP(4G/ç‰©è”)      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  è®¾å¤‡ç«¯  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Nginx/L4 LB  â”‚ â”€â”€â”€â–¶ â”‚ Netty ç½‘å…³xN â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (IP Hash/ä¸€è‡´å“ˆå¸Œ)   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜\n                                         â”‚Consistent Hash       â”‚\n                                         â”‚è·¯ç”±ä¸€è‡´æ€§            â”‚\n                                         â–¼                      â–¼\n                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                                   â”‚ Redis   â”‚â—€â”€ç§Ÿçº¦TTLâ”€â”€â–¶â”‚ ç½‘å…³ç§Ÿçº¦  â”‚\n                                   â”‚ (Clusterâ”‚   deviceâ†’  â”‚ ç®¡ç†(Lua) â”‚\n                                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   gateway  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜\n                                        â”‚                     ä¸ŠæŠ¥/ç»­ç­¾\n                                        â”‚                             \n                         æŒ‡ä»¤ä¸‹å‘/çŠ¶æ€æµ â”‚                              äº‹ä»¶æ¶ˆæ¯\n                                        â–¼                              â–¼\n                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                                   â”‚ Kafka    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ä¸šåŠ¡é›†ç¾¤ â”‚\n                                   â”‚  topics  â”‚   (äº‹ä»¶/çŠ¶æ€)    â”‚ (æ¶ˆè´¹/å­˜å‚¨â”‚\n                                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â”‚ ç­–ç•¥/é£æ§)â”‚\n                                        â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”\n                                 â”‚ ç›‘æ§&æ—¥å¿—é“¾è·¯  â”‚(Prometheus/Grafana/ELK/Jaeger)\n                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n")])])]),s("h1",{attrs:{id:"ç«¯åˆ°ç«¯æ•°æ®æµ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ç«¯åˆ°ç«¯æ•°æ®æµ"}},[t._v("#")]),t._v(" ç«¯åˆ°ç«¯æ•°æ®æµ")]),t._v(" "),s("ol",[s("li",[t._v("è®¾å¤‡ä¸Šçº¿ï¼šè®¾å¤‡â†’Nginxâ†’æŸå°ç½‘å…³ï¼ˆæŒ‰ä¸€è‡´å“ˆå¸Œï¼‰ã€‚")]),t._v(" "),s("li",[t._v("æ¡æ‰‹&é‰´æƒï¼šç½‘å…³æ ¡éªŒç­¾å/å¯†é’¥â†’é€šè¿‡ååœ¨ Redis å†™ "),s("code",[t._v("deviceâ†’gateway")]),t._v(" æ˜ å°„å¹¶è®¾ç½® TTL(ç§Ÿçº¦)ã€‚")]),t._v(" "),s("li",[t._v("å¿ƒè·³ä¿æ´»ï¼šè®¾å¤‡å¿ƒè·³ï¼›ç½‘å…³å®šæœŸç»­ç­¾ Redis TTLã€‚")]),t._v(" "),s("li",[t._v("ä¸ŠæŠ¥æ•°æ®ï¼šç½‘å…³è§£ç â†’æ ¡éªŒâ†’å¼‚æ­¥å†™ Kafkaï¼ˆat-least-onceï¼‰ï¼Œå…³é”®å­—æ®µè½åœ°ï¼ˆå¦‚è®¾å¤‡åœ¨çº¿æ€ã€æœ€è¿‘ç”µå‹ç­‰å¯èµ° Redis/æ—¶åºåº“ï¼‰ã€‚")]),t._v(" "),s("li",[t._v("æŒ‡ä»¤ä¸‹å‘ï¼šä¸šåŠ¡é›†ç¾¤â†’æŸ¥ "),s("code",[t._v("deviceâ†’gateway")]),t._v(" â†’RPC/æ¶ˆæ¯æŠ•é€’åˆ°å¯¹åº”ç½‘å…³â†’Netty å†™å›è®¾å¤‡ã€‚")]),t._v(" "),s("li",[t._v("æ•…éšœåˆ‡æ¢ï¼šç½‘å…³æ•…éšœâ†’ç§Ÿçº¦ä¸å†ç»­ç­¾åˆ°æœŸâ†’Nginx ä¸€è‡´å“ˆå¸Œå°†æ–°è¿æ¥æ‰“åˆ°å…¶ä»–ç½‘å…³â†’æ–°ç½‘å…³æ¥ç®¡ã€‚")])]),t._v(" "),s("h1",{attrs:{id:"å…³é”®æ¨¡å—"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å…³é”®æ¨¡å—"}},[t._v("#")]),t._v(" å…³é”®æ¨¡å—")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("æ¥å…¥å±‚ï¼ˆNginx Stream/L4 LBï¼‰")]),t._v("ï¼šä¸€è‡´æ€§å“ˆå¸Œåˆ°ç½‘å…³ï¼›å¥åº·æ£€æŸ¥ï¼›è¿æ¥æ•°é™æµã€‚")]),t._v(" "),s("li",[s("strong",[t._v("è¿æ¥ç®¡ç†ï¼ˆNettyï¼‰")]),t._v("ï¼šepoll+ç›´è¿å †å¤–ç¼“å†²ã€è¿æ¥è¡¨(ConcurrentHashMap)ã€ç©ºé—²æ£€æµ‹(IdleStateHandler)ã€èƒŒå‹(writeBufferWaterMark)ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("åè®®ç¼–è§£ç ")]),t._v("ï¼šJT/T808 æˆ–è‡ªå®šä¹‰å¸§ï¼ˆLengthFieldBasedFrameDecoder/Protobuf/è‡ªå®šä¹‰ CRC æ ¡éªŒï¼‰ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("é‰´æƒ&ä¼šè¯")]),t._v("ï¼šè®¾å¤‡å¯†é’¥/ç­¾åã€æ—¶é—´æˆ³ï¼›ä¼šè¯å¯¹è±¡ç»‘å®š Channelï¼Œæ”¯æŒå¹‚ç­‰ä¸Šçº¿ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("ç§Ÿçº¦ä¸æ˜ å°„ï¼ˆRedisï¼‰")]),t._v("ï¼š"),s("code",[t._v("HSET deviceâ†’gateway")]),t._v(" + "),s("code",[t._v("EXPIRE")]),t._v(" æˆ– "),s("code",[t._v("SETEX")]),t._v("ï¼›Lua åŸå­ç»­çº¦/è¸¢åŒç«¯ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("æ¶ˆæ¯æ€»çº¿ï¼ˆKafkaï¼‰")]),t._v("ï¼šä¸Šè¡Œäº‹ä»¶/çŠ¶æ€ï¼ˆtopics åˆ†åŒº=ä¸€è‡´æ€§Keyï¼‰ï¼Œä¸‹è¡ŒæŒ‡ä»¤å›æ‰§ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("æŒ‡ä»¤è·¯ç”±")]),t._v("ï¼šå…ˆæŸ¥ Redis æŸ¥åˆ°ç½‘å…³IPâ†’RPC/HTTP åˆ°è¯¥ç½‘å…³å†…ç½®â€œä¸‹å‘æ¥å£â€â†’Channel å®šä½å¹¶å†™ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("å¯è§‚æµ‹æ€§")]),t._v("ï¼šPrometheus æŒ‡æ ‡ï¼ˆè¿æ¥æ•°ã€å¿ƒè·³å»¶è¿Ÿã€è§£ç å¤±è´¥ã€å†™é˜Ÿåˆ—ç§¯å‹ã€æŒ‡ä»¤RT/æˆåŠŸç‡ï¼‰ï¼›æ—¥å¿—è„±æ•ï¼›Trace(å¯é€‰)ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("å®‰å…¨")]),t._v("ï¼šé»‘åå•ã€é¢‘ç‡é™åˆ¶ï¼›ç­¾å+é‡æ”¾é˜²æŠ¤ï¼ˆnonce+æ—¶çª—ï¼‰ï¼›æ•°æ®åŠ å¯†ï¼ˆå¯é€‰ï¼‰ã€‚")])]),t._v(" "),s("h1",{attrs:{id:"redis-å…³é”®é”®è®¾è®¡-ç¤ºä¾‹"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redis-å…³é”®é”®è®¾è®¡-ç¤ºä¾‹"}},[t._v("#")]),t._v(" Redis å…³é”®é”®è®¾è®¡ï¼ˆç¤ºä¾‹ï¼‰")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# è®¾å¤‡â†’ç½‘å…³æ˜ å°„ä¸ç§Ÿçº¦ï¼ˆ60s å¿ƒè·³ï¼ŒTTL 180sï¼‰\nKey: dev:lease:{deviceId}  Value: {gatewayId}|{leaseVersion}|{ts}, TTL=180\n\n# ç½‘å…³æ´»è·ƒé›†\nKey: gw:alive                 Set(gatewayId), ç½‘å…³å¿ƒè·³ç»´æŠ¤\n\n# è®¾å¤‡åœ¨çº¿æ€\nKey: dev:online:{deviceId}    0/1 + lastSeenTs\n")])])]),s("blockquote",[s("p",[t._v("ç”¨ Lua ä¿è¯ï¼šåŒä¸€è®¾å¤‡çš„â€œç»­çº¦/æ¥ç®¡/è¸¢åŒç«¯â€åŸå­åŒ–ï¼Œä¸”æ ¡éªŒç‰ˆæœ¬å·é¿å…å¹¶å‘è¦†ç›–ã€‚")])]),t._v(" "),s("h1",{attrs:{id:"nginx-stream-ä¸€è‡´æ€§å“ˆå¸Œ-ç¤ºä¾‹"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-stream-ä¸€è‡´æ€§å“ˆå¸Œ-ç¤ºä¾‹"}},[t._v("#")]),t._v(" Nginx stream ä¸€è‡´æ€§å“ˆå¸Œï¼ˆç¤ºä¾‹ï¼‰")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("stream")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("log_format")]),t._v(" basic "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr:")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_port")]),t._v(" -> "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$server_addr:")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$server_port")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$status")]),t._v("'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" /var/log/nginx/stream_access.log basic")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" gateway_pool")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("hash")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),t._v(" consistent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# å¯åˆ‡æ¢ä¸º $ssl_preread_server_name æˆ– $proxy_protocol_addr")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" 10.0.0.11:9000 max_fails=3 fail_timeout=10s")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" 10.0.0.12:9000 max_fails=3 fail_timeout=10s")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" 10.0.0.13:9000 max_fails=3 fail_timeout=10s")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7000")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# è®¾å¤‡ TCP å…¥å£")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_connect_timeout")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3s")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_timeout")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3600s")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" gateway_pool")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h1",{attrs:{id:"netty-pipeline-å»ºè®®"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#netty-pipeline-å»ºè®®"}},[t._v("#")]),t._v(" Netty Pipeline å»ºè®®")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("ch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipeline")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addLast")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"idle"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IdleStateHandler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("90")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TimeUnit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SECONDS")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¯»ç©ºé—²=å¿ƒè·³ä¸¢å¤±")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addLast")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"frame"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LengthFieldBasedFrameDecoder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addLast")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"codec"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DeviceMessageCodec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è‡ªå®šä¹‰ç¼–è§£ç /CRC/ç­¾å")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addLast")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"auth"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AuthHandler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// é¦–åŒ…é‰´æƒ, é€šè¿‡åç§»é™¤")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addLast")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hb"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HeartbeatHandler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç»­ç§Ÿã€æ›´æ–° lastSeen")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addLast")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"biz"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UplinkHandler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("kafkaProducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¸Šè¡Œè½ Kafka")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addLast")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ack"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DownlinkAckHandler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("kafkaProducer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å›æ‰§")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[s("strong",[t._v("Channel é€‰é¡¹")]),t._v("ï¼š")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("bootstrap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("option")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ChannelOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SO_BACKLOG")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("childOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ChannelOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TCP_NODELAY")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("childOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ChannelOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SO_REUSEADDR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("childOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ChannelOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SO_RCVBUF")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("256")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("childOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ChannelOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SO_SNDBUF")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("256")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("childOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ChannelOption")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("WRITE_BUFFER_WATER_MARK")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WriteBufferWaterMark")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h1",{attrs:{id:"å¿ƒè·³-è‡ªæ„ˆ-æ ¸å¿ƒé€»è¾‘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å¿ƒè·³-è‡ªæ„ˆ-æ ¸å¿ƒé€»è¾‘"}},[t._v("#")]),t._v(" å¿ƒè·³ & è‡ªæ„ˆï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰")]),t._v(" "),s("ul",[s("li",[t._v("è®¾å¤‡å¿ƒè·³é—´éš”ï¼š60sï¼›ç½‘å…³è¯»ç©ºé—²>90s è§†ä¸ºæ‰çº¿ï¼Œå…³é—­ Channelã€‚")]),t._v(" "),s("li",[t._v("ç½‘å…³ç»­ç§Ÿï¼šæ¯ 60s æ‰§è¡Œ Luaï¼šè‹¥ "),s("code",[t._v("dev:lease:{id}")]),t._v(" çš„ "),s("code",[t._v("gatewayId")]),t._v(" ä¸ºæœ¬æœºä¸”ç‰ˆæœ¬åŒ¹é…â†’åˆ·æ–° TTLï¼›å¦åˆ™ä¸ç»­ã€‚")]),t._v(" "),s("li",[t._v("ç½‘å…³å®•æœºï¼šä¸ç»­ç§Ÿâ†’TTL åˆ°æœŸï¼ˆ~180sï¼‰â†’æ˜ å°„æ¶ˆå¤±â†’è®¾å¤‡é‡è¿è¢« Nginx åˆ†é…åˆ°æ–°ç½‘å…³â†’æ–°ç½‘å…³ç”¨â€œæ¥ç®¡ Luaâ€å°† lease ç‰ˆæœ¬+1 å¹¶å†™å…¥ã€‚")])]),t._v(" "),s("h1",{attrs:{id:"æŒ‡ä»¤ä¸‹å‘è·¯å¾„"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#æŒ‡ä»¤ä¸‹å‘è·¯å¾„"}},[t._v("#")]),t._v(" æŒ‡ä»¤ä¸‹å‘è·¯å¾„")]),t._v(" "),s("ol",[s("li",[t._v("ä¸šåŠ¡è°ƒç”¨ï¼š"),s("code",[t._v("POST /cmd/send {deviceId, cmd, payload, timeout}")])]),t._v(" "),s("li",[t._v("ç½‘å…³å†…éƒ¨ï¼šæ ¹æ® "),s("code",[t._v("deviceId")]),t._v(" æŸ¥ Channelï¼›è‹¥åœ¨çº¿â†’å†™å¹¶ç­‰å¾… ACKï¼›ä¸åœ¨çº¿â†’è¿”å›ç¦»çº¿æˆ–å…¥å»¶æ—¶é˜Ÿåˆ—ï¼ˆå¯é€‰ï¼‰ã€‚")]),t._v(" "),s("li",[t._v("å¹‚ç­‰ï¼šä¸šåŠ¡ä¾§è‡ªå¸¦ "),s("code",[t._v("requestId")]),t._v("ï¼›ACK æºå¸¦åŒ IDï¼›Kafka ä¾§å¯¹å›æ‰§åšå»é‡ã€‚")])]),t._v(" "),s("h1",{attrs:{id:"kafka-topic-è§„åˆ’-ç¤ºä¾‹"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kafka-topic-è§„åˆ’-ç¤ºä¾‹"}},[t._v("#")]),t._v(" Kafka Topic è§„åˆ’ï¼ˆç¤ºä¾‹ï¼‰")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("device.uplink.raw")]),t._v("ï¼ˆåˆ†åŒº key=deviceIdï¼‰ï¼šåŸå§‹ä¸ŠæŠ¥")]),t._v(" "),s("li",[s("code",[t._v("device.status.event")]),t._v("ï¼šä¸Šçº¿/ä¸‹çº¿/å¿ƒè·³å¼‚å¸¸")]),t._v(" "),s("li",[s("code",[t._v("device.cmd.ack")]),t._v("ï¼šæŒ‡ä»¤å›æ‰§")]),t._v(" "),s("li",[s("code",[t._v("device.metric")]),t._v("ï¼šç”µå‹/æ¸©åº¦/æ•…éšœç ç­‰æŒ‡æ ‡")])]),t._v(" "),s("h1",{attrs:{id:"lua-æ ¸å¿ƒ-ä¼ªä»£ç "}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lua-æ ¸å¿ƒ-ä¼ªä»£ç "}},[t._v("#")]),t._v(" Lua æ ¸å¿ƒï¼ˆä¼ªä»£ç ï¼‰")]),t._v(" "),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- KEYS[1]=dev:lease:{deviceId}, ARGV={gatewayId, version, nowTs, ttl}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" v "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" v "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n  redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SET'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'|'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'|'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'EX'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'NEW'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" parts "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" s "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" string"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("gmatch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"([^|]+)"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("insert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" curGw "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" curVer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" curGw "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("and")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" curVer "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n  redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SET'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" curGw"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'|'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v("curVer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'|'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'EX'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'RENEW'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- å¯åŠ ç‰ˆæœ¬æ¯”è¾ƒæˆ–è¸¢åŒç«¯ç­–ç•¥")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'MISMATCH'")]),t._v("\n")])])]),s("h1",{attrs:{id:"jvm-å†…æ ¸-å®¹é‡å»ºè®®-å•æœº-10-15ä¸‡é•¿è¿æ¥åŸºçº¿"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jvm-å†…æ ¸-å®¹é‡å»ºè®®-å•æœº-10-15ä¸‡é•¿è¿æ¥åŸºçº¿"}},[t._v("#")]),t._v(" JVM/å†…æ ¸/å®¹é‡å»ºè®®ï¼ˆå•æœº 10~15ä¸‡é•¿è¿æ¥åŸºçº¿ï¼‰")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("JVM")]),t._v("ï¼šJDK17ï¼›G1/ ZGCï¼ˆå†…å­˜â‰¥32Gå¯é€‰ ZGCï¼‰ï¼›"),s("code",[t._v("-XX:MaxGCPauseMillis=100")]),t._v("ï¼›å † 8~16Gï¼Œç›´å†…å­˜ä¸å †å¤–ç¼“å†²ï¼ˆPooledByteBufAllocatorï¼‰â‰¥å †ï¼›ç¦ç”¨åå‘é”ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("Netty")]),t._v("ï¼š"),s("code",[t._v("-Dio.netty.allocator.type=pooled")]),t._v("ï¼Œå¼€å¯ "),s("code",[t._v("recycler.maxCapacity")]),t._v(" åˆç†å›æ”¶ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("å†…æ ¸")]),t._v("ï¼š"),s("code",[t._v("ulimit -n 1,000,000")]),t._v("ï¼›"),s("code",[t._v("net.ipv4.tcp_tw_reuse=1")]),t._v("ï¼›"),s("code",[t._v("somaxconn=65535")]),t._v("ï¼›"),s("code",[t._v("tcp_max_syn_backlog=262144")]),t._v("ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("ç½‘å¡")]),t._v("ï¼šå¤šé˜Ÿåˆ—ä¸­æ–­ã€RPS/RFSï¼›å…³é—­å¤§åŒ…åˆ†ç‰‡å¯¼è‡´çš„å¼‚å¸¸ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("å‹æµ‹")]),t._v("ï¼šè™šæ‹Ÿè®¾å¤‡+è¿æ¥å¢é•¿/æŠ–åŠ¨/ç§’çº§æ–­çº¿é‡è¿ï¼›å…³æ³¨è¿æ¥å»ºç«‹é€Ÿç‡ã€å†™é˜Ÿåˆ—æ°´ä½ã€99çº¿RTã€‚")])]),t._v(" "),s("h1",{attrs:{id:"ç°åº¦ä¸é™çº§"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ç°åº¦ä¸é™çº§"}},[t._v("#")]),t._v(" ç°åº¦ä¸é™çº§")]),t._v(" "),s("ul",[s("li",[t._v("è§£ç å¤±è´¥/å¼‚å¸¸æ¯”ç‡é˜ˆå€¼â†’è‡ªåŠ¨é™çº§ï¼ˆé™æµ/ä¸¢å¼ƒé«˜é¢‘éå…³é”®äº‹ä»¶ï¼‰ã€‚")]),t._v(" "),s("li",[t._v("ä¸šåŠ¡ä¾§æ‹¥å¡â†’ä¸‹è¡ŒæŒ‡ä»¤é™æµ/é˜Ÿåˆ—é•¿åº¦æŠ¥è­¦ã€‚")]),t._v(" "),s("li",[t._v("Redis/Kafka æŠ–åŠ¨â†’æœ¬åœ°ç¼“å­˜çŸ­æš‚å…œåº•ï¼ˆCaffeine + TTL 5~15sï¼‰ã€‚")])]),t._v(" "),s("h1",{attrs:{id:"æ‰©å®¹è·¯çº¿å›¾-åˆ†é˜¶æ®µ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#æ‰©å®¹è·¯çº¿å›¾-åˆ†é˜¶æ®µ"}},[t._v("#")]),t._v(" æ‰©å®¹è·¯çº¿å›¾ï¼ˆåˆ†é˜¶æ®µï¼‰")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("é˜¶æ®µAï¼ˆâ‰¤50ä¸‡è®¾å¤‡ï¼‰")]),t._v("ï¼š2~3 å°ç½‘å…³ + Redis ä¸»ä»æˆ–å°é›†ç¾¤ + 3 èŠ‚ç‚¹ Kafkaï¼›Nginx å•å±‚ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("é˜¶æ®µBï¼ˆâ‰¤500ä¸‡ï¼‰")]),t._v("ï¼šç½‘å…³æ°´å¹³æ‰©å±•è‡³ 10+ï¼›Redis Clusterï¼ˆ6"),s("s",[t._v("9 èŠ‚ç‚¹ï¼‰ï¼›Kafka 5")]),t._v("7 èŠ‚ç‚¹ï¼Œè·¨ AZï¼›NLB/SLB å¥åº·æ£€æŸ¥ã€‚")]),t._v(" "),s("li",[s("strong",[t._v("é˜¶æ®µCï¼ˆâ‰¥2000ä¸‡ï¼‰")]),t._v("ï¼šç½‘å…³åˆ†åŒºåŸŸæ± ï¼›è·¨åŒºåŸŸ Redis/Kafka åŒæ´»ï¼ˆå¼‚æ­¥å¤åˆ¶ï¼‰ï¼›Topic åˆ†åŸŸï¼›Trident/æµè®¡ç®—ä¾§åšå®æ—¶èšåˆé™å™ªï¼›è‡ªç ” L4/äº”å…ƒç»„è·¯ç”±ã€‚")])]),t._v(" "),s("h1",{attrs:{id:"æœ€å°å¯è¿è¡Œéª¨æ¶-å…³é”®ç‚¹"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#æœ€å°å¯è¿è¡Œéª¨æ¶-å…³é”®ç‚¹"}},[t._v("#")]),t._v(" æœ€å°å¯è¿è¡Œéª¨æ¶ï¼ˆå…³é”®ç‚¹ï¼‰")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("æ¨¡å—")]),t._v("ï¼š"),s("code",[t._v("gateway-boot")]),t._v("ï¼ˆSpring Bootï¼‰/ "),s("code",[t._v("gateway-core")]),t._v("ï¼ˆNettyï¼‰/ "),s("code",[t._v("gateway-protocol")]),t._v("ï¼ˆç¼–è§£ç ï¼‰/ "),s("code",[t._v("gateway-admin")]),t._v("ï¼ˆè¿ç»´é¢æ¿ï¼‰")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("æ¥å£")]),t._v("ï¼š")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("POST /internal/cmd/send")]),t._v("ï¼ˆä¸‹å‘ï¼‰")]),t._v(" "),s("li",[s("code",[t._v("GET /internal/channel/{deviceId}")]),t._v("ï¼ˆæŸ¥è¯¢åœ¨çº¿/æ‰€åœ¨ç½‘å…³ï¼‰")]),t._v(" "),s("li",[s("code",[t._v("/actuator/prometheus")]),t._v("ï¼ˆæŒ‡æ ‡ï¼‰")])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);