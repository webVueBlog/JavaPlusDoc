---
title: è¿ç»´æœåŠ¡å™¨6å¹´ç»éªŒ
author: å“ªå’
date: '2020-01-01'
---

> ç‚¹å‡»å‹˜è¯¯[issues](https://github.com/webVueBlog/JavaPlusDoc/issues)ï¼Œå“ªå’æ„Ÿè°¢å¤§å®¶çš„é˜…è¯»

<img align="right" width="100" src="https://cdn.jsdelivr.net/gh/YunYouJun/yun/images/yun-alpha-compressed.png">

## è¿ç»´æœåŠ¡å™¨6å¹´ç»éªŒ

## âœ… ä¸€ã€å¸¸ç”¨ Linux å‘½ä»¤åˆ†ç±»ï¼ˆé‡ç‚¹å¸¸è§ï¼‰ï¼š

### ğŸ”¹ ç³»ç»Ÿèµ„æºç›‘æ§

| å‘½ä»¤       | ä½œç”¨                          |
| -------- | --------------------------- |
| `top`    | å®æ—¶æŸ¥çœ‹ CPUã€å†…å­˜ã€è¿›ç¨‹å ç”¨ç­‰           |
| `htop`   | `top` çš„å¢å¼ºç‰ˆï¼Œå›¾å½¢åŒ–æ˜¾ç¤º            |
| `ps`     | æŸ¥çœ‹å½“å‰ç³»ç»Ÿè¿›ç¨‹çŠ¶æ€                  |
| `uptime` | æŸ¥çœ‹ç³»ç»Ÿè¿è¡Œæ—¶é•¿ä¸è´Ÿè½½æƒ…å†µ               |
| `vmstat` | æŸ¥çœ‹å†…å­˜ã€CPUã€IO ç­‰ç³»ç»Ÿæ€§èƒ½           |
| `iostat` | æŸ¥çœ‹ç£ç›˜ IO ä½¿ç”¨ç‡ï¼ˆæ¥è‡ª `sysstat` åŒ…ï¼‰ |
| `free`   | æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ                    |
| `sar`    | æ”¶é›†ç³»ç»Ÿæ€§èƒ½å†å²ï¼ˆéœ€å®‰è£… `sysstat`ï¼‰     |

### ğŸ”¹ ç½‘ç»œç›¸å…³

| å‘½ä»¤             | ä½œç”¨                        |
| -------------- | ------------------------- |
| `netstat`      | æŸ¥çœ‹ç½‘ç»œè¿æ¥ã€ç«¯å£ç›‘å¬ç­‰ï¼ˆå»ºè®®ç”¨ `ss` æ›¿ä»£ï¼‰ |
| `ss`           | æ›´å¿«æ›´å‡†ç¡®çš„æ›¿ä»£ `netstat`        |
| `ping`         | æµ‹è¯•ç½‘ç»œè¿é€šæ€§                   |
| `traceroute`   | è·¯ç”±è¿½è¸ª                      |
| `dig/nslookup` | åŸŸåè§£æå·¥å…·                    |
| `curl/wget`    | ç½‘ç»œè¯·æ±‚æµ‹è¯•                    |
| `tcpdump`      | æŠ“åŒ…å·¥å…·                      |
| `iftop`        | å®æ—¶ç½‘ç»œå¸¦å®½ç›‘æ§                  |

### ğŸ”¹ ç£ç›˜ä¸æ–‡ä»¶ç³»ç»Ÿ

| å‘½ä»¤             | ä½œç”¨          |
| -------------- | ----------- |
| `df`           | æŸ¥çœ‹ç£ç›˜æŒ‚è½½ä¸å‰©ä½™ç©ºé—´ |
| `du`           | æŸ¥çœ‹ç›®å½•/æ–‡ä»¶å ç”¨å¤§å° |
| `lsblk`        | æŸ¥çœ‹ç£ç›˜æŒ‚è½½ç»“æ„    |
| `mount/umount` | æŒ‚è½½/å¸è½½ç£ç›˜     |

### ğŸ”¹ æ–‡ä»¶ä¸ç³»ç»Ÿæ“ä½œ

| å‘½ä»¤                                  | ä½œç”¨       |
| ----------------------------------- | -------- |
| `ls`, `cd`, `cat`, `cp`, `mv`, `rm` | æ–‡ä»¶æ“ä½œ     |
| `find`, `grep`, `awk`, `sed`        | æŸ¥æ‰¾ä¸æ–‡æœ¬å¤„ç†  |
| `chmod`, `chown`                    | ä¿®æ”¹æƒé™ä¸æ‰€æœ‰è€… |
| `tar`, `zip`, `unzip`               | å‹ç¼©è§£å‹     |
| `systemctl`, `service`              | æœåŠ¡ç®¡ç†     |
| `journalctl`                        | æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—   |
| `crontab`                           | å®šæ—¶ä»»åŠ¡     |
| `kill`, `killall`, `xargs`          | æ€è¿›ç¨‹      |

* * *

## âœ… äºŒã€ä½ æåˆ°çš„å‘½ä»¤è¯¦è§£

| å‘½ä»¤               | ç”¨é€”è¯´æ˜                                       |
| ---------------- | ------------------------------------------ |
| `top`            | å®æ—¶æŸ¥çœ‹ CPUã€å†…å­˜å ç”¨ã€å„è¿›ç¨‹è¿è¡ŒçŠ¶æ€ï¼Œå¸¸ç”¨äºæ’æŸ¥ç³»ç»Ÿè´Ÿè½½é«˜çš„é—®é¢˜        |
| `ps aux`         | å¿«ç…§æ–¹å¼æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çŠ¶æ€ï¼Œå¯ç»“åˆ `grep` æ‰¾å…³é”®è¿›ç¨‹              |
| `netstat -tulnp` | æŸ¥çœ‹ç›‘å¬ç«¯å£ä¸ç»‘å®šæœåŠ¡ï¼ˆè¢« `ss` å–ä»£ï¼‰                     |
| `df -h`          | æŸ¥çœ‹å„æŒ‚è½½åˆ†åŒºçš„å‰©ä½™ç©ºé—´ã€ä½¿ç”¨ç‡ï¼Œåˆ¤æ–­ç£ç›˜æ˜¯å¦æ»¡                   |
| `du -sh *`       | æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹å„å­ç›®å½•/æ–‡ä»¶å¤§å°ï¼Œå®šä½â€œè°å æ»¡äº†ç£ç›˜â€                |
| `iostat -x 1`    | æŸ¥çœ‹ç£ç›˜è¯»å†™é€Ÿç‡ã€IO ç­‰å¾…æƒ…å†µï¼Œåˆ†æ IO ç“¶é¢ˆé—®é¢˜ï¼ˆéœ€å®‰è£… `sysstat`ï¼‰


## âœ… ä¸€ã€Linux è¿ç»´æ’æŸ¥å‘½ä»¤é€ŸæŸ¥è¡¨ï¼ˆåˆ†ç±» + åœºæ™¯ï¼‰

| åˆ†ç±»              | å‘½ä»¤ç¤ºä¾‹                                          | ä½¿ç”¨åœºæ™¯è¯´æ˜              |
| --------------- | --------------------------------------------- | ------------------- |
| ğŸ”§ **CPU/å†…å­˜æ’æŸ¥** | `top`, `htop`, `ps aux --sort=-%cpu`          | æŸ¥çœ‹é«˜è´Ÿè½½è¿›ç¨‹ã€å†…å­˜æ³„æ¼ã€è¿›ç¨‹å¼‚å¸¸   |
| ğŸ”§ **ç£ç›˜æ’æŸ¥**     | `df -h`, `du -sh *`, `lsof`, `ncdu`           | æŸ¥çœ‹ç£ç›˜æ˜¯å¦æ»¡ã€å“ªäº›æ–‡ä»¶å ç”¨æœ€å¤§ç©ºé—´  |
| ğŸ”§ **IO æ’æŸ¥**    | `iostat -x 1`, `iotop`, `vmstat 1`            | åˆ¤æ–­ç£ç›˜ IO æ˜¯å¦ç“¶é¢ˆã€IO ç­‰å¾…é«˜ |
| ğŸ”§ **ç½‘ç»œæ’æŸ¥**     | `netstat -tulnp`, `ss -lntp`, `lsof -i:ç«¯å£`    | æŸ¥çœ‹ç«¯å£ç›‘å¬æƒ…å†µã€ç½‘ç»œè¿æ¥çŠ¶æ€     |
| ğŸŒ **è¿é€šæ€§æµ‹è¯•**    | `ping`, `traceroute`, `curl`, `dig`, `telnet` | ç½‘ç»œæ˜¯å¦é€šï¼ŒDNS è§£ææ˜¯å¦æ­£å¸¸    |
| ğŸ“‚ **æ–‡ä»¶å®šä½**     | `find . -type f -name "*.log"`, `du -ah       | sort -rh`           |
| ğŸ” **æ—¥å¿—æŸ¥çœ‹**     | `tail -f /var/log/messages`, `journalctl -xe` | å®æ—¶æŸ¥çœ‹ç³»ç»Ÿ/æœåŠ¡æ—¥å¿—ï¼ŒæŸ¥å¯åŠ¨å¤±è´¥   |
| ğŸ” **æƒé™æ’æŸ¥**     | `ls -l`, `chmod`, `chown`                     | æ–‡ä»¶/ç›®å½•æƒé™é”™è¯¯å¯¼è‡´æ— æ³•è®¿é—®     |
| âš™ï¸ **è¿›ç¨‹æ§åˆ¶**     | `ps`, `kill`, `killall`, `xargs`              | æŸ¥æ‰¾å¹¶ç»ˆæ­¢å¼‚å¸¸è¿›ç¨‹           |
| ğŸ“† **å®šæ—¶ä»»åŠ¡**     | `crontab -l`, `systemctl list-timers`         | å®šæ—¶è„šæœ¬æœªè§¦å‘æˆ–é…ç½®é”™è¯¯

### CPU é£™é«˜æ’æŸ¥

> æœ‰ä¸€æ¬¡çº¿ä¸Šç³»ç»Ÿ CPU é£™åˆ° 100%ï¼Œæˆ‘ä½¿ç”¨ `top` æŸ¥çœ‹æ˜¯æŸä¸ª Java è¿›ç¨‹å æ»¡ CPUï¼Œå†ç»“åˆ `ps -ef` ç¡®è®¤ PIDï¼Œä¹‹åç”¨ `jstack` dump æ ˆåˆ†ææ˜¯æŸä¸ªçº¿ç¨‹æ­»å¾ªç¯ã€‚ä¿®å¤å CPU é™å›æ­£å¸¸ã€‚

### ç£ç›˜æ‰“æ»¡å¯¼è‡´æœåŠ¡æŒ‚æ‰

> æŸæ¬¡æœåŠ¡çªç„¶æŒ‚æ‰ï¼Œ`df -h` ä¸€çœ‹ `/var` åˆ†åŒº 100%ï¼Œ`du -sh *` é€çº§å®šä½ï¼Œå‘ç°æ˜¯æ—¥å¿—æ–‡ä»¶æ‰“æ»¡äº†ã€‚ç”¨ `logrotate` åŠ äº†å‹ç¼©ä¸æ¸…ç†ç­–ç•¥ï¼Œé¿å…å†æ¬¡å‘ç”Ÿã€‚

### æ•°æ®åº“è¿æ¥å¤±è´¥æ’æŸ¥

> åº”ç”¨è¿ä¸ä¸Š MySQLï¼Œå…ˆç”¨ `ping` ç¡®è®¤ç½‘ç»œé€šï¼Œå† `telnet host 3306` å‘ç°ç«¯å£ä¸é€šï¼Œç”¨ `ss -lntp` æŸ¥æœåŠ¡æœªç›‘å¬ï¼ŒåŸæ¥æ˜¯æ•°æ®åº“æœªå¯åŠ¨ï¼Œ`systemctl start mysql` åæ¢å¤æ­£å¸¸ã€‚

### Redis å¤šå®ä¾‹ç«¯å£å†²çª

> å¤š Redis å®ä¾‹å¯åŠ¨å¤±è´¥ï¼Œ`netstat -tulnp` æ˜¾ç¤ºç«¯å£å·²è¢«å ç”¨ï¼Œ`ps aux | grep redis` æŸ¥å‡ºæ˜¯è€è¿›ç¨‹æœªå…³é—­ï¼Œ`kill` åå†é‡å¯æˆåŠŸã€‚

### ç£ç›˜ IO æ€§èƒ½ç“¶é¢ˆ

> æŸæœåŠ¡å“åº”æ…¢ä½† CPU å ç”¨ä½ï¼Œç”¨ `iostat -x 1` æŸ¥çœ‹å‘ç°ç£ç›˜ `util` é•¿æ—¶é—´æ¥è¿‘ 100%ï¼Œæ’æŸ¥æ˜¯é¢‘ç¹å†™å…¥æ—¥å¿—å¯¼è‡´ IO æ‹¥å¡ï¼Œä¼˜åŒ–åæ—¥å¿—æŒ‰çº§åˆ«å†™å…¥ï¼Œå“åº”æ¢å¤ã€‚

| å‘½ä»¤             | é¢è¯•ä¸­ç®€æ´æè¿°           |
| -------------- | ----------------- |
| `top`          | å®æ—¶ç›‘æ§è¿›ç¨‹ CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µ |
| `ps aux`       | æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çš„é™æ€å¿«ç…§       |
| `netstat`/`ss` | æŸ¥çœ‹ç«¯å£ç›‘å¬ä¸ç½‘ç»œè¿æ¥       |
| `df -h`        | æŸ¥çœ‹ç£ç›˜åˆ†åŒºä½¿ç”¨æƒ…å†µ        |
| `du -sh *`     | æŸ¥çœ‹ç›®å½•å¤§å°ï¼Œæ’æŸ¥å¤§æ–‡ä»¶      |
| `iostat`       | æŸ¥çœ‹ç£ç›˜ IO ä½¿ç”¨ä¸ç“¶é¢ˆ     |
| `tail -f`      | å®æ—¶æŸ¥çœ‹æ—¥å¿—è¾“å‡º          |
| `ping`, `curl` | æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ä¸æœåŠ¡æ˜¯å¦åœ¨çº¿    |
| `kill -9`      | å¼ºåˆ¶ç»“æŸè¿›ç¨‹            |

## ä¸€é”®å®‰è£…å·¥å…·å»ºè®®ï¼ˆè¿ç»´å¿…å¤‡ï¼‰

```
# IO å’Œç½‘ç»œå·¥å…·åˆé›†ï¼ˆDebian/Ubuntuï¼‰
sudo apt install sysstat iotop iftop net-tools lsof

# CentOS/RHEL
sudo yum install sysstat iotop iftop net-tools lsof
```

| æ’æŸ¥åœºæ™¯             | ä½¿ç”¨å‘½ä»¤                                               | ç›®çš„                               | å®é™…ä½œç”¨ / ç»“æœ                            |                                    |                                  |
| ---------------- | -------------------------------------------------- | -------------------------------- | ------------------------------------ | ---------------------------------- | -------------------------------- |
| Java è¿›ç¨‹ CPU é£™å‡   | `top` <br> `ps aux --sort=-%cpu` <br> `jstack PID` | æ‰¾å‡ºé«˜ CPU å ç”¨è¿›ç¨‹ï¼Œå¹¶ç”¨ jstack æŠ“çº¿ç¨‹å †æ ˆ     | ç¡®è®¤æ˜¯æŸçº¿ç¨‹æ­»å¾ªç¯å¯¼è‡´ CPU å æ»¡ï¼Œåˆ†æå®šä½ä¸šåŠ¡é€»è¾‘é—®é¢˜        |                                    |                                  |
| ç£ç›˜å†™å…¥å¼‚å¸¸           | `df -h`                                            | æŸ¥çœ‹åˆ†åŒºæ˜¯å¦å·²æ»¡                         | `/var` åˆ†åŒº 100%ï¼ŒæœåŠ¡æ—¥å¿—æ— æ³•å†™å…¥ï¼Œå¯¼è‡´æ¥å£æŠ¥é”™       |                                    |                                  |
| å¤§æ–‡ä»¶å®šä½            | `du -sh *` <br> \`du -sh ./\*                      | sort -rh                         | head\`                               | å¿«é€Ÿå®šä½å¤§ç›®å½• / å¤§æ—¥å¿—æ–‡ä»¶                    | æ‰¾åˆ°æŸæ—¥å¿—æ–‡ä»¶è¶…è¿‡ 5Gï¼Œé…åˆ logrotate è®¾å®šåˆ‡å‰²ç­–ç•¥ |
| ç£ç›˜ IO æ€§èƒ½ç“¶é¢ˆ       | `iostat -x 1`                                      | æŸ¥çœ‹ IO åˆ©ç”¨ç‡ã€ç­‰å¾…æ—¶é—´                   | `util` é•¿æœŸ 90%+ï¼Œ`await` æ—¶é—´é«˜ï¼Œç¡®è®¤å†™å…¥ç“¶é¢ˆåœ¨ç£ç›˜ |                                    |                                  |
| ç«¯å£å†²çª / Redis æœªç›‘å¬ | `netstat -tulnp` <br> `ss -lntp`                   | æŸ¥çœ‹ç«¯å£å ç”¨æƒ…å†µ                         | å‘ç° Redis é…ç½®ç›‘å¬ç«¯å£æœªå¯åŠ¨æˆ–ç«¯å£è¢«å…¶ä»–è¿›ç¨‹å ç”¨         |                                    |                                  |
| è¿›ç¨‹æ˜¯å¦å­˜åœ¨ / å¤šå¼€      | \`ps aux                                           | grep redis`<br>`pgrep -f redis\` | ç¡®è®¤è¿›ç¨‹æ˜¯å¦å·²è¿è¡Œã€æ˜¯å¦é‡å¤å¯åŠ¨                     | é¿å…é‡å¤å¯åŠ¨ Redis æˆ– MySQL å®ä¾‹ï¼Œæˆ–ç¡®è®¤æ˜¯å¦æœªå¯åŠ¨æˆåŠŸ |                                  |

æœ‰æ¬¡çº¿ä¸Šç³»ç»Ÿå“åº”å˜æ…¢ï¼Œæˆ‘ç”¨ top æŸ¥åˆ° Java è¿›ç¨‹ CPU 99%ï¼Œç»“åˆ jstack æŠ“å–çº¿ç¨‹æ ˆï¼Œç¡®è®¤æŸæ­»å¾ªç¯é€»è¾‘å¯¼è‡´å ç”¨ï¼›ä¹Ÿé‡åˆ°ç£ç›˜å¼‚å¸¸ï¼Œdf å‘ç° /var åˆ†åŒºæ»¡äº†ï¼Œç”¨ du å¿«é€Ÿæ‰¾åˆ°æ˜¯æ—¥å¿—çˆ†é‡ï¼›å¦å¤–è¿˜ç”¨ iostat å®šä½ IO ç­‰å¾…é«˜ï¼Œç»“åˆæ—¥å¿—æ”¹å†™ç­–ç•¥ç¼“è§£äº†ç“¶é¢ˆã€‚

![img_14.png](./img_14.png)

![img_15.png](./img_15.png)

mongoï¼Œ

åœ¨ MongoDB ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šè¯´â€œåº“â€å’Œâ€œè¡¨â€ï¼Œè€Œæ˜¯ä½¿ç”¨ä»¥ä¸‹æœ¯è¯­ï¼š

| é€šç”¨æ•°æ®åº“æœ¯è¯­       | MongoDB ä¸­çš„æœ¯è¯­     |
| ------------- | ---------------- |
| æ•°æ®åº“ï¼ˆDatabaseï¼‰ | æ•°æ®åº“ï¼ˆDatabaseï¼‰ âœ…  |
| è¡¨ï¼ˆTableï¼‰      | é›†åˆï¼ˆCollectionï¼‰ âœ… |
| è¡Œï¼ˆRowï¼‰        | æ–‡æ¡£ï¼ˆDocumentï¼‰ âœ…   |
| åˆ—ï¼ˆColumnï¼‰     | å­—æ®µï¼ˆFieldï¼‰ âœ…      |

---

## âœ… MongoDB çš„åŸºæœ¬ç»“æ„ï¼š

```plaintext
MongoDB Server
 â””â”€â”€ Databaseï¼ˆæ•°æ®åº“ï¼‰
      â””â”€â”€ Collectionï¼ˆé›†åˆï¼Œç›¸å½“äºè¡¨ï¼‰
           â””â”€â”€ Documentï¼ˆæ–‡æ¡£ï¼Œç›¸å½“äºè¡Œï¼‰
                â””â”€â”€ Fieldï¼ˆå­—æ®µï¼Œç›¸å½“äºåˆ—ï¼‰
```

---

## âœ… ä¸¾ä¾‹è¯´æ˜

### åˆ›å»ºæ•°æ®åº“å’Œé›†åˆï¼ˆç›¸å½“äºâ€œå»ºåº“å»ºè¡¨â€ï¼‰ï¼š

```js
use mydb              // é€‰æ‹©æˆ–åˆ›å»ºæ•°æ®åº“

db.createCollection("users")  // åˆ›å»ºé›†åˆï¼Œç›¸å½“äºåˆ›å»ºè¡¨
```

---

### æ’å…¥æ–‡æ¡£ï¼ˆç›¸å½“äºæ’å…¥ä¸€è¡Œï¼‰ï¼š

```js
db.users.insertOne({
  name: "å¼ ä¸‰",
  age: 28,
  email: "zhangsan@example.com"
})
```

---

### æŸ¥è¯¢æ–‡æ¡£ï¼š

```js
db.users.find({ age: { $gt: 25 } })
```

---

## âœ… MongoDB ç‰¹ç‚¹ vs å…³ç³»å‹æ•°æ®åº“

| MongoDBï¼ˆæ–‡æ¡£å‹ï¼‰      | MySQL / PostgreSQLï¼ˆå…³ç³»å‹ï¼‰ |
| ----------------- | ----------------------- |
| æ— å›ºå®šè¡¨ç»“æ„            | è¡¨ç»“æ„éœ€æå‰å®šä¹‰å­—æ®µç±»å‹            |
| æ”¯æŒåµŒå¥—æ–‡æ¡£ã€æ•°ç»„å­—æ®µ       | ä¸æ”¯æŒåµŒå¥—å¯¹è±¡                 |
| çµæ´»å†™å…¥ï¼Œå­—æ®µå¯ä¸åŒ        | æ¯è¡Œå­—æ®µä¸€è‡´ï¼Œå¼ºç±»å‹çº¦æŸ            |
| ä½¿ç”¨ JSON/BSON å­˜å‚¨æ–‡æ¡£ | ä½¿ç”¨è¡Œåˆ—å¼å­˜å‚¨                 |

---

å¦‚æœä½ æƒ³æŸ¥çœ‹ Mongo å½“å‰æ‰€æœ‰åº“/è¡¨ï¼ˆé›†åˆï¼‰ï¼š

### æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“ï¼š

```js
show dbs
```

### æŸ¥çœ‹å½“å‰æ•°æ®åº“æ‰€æœ‰é›†åˆï¼ˆè¡¨ï¼‰ï¼š

```js
show collections
```

---

ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„ MongoDB ç¤ºä¾‹é¡¹ç›®ç»“æ„ï¼Œæ¨¡æ‹Ÿå¸¸è§çš„ **ç”¨æˆ·ï¼ˆusersï¼‰+ è®¢å•ï¼ˆordersï¼‰** æ¨¡å‹ï¼Œé€‚åˆå®é™…å¼€å‘ç”¨ä½œé¡¹ç›®åˆå§‹åŒ–ï¼š

---

## âœ… é¡¹ç›®ç»“æ„è¯´æ˜

* æ•°æ®åº“ï¼š`demo_app`
* é›†åˆï¼š

    * `users`ï¼šç”¨æˆ·ä¿¡æ¯
    * `orders`ï¼šç”¨æˆ·è®¢å•ï¼ˆåŒ…å«ç”¨æˆ· ID ä½œä¸ºå¤–é”®ï¼‰

---

## âœ… åˆå§‹åŒ–è„šæœ¬ï¼ˆMongo Shell è¯­æ³•ï¼‰

ä½ å¯ä»¥å¤åˆ¶ç²˜è´´åˆ° Mongo Shell / `mongosh` ä¸­è¿è¡Œï¼š

```js
// 1. åˆ‡æ¢æˆ–åˆ›å»ºæ•°æ®åº“
use demo_app

// 2. åˆ›å»º users é›†åˆå¹¶æ’å…¥ç¤ºä¾‹æ–‡æ¡£
db.createCollection("users")

db.users.insertMany([
  {
    _id: ObjectId(),
    username: "alice",
    email: "alice@example.com",
    phone: "1234567890",
    createdAt: new Date()
  },
  {
    _id: ObjectId(),
    username: "bob",
    email: "bob@example.com",
    phone: "9876543210",
    createdAt: new Date()
  }
])

// 3. åˆ›å»º orders é›†åˆå¹¶æ’å…¥ç¤ºä¾‹æ–‡æ¡£
db.createCollection("orders")

db.orders.insertMany([
  {
    _id: ObjectId(),
    userId: db.users.findOne({username: "alice"})._id,
    item: "iPhone 15",
    price: 7999,
    status: "PAID",
    createdAt: new Date()
  },
  {
    _id: ObjectId(),
    userId: db.users.findOne({username: "bob"})._id,
    item: "MacBook Air",
    price: 9999,
    status: "SHIPPED",
    createdAt: new Date()
  }
])

// 4. å»ºç«‹ç´¢å¼•ï¼ˆå¦‚ç”¨æˆ·é‚®ç®±å”¯ä¸€ï¼‰
db.users.createIndex({ email: 1 }, { unique: true })
db.orders.createIndex({ userId: 1 })
```

---

## âœ… æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥æ‰¾æŸç”¨æˆ·çš„è®¢å•ï¼š

```js
const user = db.users.findOne({ username: "alice" })
db.orders.find({ userId: user._id })
```

### æŸ¥è¯¢æ‰€æœ‰è®¢å•å¹¶å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯ï¼ˆå…³è”æŸ¥è¯¢ï¼‰ï¼š

```js
db.orders.aggregate([
  {
    $lookup: {
      from: "users",
      localField: "userId",
      foreignField: "_id",
      as: "userInfo"
    }
  },
  {
    $unwind: "$userInfo"
  },
  {
    $project: {
      item: 1,
      price: 1,
      status: 1,
      "userInfo.username": 1,
      "userInfo.email": 1
    }
  }
])
```

---

å¦‚æœ MongoDB ä¸­çš„è®¢å•é›†åˆï¼ˆordersï¼‰è¶…è¿‡ 1000 ä¸‡æ¡æ•°æ®ï¼Œæƒ³è¦ç»´æŒæŸ¥è¯¢æ€§èƒ½å’Œç³»ç»Ÿå¯æ‰©å±•æ€§ï¼Œå¿…é¡»ä»å¤šä¸ªç»´åº¦è¿›è¡Œä¼˜åŒ–ï¼š

---

## âœ… ä¸€ã€ç´¢å¼•ä¼˜åŒ–ï¼ˆæœ€å…³é”®ï¼‰

### 1ï¸âƒ£ å»ºç«‹**é«˜å‘½ä¸­ç‡çš„ç»„åˆç´¢å¼•**

ä¾‹å¦‚å¸¸è§æŸ¥è¯¢æ¡ä»¶ï¼š

```js
db.orders.find({ userId: xxx, status: "PAID" })
```

åº”å»ºç«‹ï¼š

```js
db.orders.createIndex({ userId: 1, status: 1 })
```

### 2ï¸âƒ£ å¸¸ç”¨å­—æ®µå¦‚ `createdAt` ç”¨äºåˆ†é¡µ/èŒƒå›´æŸ¥è¯¢ï¼š

```js
db.orders.find({ createdAt: { $gte: ISODate('2024-01-01') } }).sort({ createdAt: -1 }).limit(50)
```

åº”å»ºç«‹ï¼š

```js
db.orders.createIndex({ createdAt: -1 })
```

### 3ï¸âƒ£ æŸ¥è¯¢æ…¢æ—¶ï¼Œç”¨ `explain()` åˆ†æç´¢å¼•å‘½ä¸­ï¼š

```js
db.orders.find({ userId: xxx }).explain("executionStats")
```

---

## âœ… äºŒã€åˆ†é¡µä¼˜åŒ–ï¼ˆé¿å…æ·±åº¦ skipï¼‰

> **ä¸è¦ä½¿ç”¨ `skip` æ·±åˆ†é¡µ**ï¼Œæ€§èƒ½ä¼šæŒ‡æ•°ä¸‹é™ã€‚

### âŒ ä¸æ¨èï¼š

```js
db.orders.find().skip(1000000).limit(10)
```

### âœ… æ¨èï¼š

ä½¿ç”¨ `createdAt` æˆ– `_id` åšæ¸¸æ ‡åˆ†é¡µï¼ˆåŸºäºâ€œä¸Šæ¬¡æœ€åä¸€æ¡â€ï¼‰ï¼š

```js
db.orders.find({ createdAt: { $lt: ä¸Šä¸€é¡µæœ€åæ—¶é—´ } }).sort({ createdAt: -1 }).limit(10)
```

---

## âœ… ä¸‰ã€å†·çƒ­åˆ†ç¦» / åˆ†è¡¨ç­–ç•¥

### ğŸ”¹ 1ï¼‰**å†·çƒ­æ•°æ®æ‹†åˆ†**

* **æœ€è¿‘ 6 ä¸ªæœˆ**çš„æ•°æ®ä¿ç•™åœ¨ä¸» `orders` è¡¨ä¸­
* **å†å²è®¢å•å½’æ¡£**åˆ° `orders_history` è¡¨ï¼ˆæˆ–å¦ä¸€ä¸ªåº“ï¼‰

ä½¿ç”¨è„šæœ¬å®šæœŸå½’æ¡£ï¼š

```js
db.orders.aggregate([
  { $match: { createdAt: { $lt: ISODate('2024-01-01') } } },
  { $merge: { into: "orders_history" } }
])
```

ç„¶ååœ¨ `orders` ä¸­åˆ é™¤è€æ•°æ®ã€‚

---

### ğŸ”¹ 2ï¼‰**æŒ‰æ—¶é—´/ç”¨æˆ· ID åˆ†è¡¨**

* `orders_2024`, `orders_2023`
* `orders_user_0`, `orders_user_1`ï¼ˆæŒ‰ userId hashï¼‰

ç¼ºç‚¹ï¼šåº”ç”¨å±‚éœ€è¦åŠ¨æ€è·¯ç”±æŸ¥è¯¢é€»è¾‘ã€‚

---

## âœ… å››ã€å‹ç¼©ä¸æ•°æ®ç²¾ç®€

### ğŸ”¸ 1ï¼‰å­—æ®µå‹ç¼©ï¼ˆç²¾ç®€æ–‡æ¡£ç»“æ„ï¼‰

* é¿å…å†—ä½™åµŒå¥—å­—æ®µ
* å­—æ®µåç”¨çŸ­åï¼ˆå¦‚ `uid` æ›¿ä»£ `userId`ï¼‰

### ğŸ”¸ 2ï¼‰å…³é—­ä¸å¿…è¦å­—æ®µç´¢å¼•

* ä¸æŸ¥è¯¢çš„å­—æ®µä¸è¦å»ºç´¢å¼•ï¼ˆæµªè´¹å†™å…¥æ€§èƒ½ + ç©ºé—´ï¼‰

---

## âœ… äº”ã€å†™å…¥ä¼˜åŒ–

### æ‰¹é‡å†™å…¥ï¼š

```js
db.orders.insertMany([...])
```

### åˆç†è®¾ç½® `_id`

ä½¿ç”¨è‡ªå®šä¹‰é¡ºåºç”Ÿæˆ `_id`ï¼Œå¯é¿å…é»˜è®¤ ObjectId å¸¦æ¥çš„åˆ†å¸ƒå†™å…¥æ”¾å¤§é—®é¢˜ï¼ˆä½†é€šå¸¸å½±å“ä¸å¤§ï¼‰ã€‚

---

## âœ… å…­ã€ç›‘æ§ä¸æ€§èƒ½åˆ†æå·¥å…·

* `db.orders.stats()` æŸ¥çœ‹é›†åˆå¤§å°
* `db.orders.totalIndexSize()` æŸ¥çœ‹ç´¢å¼•ç©ºé—´
* `mongotop`, `mongostat`, `Atlas Profiler` å®æ—¶ç›‘æ§
* `explain()` å®šä½æ…¢æŸ¥è¯¢

---

## âœ… ä¸ƒã€æ¶æ„å±‚æ‰©å±•ï¼ˆæç«¯é«˜å¹¶å‘ï¼‰

å¦‚æœæ•°æ®é‡å’Œå¹¶å‘å†æå‡ï¼Œå¯è€ƒè™‘ï¼š

* MongoDB åˆ†ç‰‡é›†ç¾¤ï¼ˆShardingï¼‰
* çƒ­æ•°æ®ä½¿ç”¨ Redis ç¼“å­˜
* å†å²æ•°æ®å½’æ¡£åˆ° ElasticSearch ç”¨äºæ£€ç´¢

---

## âœ… æœ€ç»ˆå»ºè®®å°ç»“

| ä¼˜åŒ–æ–¹å‘ | å»ºè®®                      |
| ---- | ----------------------- |
| ç´¢å¼•   | ç»„åˆç´¢å¼• + åˆ›å»ºæ—¶é—´ç´¢å¼•           |
| åˆ†é¡µ   | æ¸¸æ ‡åˆ†é¡µä»£æ›¿ skip             |
| åˆ†è¡¨   | çƒ­/å†·æ•°æ®åˆ†ç¦»æˆ–æŒ‰æ—¶é—´åˆ†è¡¨           |
| ç»“æ„ä¼˜åŒ– | å­—æ®µç²¾ç®€ã€å»å†—ä½™ã€æ–‡æ¡£å¤§å°æ§åˆ¶         |
| æŸ¥è¯¢ä¼˜åŒ– | ä½¿ç”¨ explain åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ     |
| æ‰©å±•æ–¹æ¡ˆ | æ•°æ®åˆ†ç‰‡ + Redis ç¼“å­˜ + ES æ£€ç´¢ |

---

ä½ æåˆ°çš„ä¸‰ç§æ¶æ„ä¼˜åŒ–ç­–ç•¥æ˜¯æ„å»º**é«˜å¹¶å‘ + å¤§æ•°æ®é‡ç³»ç»Ÿ**çš„æ ¸å¿ƒæ–¹å¼ï¼Œé€‚ç”¨äºè®¢å•ç±»ç³»ç»Ÿã€æ—¥å¿—ç³»ç»Ÿã€äº¤æ˜“ç³»ç»Ÿç­‰åœºæ™¯ã€‚ä¸‹é¢æ˜¯å¯¹ï¼š

* **MongoDB åˆ†ç‰‡é›†ç¾¤ï¼ˆShardingï¼‰**
* **Redis ç¼“å­˜çƒ­æ•°æ®**
* **ElasticSearch å½’æ¡£å†å²æ•°æ®**

ä¸‰è€…çš„ **ä½œç”¨ã€åŸç†ã€å®ç°æ–¹å¼** çš„è¯¦è§£ï¼š

---

## âœ… ä¸€ã€MongoDB åˆ†ç‰‡é›†ç¾¤ï¼ˆShardingï¼‰

### ğŸ“Œ ä½œç”¨ï¼š

å°† **æµ·é‡æ•°æ®æ°´å¹³æ‹†åˆ†** åˆ°å¤šä¸ªåˆ†ç‰‡èŠ‚ç‚¹ï¼ˆshardï¼‰ä¸Šï¼Œå®ç° **è¯»å†™è´Ÿè½½å‡è¡¡ + æ— é™æ‰©å±•å®¹é‡**ã€‚

### ğŸ§  åŸç†ï¼š

* æŒ‰ç…§ `shard key` å°†æ•°æ®åˆ†å‘åˆ°ä¸åŒåˆ†ç‰‡
* æŸ¥è¯¢ç”± Mongosï¼ˆè·¯ç”±å™¨ï¼‰æ ¹æ® key å®šå‘åˆ°æ­£ç¡® shard

### ğŸ“¦ æ¶æ„ç»„æˆï¼š

```
å®¢æˆ·ç«¯
   â”‚
 â”Œâ”€â–¼â”€â”
 â”‚mongos è·¯ç”±å™¨â”‚â† å¤šä¸ªï¼Œå¯æ¨ªå‘æ‰©å±•
 â””â”€â–²â”€â”˜
   â”‚
 â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚     Config Servers     â”‚ â† é…ç½®å…ƒæ•°æ®ï¼Œ3 ä¸ªæˆ–ä»¥ä¸Š
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚    Shard1    â”‚     Shard2   â”‚  ... å¯æ‰©å±•
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”§ ç¤ºä¾‹é…ç½®æ­¥éª¤ï¼ˆç®€ç•¥ï¼‰ï¼š

1. é…ç½®åˆ†ç‰‡é›†ç¾¤ï¼š`mongod --shardsvr`
2. é…ç½® routerï¼š`mongos --configdb`
3. æ·»åŠ åˆ†ç‰‡ï¼š

```js
sh.addShard("shard1/host1:27017")
sh.addShard("shard2/host2:27017")
```

4. å¯ç”¨åˆ†ç‰‡ï¼š

```js
sh.enableSharding("demo_app")
sh.shardCollection("demo_app.orders", { userId: 1 }) // æˆ– createdAt
```

---

## âœ… äºŒã€Redis ç¼“å­˜çƒ­æ•°æ®ï¼ˆè¯»å¤šå†™å°‘ï¼‰

### ğŸ“Œ ä½œç”¨ï¼š

å°†**é«˜é¢‘è¯»çš„æ•°æ®**ï¼ˆå¦‚ç”¨æˆ·æœ€æ–°è®¢å•ã€è®¢å•çŠ¶æ€ï¼‰ç¼“å­˜åˆ° Redisï¼Œé¿å… MongoDB é¢‘ç¹æŸ¥è¯¢ã€‚

### ğŸ§  é€‚åˆæ•°æ®ï¼š

* æœ€è¿‘ 24 å°æ—¶çš„è®¢å•çŠ¶æ€
* ç”¨æˆ·å¸¸è®¿é—®çš„è®¢å•è¯¦æƒ…
* æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆé˜²æ­¢é‡å¤åˆ†é¡µï¼‰

### ğŸ› ï¸ ç¼“å­˜ç­–ç•¥å»ºè®®ï¼š

| é¡¹ç›®     | è¯´æ˜                                     |
| ------ | -------------------------------------- |
| Key è®¾è®¡ | `order:{orderId}` æˆ– `user:{id}:orders` |
| å¤±æ•ˆç­–ç•¥   | çƒ­ç‚¹æ•°æ®è®¾å®š 1hï½12h TTL æˆ– LRU                |
| ä¸€è‡´æ€§ç­–ç•¥  | å†™å…¥ Mongo åç«‹å³å†™å…¥ Redisï¼Œæˆ–å»¶è¿Ÿä¸€è‡´æ€§åŒæ­¥          |
| ä½¿ç”¨æ–¹å¼   | å…ˆæŸ¥ Redisï¼Œæ— æ•°æ®å†æŸ¥ Mongo                   |

```js
// ä¼ªä»£ç 
let data = redis.get(`order:${orderId}`)
if (!data) {
  data = db.orders.findOne({ _id: orderId })
  redis.set(`order:${orderId}`, JSON.stringify(data), "EX", 3600)
}
```

---

## âœ… ä¸‰ã€ElasticSearch å½’æ¡£å†å²æ•°æ®ï¼ˆå…¨æ–‡æ£€ç´¢ + èšåˆï¼‰

### ğŸ“Œ ä½œç”¨ï¼š

å°† **è€è®¢å•æ•°æ®ï¼ˆå¦‚ 6 ä¸ªæœˆå‰ï¼‰** å¯¼å…¥åˆ° ESï¼Œæ”¯æŒå¿«é€Ÿæœç´¢ã€åˆ†é¡µã€å¤æ‚ç»Ÿè®¡åˆ†æï¼Œè€Œä¸å½±å“ Mongo çš„è¯»å†™å‹åŠ›ã€‚

### ğŸ§  ä¸ºä»€ä¹ˆç”¨ ESï¼š

* å¿«é€Ÿå…¨æ–‡æœç´¢ï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰
* æ”¯æŒå¤æ‚èšåˆæŸ¥è¯¢ï¼ˆå¦‚è®¢å•é‡‘é¢ç»Ÿè®¡ï¼‰
* è‡ªå¸¦å€’æ’ç´¢å¼•ï¼Œé€‚åˆæµ·é‡æ•°æ®

### ğŸ”§ å®ç°æ–¹å¼ï¼š

1. ä½¿ç”¨åŒæ­¥å·¥å…·å¯¼å…¥æ•°æ®ï¼Œå¦‚ï¼š

  * `mongo-connector`ï¼ˆå·²è¿‡æ—¶ï¼‰
  * è‡ªå»ºåŒæ­¥ç¨‹åº
  * [Logstash + MongoDB input plugin](https://www.elastic.co/guide/en/logstash/current/plugins-inputs-mongodb.html)

2. ç¤ºä¾‹æ•°æ®ç»“æ„ï¼š

```json
{
  "orderId": "abc123",
  "userId": "u001",
  "item": "MacBook Air",
  "status": "PAID",
  "createdAt": "2023-05-01T12:00:00"
}
```

3. æŸ¥è¯¢ç¤ºä¾‹ï¼ˆDSLï¼‰ï¼š

```json
{
  "query": {
    "bool": {
      "must": [
        { "match": { "status": "PAID" } },
        { "range": { "createdAt": { "lt": "2024-01-01" } } }
      ]
    }
  }
}
```

---

## âœ… æ¶æ„ååŒä½¿ç”¨å»ºè®®ï¼ˆç”Ÿäº§å®è·µï¼‰

| åœºæ™¯            | ä½¿ç”¨æ–¹æ¡ˆ                |
| ------------- | ------------------- |
| å®æ—¶å†™å…¥ã€è¯»å†™åˆ†å¸ƒå¼æ‰©å±•  | MongoDB åˆ†ç‰‡é›†ç¾¤        |
| é«˜é¢‘è®¿é—®è®¢å•çŠ¶æ€æˆ–æœ€è¿‘åˆ—è¡¨ | Redis ç¼“å­˜            |
| å†å²è®¢å•æ¨¡ç³Šæœç´¢ã€ç»Ÿè®¡åˆ†æ | ElasticSearch å­˜æ¡£+æŸ¥è¯¢ |

---

## âœ… ä¸€å¼ å›¾æ€»ç»“ï¼š

```
                +------------------------+
                |      å‰ç«¯ / æ¥å£       |
                +------------------------+
                           |
              +------------+------------+
              |                         |
     +--------â–¼--------+      +--------â–¼--------+
     |    Redis ç¼“å­˜    |      |     MongoDB      |
     | çƒ­ç‚¹è®¢å•/çŠ¶æ€    |      |   åˆ†ç‰‡è®¢å•ä¸»åº“   |
     +--------+--------+      +--------+--------+
              |                         |
     +--------â–¼--------+      +--------â–¼--------+
     |    ElasticSearch |      |   Mongo Archive |
     | å†å²è®¢å•æ£€ç´¢/ç»Ÿè®¡ |      | å†å²æ•°æ®å†·å­˜å‚¨  |
     +------------------+      +------------------+
```

---

ä½ æƒ³è¦çš„ Java å®ç°æ–¹æ¡ˆï¼Œå…¶ç›®æ ‡æ˜¯ï¼š

> æ„å»ºä¸€ä¸ªç³»ç»Ÿï¼šä½¿ç”¨ MongoDB åˆ†ç‰‡é›†ç¾¤ä¿å­˜è®¢å•æ•°æ®ï¼ŒRedis ç¼“å­˜çƒ­æ•°æ®ï¼ŒElasticsearch å­˜å‚¨å†å²æ•°æ®ï¼Œå¹¶é€šè¿‡ Java æœåŠ¡è¯»å†™åè°ƒã€‚

---

## âœ… ç›®å½•ç»“æ„æ¦‚è§ˆ

æˆ‘ä»¬å°†ä»ä»¥ä¸‹ 3 ä¸ªæ ¸å¿ƒç‚¹å®ç°ï¼š

| ç›®æ ‡æ¨¡å—                | æŠ€æœ¯æ–¹æ¡ˆ                                                   |
| ------------------- | ------------------------------------------------------ |
| ğŸ”¹ MongoDB åˆ†ç‰‡è¯»å†™     | ä½¿ç”¨ `MongoTemplate` æˆ– `Spring Data Mongo`               |
| ğŸ”¹ Redis ç¼“å­˜åŠ é€Ÿ       | ä½¿ç”¨ `Spring Cache` æˆ– `Redisson`                         |
| ğŸ”¹ ElasticSearch æŸ¥è¯¢ | ä½¿ç”¨ `Spring Data Elasticsearch` æˆ– `RestHighLevelClient` |

---

## âœ… ä¸€ã€MongoDB åˆ†ç‰‡é›†ç¾¤è¿æ¥ä¸æ“ä½œ

### ğŸ“¦ Maven ä¾èµ–ï¼ˆMongoDBï¼‰ï¼š

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>
```

### âš™ï¸ application.yml é…ç½®è¿æ¥ï¼ˆå¯å¸¦å‰¯æœ¬é›†ï¼‰

```yaml
spring:
  data:
    mongodb:
      uri: mongodb://shard1:27017,shard2:27017,shard3:27017/demo_app?replicaSet=rs0
```

### âœ… ä½¿ç”¨ `MongoTemplate` æ“ä½œï¼š

```java
@Service
public class OrderService {

    @Autowired
    private MongoTemplate mongoTemplate;

    public void saveOrder(Order order) {
        mongoTemplate.save(order, "orders");
    }

    public List<Order> findOrdersByUser(String userId) {
        Query query = new Query(Criteria.where("userId").is(userId));
        return mongoTemplate.find(query, Order.class, "orders");
    }
}
```

---

## âœ… äºŒã€Redis ç¼“å­˜çƒ­ç‚¹è®¢å•æ•°æ®

### ğŸ“¦ Maven ä¾èµ–ï¼š

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

### âš™ï¸ application.yml é…ç½®ï¼š

```yaml
spring:
  redis:
    host: localhost
    port: 6379
```

### âœ… ä½¿ç”¨ RedisTemplateï¼š

```java
@Autowired
private StringRedisTemplate redisTemplate;

public Order getOrderWithCache(String orderId) {
    String cacheKey = "order:" + orderId;
    String cached = redisTemplate.opsForValue().get(cacheKey);
    if (cached != null) {
        return JSON.parseObject(cached, Order.class);
    }

    // æŸ¥è¯¢ MongoDB
    Order order = mongoTemplate.findById(orderId, Order.class);
    if (order != null) {
        redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(order), Duration.ofHours(1));
    }
    return order;
}
```

---

## âœ… ä¸‰ã€Elasticsearch æŸ¥è¯¢å†å²è®¢å•

### ğŸ“¦ Maven ä¾èµ–ï¼ˆSpring Boot 3 æ¨èç”¨æ–°å®¢æˆ·ç«¯ï¼‰ï¼š

```xml
<dependency>
  <groupId>co.elastic.clients</groupId>
  <artifactId>elasticsearch-java</artifactId>
  <version>8.11.3</version>
</dependency>
```

### âœ… åˆå§‹åŒ– ES å®¢æˆ·ç«¯ï¼š

```java
@Configuration
public class EsConfig {
    @Bean
    public ElasticsearchClient elasticsearchClient() {
        RestClient restClient = RestClient.builder(
            new HttpHost("localhost", 9200)).build();

        ElasticsearchTransport transport = new RestClientTransport(
            restClient, new JacksonJsonpMapper());

        return new ElasticsearchClient(transport);
    }
}
```

### âœ… æŸ¥è¯¢å†å²è®¢å•ï¼ˆcreatedAt < æŸæ—¶é—´ï¼‰ï¼š

```java
public List<Order> searchOldOrders(String userId) throws IOException {
    LocalDateTime sixMonthsAgo = LocalDateTime.now().minusMonths(6);
    ElasticsearchClient client = elasticsearchClient;

    SearchResponse<Order> response = client.search(s -> s
        .index("orders")
        .query(q -> q
            .bool(b -> b
                .must(m -> m.term(t -> t.field("userId").value(userId)))
                .must(m -> m.range(r -> r.field("createdAt").lt(JsonData.of(sixMonthsAgo.toString()))))
            )
        ), Order.class);

    return response.hits().hits().stream().map(Hit::source).toList();
}
```

---

## âœ… å››ã€è°ƒåº¦å½’æ¡£ï¼šMongo â†’ ElasticSearch

ä½ å¯ä»¥åœ¨å®šæ—¶ä»»åŠ¡ä¸­ï¼Œå®šæœŸå°† Mongo ä¸­çš„è€è®¢å•è¿ç§»åˆ° ESï¼š

```java
@Scheduled(cron = "0 0 2 * * ?")
public void archiveOldOrdersToES() {
    Query query = new Query(Criteria.where("createdAt").lt(LocalDateTime.now().minusMonths(6)));
    List<Order> oldOrders = mongoTemplate.find(query, Order.class, "orders");

    oldOrders.forEach(order -> {
        try {
            elasticsearchClient.index(i -> i
                .index("orders")
                .id(order.getId())
                .document(order));
        } catch (Exception e) {
            log.error("å½’æ¡£å¤±è´¥ï¼š{}", e.getMessage());
        }
    });
}
```

---

## âœ… äº”ã€æ•´ä½“æ¶æ„å›é¡¾

```plaintext
               +---------------------+
               |   Java SpringBoot   |
               +---------------------+
                   |     |       |
     Redis (ç¼“å­˜)  |     |       |  MongoDB (åˆ†ç‰‡ä¸»åº“)
         çƒ­ç‚¹è®¢å•  |     |       |  å®æ—¶è¯»å†™
                   â–¼     â–¼       â–¼
               Elasticsearch       ï¼ˆå½’æ¡£ï¼‰
             6æœˆå‰è€è®¢å•æœç´¢ã€ç»Ÿè®¡åˆ†æ
```

---


ä½¿ç”¨ MongoDB åˆ†ç‰‡é›†ç¾¤ä¿å­˜è®¢å•æ•°æ®ï¼ŒRedis ç¼“å­˜çƒ­æ•°æ®ï¼ŒElasticsearch å­˜å‚¨å†å²æ•°æ®ï¼Œå¹¶é€šè¿‡ Java æœåŠ¡è¯»å†™åè°ƒã€‚










